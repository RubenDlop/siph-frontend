============================
CRITICAL FILES (no styles)
Date: 02/11/2026 11:22:43
============================


============================================================
FILE: C:\Users\rdari\Downloads\siph-frontend-master\siph-frontend-master\src\app\core\guards\auth.guard.ts
============================================================
import { inject } from '@angular/core';
import { CanActivateFn, Router } from '@angular/router';
import { StorageService } from '../services/storage.service';

export const authGuard: CanActivateFn = (route, state) => {
  const storage = inject(StorageService);
  const router = inject(Router);

  const token = storage.getToken();
  if (token) return true;

  router.navigate(['/auth/login'], { queryParams: { redirect: state.url } });
  return false;
};


============================================================
FILE: C:\Users\rdari\Downloads\siph-frontend-master\siph-frontend-master\src\app\core\guards\role.guard.ts
============================================================
import { inject } from '@angular/core';
import { CanActivateFn, Router } from '@angular/router';
import { StorageService } from '../services/storage.service';

export const roleGuard: CanActivateFn = (route) => {
  const storage = inject(StorageService);
  const router = inject(Router);

  const allowed: string[] = (route.data?.['roles'] || []).map((x: string) => x.toUpperCase());
  const role = (storage.getUser()?.role || 'USER').toUpperCase();

  if (!allowed.length || allowed.includes(role)) return true;

  router.navigate(['/dashboard']);
  return false;
};


============================================================
FILE: C:\Users\rdari\Downloads\siph-frontend-master\siph-frontend-master\src\app\core\interceptors\auth.interceptor.ts
============================================================
// src/app/core/interceptors/auth.interceptor.ts
import { Injectable } from '@angular/core';
import {
  HttpEvent,
  HttpHandler,
  HttpInterceptor,
  HttpRequest,
} from '@angular/common/http';
import { Observable } from 'rxjs';
import { StorageService } from '../services/storage.service';

@Injectable()
export class AuthInterceptor implements HttpInterceptor {
  constructor(private storage: StorageService) {}

  intercept(req: HttpRequest<any>, next: HttpHandler): Observable<HttpEvent<any>> {
    const token = this.storage.getToken(); // siph_token
    if (!token) return next.handle(req);

    // Si ya trae Authorization, no lo sobreescribas
    if (req.headers.has('Authorization')) return next.handle(req);

    return next.handle(
      req.clone({
        setHeaders: { Authorization: `Bearer ${token}` }, // âœ… espacio correcto
      })
    );
  }
}


============================================================
FILE: C:\Users\rdari\Downloads\siph-frontend-master\siph-frontend-master\src\app\core\models\auth-response.ts
============================================================
export interface AuthResponse {
}


============================================================
FILE: C:\Users\rdari\Downloads\siph-frontend-master\siph-frontend-master\src\app\core\models\review.ts
============================================================
export interface Review {
}


============================================================
FILE: C:\Users\rdari\Downloads\siph-frontend-master\siph-frontend-master\src\app\core\models\service-request.ts
============================================================
export interface ServiceRequest {
}


============================================================
FILE: C:\Users\rdari\Downloads\siph-frontend-master\siph-frontend-master\src\app\core\models\user.ts
============================================================
export interface User {
}


============================================================
FILE: C:\Users\rdari\Downloads\siph-frontend-master\siph-frontend-master\src\app\core\models\worker.ts
============================================================
export interface Worker {
}


============================================================
FILE: C:\Users\rdari\Downloads\siph-frontend-master\siph-frontend-master\src\app\core\services\api.service.ts
============================================================
import { Injectable } from '@angular/core';

@Injectable({
  providedIn: 'root'
})
export class ApiService {

  constructor() { }
}


============================================================
FILE: C:\Users\rdari\Downloads\siph-frontend-master\siph-frontend-master\src\app\core\services\auth.service.ts
============================================================
import { Injectable } from '@angular/core';
import { HttpClient } from '@angular/common/http';
import { Observable, tap } from 'rxjs';
import { environment } from '../../../environments/environment';
import { StorageService, AuthUser } from './storage.service';

export interface RegisterPayload {
  first_name: string;
  last_name: string;
  email: string;
  password: string;
}

export interface LoginPayload {
  email: string;
  password: string;
}

export interface GoogleLoginPayload {
  credential: string;
}

export interface AuthResponse {
  access_token: string;
  token_type?: string;
}

@Injectable({ providedIn: 'root' })
export class AuthService {
  private readonly baseUrl = environment.apiUrl || 'http://localhost:8000';

  constructor(private http: HttpClient, private storage: StorageService) {}

  register(payload: RegisterPayload): Observable<AuthResponse> {
    return this.http
      .post<AuthResponse>(`${this.baseUrl}/auth/register`, payload)
      .pipe(
        tap((res) => {
          this.storage.saveToken(res.access_token);
          // Carga user para navbar/roles
          this.me().subscribe({ next: () => {}, error: () => {} });
        })
      );
  }

  login(payload: LoginPayload): Observable<AuthResponse> {
    return this.http.post<AuthResponse>(`${this.baseUrl}/auth/login`, payload).pipe(
      tap((res) => {
        this.storage.saveToken(res.access_token);
        this.me().subscribe({ next: () => {}, error: () => {} });
      })
    );
  }

  loginWithGoogle(credential: string): Observable<AuthResponse> {
    const payload: GoogleLoginPayload = { credential };
    return this.http
      .post<AuthResponse>(`${this.baseUrl}/auth/google`, payload)
      .pipe(
        tap((res) => {
          this.storage.saveToken(res.access_token);
          this.me().subscribe({ next: () => {}, error: () => {} });
        })
      );
  }

  me(): Observable<AuthUser> {
    return this.http.get<AuthUser>(`${this.baseUrl}/auth/me`).pipe(
      tap((user) => {
        this.storage.saveUser(user);
      })
    );
  }

  logout(): void {
    this.storage.clearToken();
  }
}


============================================================
FILE: C:\Users\rdari\Downloads\siph-frontend-master\siph-frontend-master\src\app\core\services\requests.service.ts
============================================================
import { Injectable } from '@angular/core';

@Injectable({
  providedIn: 'root'
})
export class RequestsService {

  constructor() { }
}


============================================================
FILE: C:\Users\rdari\Downloads\siph-frontend-master\siph-frontend-master\src\app\core\services\reviews.service.ts
============================================================
import { Injectable } from '@angular/core';

@Injectable({
  providedIn: 'root'
})
export class ReviewsService {

  constructor() { }
}


============================================================
FILE: C:\Users\rdari\Downloads\siph-frontend-master\siph-frontend-master\src\app\core\services\storage.service.ts
============================================================
import { Injectable } from '@angular/core';

export interface AuthUser {
  id: number;
  first_name: string;
  last_name: string;
  email: string;
  role: string;
  is_active: boolean;
  created_at?: string | null;
}

@Injectable({ providedIn: 'root' })
export class StorageService {
  private tokenKey = 'siph_token';
  private userKey = 'siph_user';

  // TOKEN
  saveToken(token: string) {
    localStorage.setItem(this.tokenKey, token);
  }

  getToken() {
    return localStorage.getItem(this.tokenKey);
  }

  removeToken() {
    localStorage.removeItem(this.tokenKey);
  }

  // USER
  saveUser(user: AuthUser) {
    localStorage.setItem(this.userKey, JSON.stringify(user));
  }

  getUser(): AuthUser | null {
    const raw = localStorage.getItem(this.userKey);
    if (!raw) return null;
    try {
      return JSON.parse(raw) as AuthUser;
    } catch {
      return null;
    }
  }

  removeUser() {
    localStorage.removeItem(this.userKey);
  }

  // HELPERS
  isLoggedIn(): boolean {
    return !!this.getToken();
  }

  clearToken() {
    this.removeToken();
    this.removeUser();
  }
}


============================================================
FILE: C:\Users\rdari\Downloads\siph-frontend-master\siph-frontend-master\src\app\core\services\tech-verification.service.ts
============================================================
import { Injectable, inject } from '@angular/core';
import { HttpClient } from '@angular/common/http';
import { environment } from '../../../environments/environment';

export type TechLevel = 'BASIC' | 'TRUST' | 'PRO' | 'PAY';
export type TechStatus = 'PENDING' | 'IN_REVIEW' | 'VERIFIED' | 'REJECTED';

export type DocType =
  | 'ID_PHOTO'
  | 'POLICE_CERT'
  | 'PROCURADURIA_CERT'
  | 'RNMC_CERT'
  | 'REFERENCES'
  | 'PRO_LICENSE'
  | 'STUDY_CERT'
  | 'HEIGHTS_CERT'
  | 'GAS_CERT'
  | 'RUT'
  | 'BANK_CERT';

export interface TechVerificationMe {
  techId: number;
  currentLevel: TechLevel;
  status: TechStatus;
  verifiedAt?: string | null;
  expiresAt?: string | null;
  reason?: string | null;
}

@Injectable({ providedIn: 'root' })
export class TechVerificationService {
  private http = inject(HttpClient);
  private base = environment.apiUrl;

  me() {
    return this.http.get<TechVerificationMe>(`${this.base}/tech/verification/me`);
  }

  upsertProfile(payload: any) {
    return this.http.put<{ ok: true }>(`${this.base}/tech/verification/profile`, payload);
  }

  uploadDoc(args: { docType: DocType; file: File; consent: boolean; extra?: any }) {
    const fd = new FormData();
    fd.append('docType', args.docType);
    fd.append('consent', String(args.consent));
    fd.append('file', args.file);
    // extra (opcional)
    if (args.extra) fd.append('extra', JSON.stringify(args.extra));
    return this.http.post<{ ok: true }>(`${this.base}/tech/verification/documents`, fd);
  }

  submit(payload: { targetLevel: TechLevel; extra?: any }) {
    return this.http.post<TechVerificationMe>(`${this.base}/tech/verification/submit`, payload);
  }
}


============================================================
FILE: C:\Users\rdari\Downloads\siph-frontend-master\siph-frontend-master\src\app\core\services\worker-application.service.ts
============================================================
import { Injectable } from '@angular/core';
import { HttpClient, HttpParams } from '@angular/common/http';
import { Observable } from 'rxjs';
import { environment } from '../../../environments/environment';
import { AuthUser } from './storage.service';

export type WorkerAppStatus = 'PENDING' | 'APPROVED' | 'REJECTED';

export interface WorkerApplicationCreate {
  phone?: string;
  city?: string;
  specialty: string;
  bio: string;
  years_experience?: number;
}

export interface WorkerApplication {
  id: number;
  status: WorkerAppStatus;
  phone?: string;
  city?: string;
  specialty?: string;
  bio?: string;
  years_experience?: number;
  admin_notes?: string | null;
  reviewed_by?: number | null;
  reviewed_at?: string | null;
  created_at: string;
  updated_at: string;
}

export interface AdminWorkerApplication extends WorkerApplication {
  user: AuthUser;
}

export interface WorkerDecisionPayload {
  decision: 'APPROVE' | 'REJECT';
  admin_notes?: string;
}

@Injectable({ providedIn: 'root' })
export class WorkerApplicationService {
  private readonly baseUrl = environment.apiUrl || 'http://localhost:8000';

  constructor(private http: HttpClient) {}

  apply(payload: WorkerApplicationCreate): Observable<WorkerApplication> {
    return this.http.post<WorkerApplication>(`${this.baseUrl}/worker-applications`, payload);
  }

  myApplication(): Observable<WorkerApplication> {
    return this.http.get<WorkerApplication>(`${this.baseUrl}/worker-applications/me`);
  }

  adminList(status?: WorkerAppStatus): Observable<AdminWorkerApplication[]> {
    let params = new HttpParams();
    if (status) params = params.set('status_filter', status);
    return this.http.get<AdminWorkerApplication[]>(`${this.baseUrl}/admin/worker-applications`, { params });
  }

  adminDecide(appId: number, payload: WorkerDecisionPayload): Observable<AdminWorkerApplication> {
    return this.http.patch<AdminWorkerApplication>(
      `${this.baseUrl}/admin/worker-applications/${appId}`,
      payload
    );
  }
}


============================================================
FILE: C:\Users\rdari\Downloads\siph-frontend-master\siph-frontend-master\src\app\core\services\workers.service.ts
============================================================
import { Injectable } from '@angular/core';

@Injectable({
  providedIn: 'root'
})
export class WorkersService {

  constructor() { }
}


============================================================
FILE: C:\Users\rdari\Downloads\siph-frontend-master\siph-frontend-master\src\app\features\auth\login\login.component.html
============================================================
<main class="auth">
  <section class="shell">
    <!-- IZQUIERDA: PANEL -->
    <section class="panel" aria-label="Acceso">
      <div class="panel__inner">
        <div class="brand" aria-label="SIPH">
          <span class="brand__mark">S</span>
          <span class="brand__name">SIPH</span>
        </div>

        <h1>Login</h1>
        <p class="sub">
          Inicia sesiÃ³n para continuar. Puedes usar Google o tu correo y contraseÃ±a.
        </p>

        <!-- âœ… GOOGLE (botÃ³n visual + botÃ³n real invisible encima) -->
        <div class="googleArea">
          <div
            class="gsiWrap"
            [class.gsiWrap--disabled]="loading || !googleReady"
            [attr.aria-disabled]="loading || !googleReady"
          >
            <!-- BotÃ³n ROJO visual -->
            <button class="googleBtnRed" type="button" [disabled]="loading || !googleReady">
              <span class="googleBtnRed__ico" aria-hidden="true">
                <svg viewBox="0 0 48 48">
                  <path
                    fill="#EA4335"
                    d="M24 9.5c3.54 0 6.81 1.22 9.34 3.62l6.84-6.84C35.92 2.54 30.39 0 24 0 14.62 0 6.51 5.38 2.56 13.22l8.02 6.22C12.54 13.08 17.82 9.5 24 9.5z"
                  />
                  <path
                    fill="#4285F4"
                    d="M46.5 24.5c0-1.64-.14-3.22-.41-4.75H24v9h12.68c-.55 2.96-2.25 5.47-4.73 7.16l7.27 5.64C43.53 37.37 46.53 31.53 46.5 24.5z"
                  />
                  <path
                    fill="#FBBC05"
                    d="M10.58 28.56c-.5-1.5-.78-3.1-.78-4.76 0-1.66.28-3.26.78-4.76l-8.02-6.22C.92 16.24 0 20.02 0 23.8c0 3.78.92 7.56 2.56 10.98l8.02-6.22z"
                  />
                  <path
                    fill="#34A853"
                    d="M24 47.5c6.39 0 11.76-2.11 15.68-5.73l-7.27-5.64c-2.02 1.36-4.62 2.17-8.41 2.17-6.18 0-11.46-3.58-13.42-8.44l-8.02 6.22C6.51 42.12 14.62 47.5 24 47.5z"
                  />
                </svg>
              </span>

              <span class="googleBtnRed__text">
                {{ loading ? 'Conectando...' : 'Continuar con Google' }}
              </span>

              <span class="googleBtnRed__spacer" aria-hidden="true"></span>
            </button>

            <!-- âœ… AQUÃ Google renderiza SU botÃ³n real (invisible pero clickable) -->
            <div #gsiBtn class="gsiBtnOverlay" aria-label="Google Sign-In real"></div>
          </div>

          <div class="divider"><span>o</span></div>
        </div>

        <!-- CORREO/CONTRASEÃ‘A -->
        <form [formGroup]="form" (ngSubmit)="submit()" novalidate>
          <label class="field" [class.is-invalid]="f.email.touched && f.email.invalid">
            <span>Correo</span>
            <input
              type="email"
              formControlName="email"
              placeholder="correo@dominio.com"
              autocomplete="email"
            />
            <small class="err" *ngIf="f.email.touched && f.email.invalid">
              Ingresa un correo vÃ¡lido.
            </small>
          </label>

          <label class="field" [class.is-invalid]="f.password.touched && f.password.invalid">
            <span>ContraseÃ±a</span>

            <div class="pass">
              <input
                [type]="showPass ? 'text' : 'password'"
                formControlName="password"
                placeholder="Tu contraseÃ±a"
                autocomplete="current-password"
              />
              <button type="button" class="pass__toggle" (click)="showPass = !showPass">
                {{ showPass ? 'Ocultar' : 'Ver' }}
              </button>
            </div>

            <small class="err" *ngIf="f.password.touched && f.password.invalid">
              La contraseÃ±a debe tener al menos 6 caracteres.
            </small>
          </label>

          <div class="alert" *ngIf="errorMsg">{{ errorMsg }}</div>

          <button
            class="btn"
            type="submit"
            [disabled]="loading || form.invalid"
            [class.is-loading]="loading"
          >
            <span class="btn__text">{{ loading ? 'Entrando...' : 'Iniciar sesiÃ³n' }}</span>
          </button>

          <div class="foot">
            <span>Â¿No tienes cuenta?</span>
            <a routerLink="/auth/register">Crear cuenta</a>
          </div>
        </form>

        <p class="fine">
          Al continuar aceptas nuestros
          <span class="linkLike">TÃ©rminos</span> y
          <span class="linkLike">PolÃ­tica de privacidad</span>.
        </p>

        <p class="copyright">Â©{{ year }} SIPH â€¢ Prototipo acadÃ©mico</p>
      </div>
    </section>

    <!-- DERECHA: CARRUSEL -->
    <aside class="hero" aria-label="Carrusel">
      <div class="hero__slides" aria-hidden="true">
        <div
          class="slide"
          *ngFor="let s of slides; let i = index"
          [class.is-active]="i === active"
          [style.backgroundImage]="'url(' + s.src + ')'"
        ></div>
      </div>

      <div class="hero__shade" aria-hidden="true"></div>

      <div class="hero__content">
        <h2>{{ currentSlide.title }}</h2>
        <p>{{ currentSlide.subtitle }}</p>
      </div>

      <div class="hero__dots" aria-label="Controles de carrusel">
        <button
          type="button"
          class="dot"
          *ngFor="let _ of slides; let i = index"
          [class.is-active]="i === active"
          (click)="goTo(i)"
          [attr.aria-label]="'Ir a slide ' + (i + 1)"
        ></button>
      </div>
    </aside>
  </section>
</main>


============================================================
FILE: C:\Users\rdari\Downloads\siph-frontend-master\siph-frontend-master\src\app\features\auth\login\login.component.ts
============================================================
import { CommonModule, isPlatformBrowser } from '@angular/common';
import {
  AfterViewInit,
  Component,
  ElementRef,
  OnDestroy,
  PLATFORM_ID,
  ViewChild,
  inject,
} from '@angular/core';
import { ActivatedRoute, Router, RouterLink } from '@angular/router';
import { FormBuilder, ReactiveFormsModule, Validators } from '@angular/forms';

import { AuthService } from '../../../core/services/auth.service';
import { environment } from '../../../../environments/environment';

type Slide = { src: string; title: string; subtitle: string };

declare global {
  interface Window {
    google?: any;
  }
}

@Component({
  selector: 'app-login',
  standalone: true,
  imports: [CommonModule, ReactiveFormsModule, RouterLink],
  templateUrl: './login.component.html',
  styleUrls: ['./login.component.scss'],
})
export class LoginComponent implements AfterViewInit, OnDestroy {
  private fb = inject(FormBuilder);
  private router = inject(Router);
  private route = inject(ActivatedRoute);
  private auth = inject(AuthService);
  private platformId = inject(PLATFORM_ID);

  // âœ… mejor opcional para evitar crash si el elemento no existe por alguna razÃ³n
  @ViewChild('gsiBtn', { static: false }) gsiBtn?: ElementRef<HTMLDivElement>;

  loading = false;
  errorMsg = '';
  showPass = false;
  year = new Date().getFullYear();

  // âœ… Google GSI
  googleReady = false;
  private googleClientId = '';
  private gsiRendered = false;

  form = this.fb.group({
    email: ['', [Validators.required, Validators.email]],
    password: ['', [Validators.required, Validators.minLength(6)]],
  });

  get f() {
    return this.form.controls;
  }

  slides: Slide[] = [
    {
      src: 'assets/siph_carousel_1.png',
      title: 'Encuentra expertos verificados',
      subtitle: 'Perfiles, reseÃ±as y disponibilidad real.',
    },
    {
      src: 'assets/siph_carousel_2.png',
      title: 'Solicita un servicio en minutos',
      subtitle: 'Publica tu necesidad y recibe propuestas.',
    },
    {
      src: 'assets/siph_carousel_3.png',
      title: 'Seguimiento claro del servicio',
      subtitle: 'Estados en tiempo real y trazabilidad.',
    },
    {
      src: 'assets/siph_carousel_4.png',
      title: 'Califica y mejora la confianza',
      subtitle: 'ReseÃ±as para tomar mejores decisiones.',
    },
  ];

  active = 0;
  private timer: any = null;

  get currentSlide(): Slide {
    return this.slides[this.active] ?? this.slides[0];
  }

  ngAfterViewInit(): void {
    if (!isPlatformBrowser(this.platformId)) return;

    this.timer = setInterval(() => this.next(), 5500);
    this.initGoogle();
  }

  ngOnDestroy(): void {
    if (this.timer) clearInterval(this.timer);
  }

  // =========================
  // Carrusel
  // =========================
  goTo(i: number) {
    this.active = i;
    this.resetTimer();
  }

  next() {
    this.active = (this.active + 1) % this.slides.length;
  }

  private resetTimer() {
    if (!isPlatformBrowser(this.platformId)) return;
    if (this.timer) clearInterval(this.timer);
    this.timer = setInterval(() => this.next(), 5500);
  }

  // =========================
  // Login con correo
  // =========================
  submit() {
    this.errorMsg = '';

    if (this.form.invalid) {
      this.form.markAllAsTouched();
      return;
    }

    this.loading = true;

    const payload = {
      email: this.f.email.value!.trim().toLowerCase(),
      password: this.f.password.value!,
    };

    const anyAuth = this.auth as any;
    const req$ = anyAuth.login?.(payload);

    if (!req$?.subscribe) {
      this.loading = false;
      this.errorMsg =
        'No encuentro AuthService.login(). Crea login({email,password}) en tu AuthService.';
      return;
    }

    req$.subscribe({
      next: () => {
        this.loading = false;
        const redirect = this.route.snapshot.queryParamMap.get('redirect') ?? '/dashboard';
        // âœ… mÃ¡s seguro que navigate([redirect])
        this.router.navigateByUrl(redirect);
      },
      error: (err: any) => {
        this.loading = false;
        this.errorMsg =
          err?.error?.detail ||
          err?.error?.message ||
          err?.message ||
          'No se pudo iniciar sesiÃ³n. Verifica tus credenciales.';
      },
    });
  }

  // =========================
  // Google GSI
  // =========================
  private getClientId(): string {
    return (
      (environment as any).googleClientId ||
      (environment as any).google_client_id ||
      (environment as any).GOOGLE_CLIENT_ID ||
      ''
    );
  }

  private async initGoogle() {
    const clientId = this.getClientId();
    if (!clientId) {
      this.errorMsg = 'Falta GOOGLE_CLIENT_ID en environment.';
      return;
    }

    this.googleClientId = clientId;

    try {
      await this.loadGoogleScript();
    } catch {
      this.errorMsg = 'No se pudo cargar Google. Revisa internet o bloqueadores (adblock).';
      return;
    }

    const google = window.google;
    if (!google?.accounts?.id) {
      this.errorMsg = 'Google Identity Services no estÃ¡ disponible en este navegador.';
      return;
    }

    google.accounts.id.initialize({
      client_id: this.googleClientId,
      callback: (resp: any) => this.onGoogleCredential(resp),
      ux_mode: 'popup',
      auto_select: false,
      cancel_on_tap_outside: true,
    });

    this.googleReady = true;

    // âœ… render cuando el #gsiBtn ya exista
    this.renderGoogleButtonSafe();
  }

  private renderGoogleButtonSafe() {
    if (!isPlatformBrowser(this.platformId)) return;
    if (this.gsiRendered) return;

    // si el elemento aÃºn no estÃ¡, reintenta una vez
    if (!this.gsiBtn?.nativeElement) {
      setTimeout(() => this.renderGoogleButtonSafe(), 0);
      return;
    }

    const google = window.google;
    if (!google?.accounts?.id?.renderButton) return;

    this.gsiBtn.nativeElement.innerHTML = '';

    google.accounts.id.renderButton(this.gsiBtn.nativeElement, {
      type: 'standard',
      theme: 'outline',
      size: 'large',
      text: 'continue_with',
      shape: 'pill',
      width: Math.min(380, this.gsiBtn.nativeElement.clientWidth || 380),
      locale: 'es',
    });

    this.gsiRendered = true;
  }

  private loadGoogleScript(): Promise<void> {
    return new Promise((resolve, reject) => {
      const id = 'google-gsi';
      if (document.getElementById(id)) {
        resolve();
        return;
      }
      const s = document.createElement('script');
      s.id = id;
      s.src = 'https://accounts.google.com/gsi/client';
      s.async = true;
      s.defer = true;
      s.onload = () => resolve();
      s.onerror = () => reject();
      document.head.appendChild(s);
    });
  }

  private onGoogleCredential(resp: any) {
    const credential = resp?.credential;

    if (!credential) {
      this.errorMsg = 'No se pudo obtener el token de Google. Intenta nuevamente.';
      return;
    }

    this.loading = true;
    this.errorMsg = '';

    const anyAuth = this.auth as any;
    const req$ = anyAuth.loginWithGoogle?.(credential);

    if (!req$?.subscribe) {
      this.loading = false;
      this.errorMsg =
        'No encuentro AuthService.loginWithGoogle(credential). Debes implementarlo igual que en Register.';
      return;
    }

    req$.subscribe({
      next: () => {
        this.loading = false;
        const redirect = this.route.snapshot.queryParamMap.get('redirect') ?? '/dashboard';
        // âœ… mÃ¡s seguro
        this.router.navigateByUrl(redirect);
      },
      error: (err: any) => {
        this.loading = false;
        this.errorMsg =
          err?.error?.detail ||
          err?.error?.message ||
          err?.message ||
          'No se pudo iniciar con Google. Intenta de nuevo.';
      },
    });
  }
}


============================================================
FILE: C:\Users\rdari\Downloads\siph-frontend-master\siph-frontend-master\src\app\features\auth\register\register.component.html
============================================================
<main class="auth">
  <section class="shell">
    <!-- IZQUIERDA -->
    <aside class="hero" aria-hidden="true">
      <img class="hero__img" [src]="heroImg" alt="" loading="eager" decoding="async" />
      <div class="hero__overlay"></div>

      <div class="hero__top">
        <div class="brand">
          <span class="brand__mark">S</span>
          <span class="brand__name">SIPH</span>
        </div>
        <span class="pill">Prototipo â€¢ Servicios para el hogar</span>
      </div>

      <div class="hero__content">
        <h2>Servicios para tu hogar</h2>
        <p>Encuentra expertos cerca de ti, con reseÃ±as y seguimiento del servicio.</p>

        <ul class="hero__list">
          <li><span class="dot">âœ“</span> Perfiles y calificaciones</li>
          <li><span class="dot">âœ“</span> Solicitudes y estados en tiempo real</li>
          <li><span class="dot">âœ“</span> Contacto rÃ¡pido con expertos</li>
        </ul>

        <div class="hero__card">
          <div class="hero__cardTitle">Confianza y trazabilidad</div>
          <div class="hero__cardText">
            Historial del servicio, estados claros y reseÃ±as para tomar mejores decisiones.
          </div>
        </div>
      </div>

      <div class="hero__bottom">
        <span class="tiny">Â© SIPH â€¢ InstituciÃ³n Universitaria de Barranquilla</span>
      </div>
    </aside>

    <!-- DERECHA -->
    <section class="panel">
      <header class="panel__head">
        <div class="panel__brand">
          <div>
            <div class="panel__title">Registra tu cuenta</div>
            <div class="panel__subtitle">
              RegÃ­strate para solicitar servicios o ofrecer tus servicios como experto.
            </div>
          </div>
        </div>
      </header>

      <!-- âœ… GOOGLE (GSI renderButton) -->
      <div class="social">
        <div
          class="gsiWrap"
          [class.gsiWrap--disabled]="loading || !googleReady"
          [attr.aria-disabled]="loading || !googleReady"
        >
          <div #gsiBtn class="gsiBtn" aria-label="Continuar con Google"></div>
        </div>

        <div class="divider"><span>o</span></div>
      </div>

      <form [formGroup]="form" (ngSubmit)="submit()" novalidate>
        <div class="grid">
          <label class="field" [class.is-invalid]="f.first_name.touched && f.first_name.invalid">
            <span>Nombre</span>
            <input type="text" formControlName="first_name" placeholder="Juan" autocomplete="given-name" />
            <small class="err" *ngIf="f.first_name.touched && f.first_name.invalid">
              Ingresa un nombre vÃ¡lido (mÃ­n. 2).
            </small>
          </label>

          <label class="field" [class.is-invalid]="f.last_name.touched && f.last_name.invalid">
            <span>Apellido</span>
            <input type="text" formControlName="last_name" placeholder="PÃ©rez" autocomplete="family-name" />
            <small class="err" *ngIf="f.last_name.touched && f.last_name.invalid">
              Ingresa un apellido vÃ¡lido (mÃ­n. 2).
            </small>
          </label>

          <label class="field full" [class.is-invalid]="f.email.touched && f.email.invalid">
            <span>Email</span>
            <input type="email" formControlName="email" placeholder="correo@dominio.com" autocomplete="email" />
            <small class="err" *ngIf="f.email.touched && f.email.invalid">Ingresa un correo vÃ¡lido.</small>
          </label>

          <label class="field full" [class.is-invalid]="f.password.touched && f.password.invalid">
            <span>ContraseÃ±a</span>

            <div class="pass">
              <input
                [type]="showPass ? 'text' : 'password'"
                formControlName="password"
                placeholder="MÃ­nimo 6 caracteres"
                autocomplete="new-password"
              />
              <button type="button" class="pass__toggle" (click)="showPass = !showPass">
                {{ showPass ? 'Ocultar' : 'Ver' }}
              </button>
            </div>

            <small class="err" *ngIf="f.password.touched && f.password.invalid">
              La contraseÃ±a debe tener al menos 6 caracteres.
            </small>
          </label>

          <div class="hint full">
            <div class="hint__title">CUENTA DE USUARIO</div>
            <p class="hint__text">
              Todos los registros se crean como usuarios. Para solicitar servicios debes iniciar sesiÃ³n.
            </p>
          </div>
        </div>

        <div class="alert" *ngIf="errorMsg">{{ errorMsg }}</div>

        <button class="btn" type="submit" [disabled]="loading || form.invalid" [class.is-loading]="loading">
          <span class="btn__text">{{ loading ? 'Creando...' : 'Crear cuenta' }}</span>
        </button>

        <div class="foot">
          <span>Â¿Ya tienes cuenta?</span>
          <a routerLink="/auth/login">Entrar</a>
        </div>
      </form>
    </section>
  </section>
</main>


============================================================
FILE: C:\Users\rdari\Downloads\siph-frontend-master\siph-frontend-master\src\app\features\auth\register\register.component.ts
============================================================
import {
  AfterViewInit,
  Component,
  ElementRef,
  PLATFORM_ID,
  ViewChild,
  inject,
} from '@angular/core';
import { CommonModule, isPlatformBrowser } from '@angular/common';
import { Router, RouterLink } from '@angular/router';
import { FormBuilder, ReactiveFormsModule, Validators } from '@angular/forms';

import { AuthService } from '../../../core/services/auth.service';
import { environment } from '../../../../environments/environment';

declare global {
  interface Window {
    google?: any;
  }
}

@Component({
  selector: 'app-register',
  standalone: true,
  imports: [CommonModule, ReactiveFormsModule, RouterLink],
  templateUrl: './register.component.html',
  styleUrls: ['./register.component.scss'],
})
export class RegisterComponent implements AfterViewInit {
  private fb = inject(FormBuilder);
  private router = inject(Router);
  private auth = inject(AuthService);
  private platformId = inject(PLATFORM_ID);

  // âœ… En tu HTML debe existir: <div #gsiBtn class="gsiBtn"></div>
  @ViewChild('gsiBtn', { static: false }) gsiBtn?: ElementRef<HTMLDivElement>;

  // âœ… OJO: esta ruta debe existir en src/assets/
  heroImg = 'assets/pexels-photo-259588-M3k_H4KE.jpeg';

  loading = false;
  errorMsg = '';
  showPass = false;

  // âœ… Google GSI
  googleReady = false;
  private googleClientId = '';
  private googleBtnRendered = false;

  form = this.fb.group({
    first_name: ['', [Validators.required, Validators.minLength(2)]],
    last_name: ['', [Validators.required, Validators.minLength(2)]],
    email: ['', [Validators.required, Validators.email]],
    password: ['', [Validators.required, Validators.minLength(6)]],
  });

  get f() {
    return this.form.controls;
  }

  ngAfterViewInit(): void {
    if (!isPlatformBrowser(this.platformId)) return;
    this.initGoogle();
  }

  private getClientId(): string {
    return (
      (environment as any).googleClientId ||
      (environment as any).google_client_id ||
      (environment as any).GOOGLE_CLIENT_ID ||
      ''
    );
  }

  private async initGoogle() {
    const clientId = this.getClientId();
    if (!clientId) return;

    this.googleClientId = clientId;

    try {
      await this.loadGoogleScript();
    } catch {
      return;
    }

    const google = window.google;
    if (!google?.accounts?.id) return;

    google.accounts.id.initialize({
      client_id: this.googleClientId,
      callback: (resp: any) => this.onGoogleCredential(resp),
      ux_mode: 'popup',
      auto_select: false,
      cancel_on_tap_outside: true,
      // âœ… ayuda con cambios de FedCM (Chrome)
      use_fedcm_for_prompt: true,
    });

    this.googleReady = true;

    // âœ… recomendado: usar botÃ³n oficial (mÃ¡s estable que prompt)
    this.renderGoogleButton();
  }

  private renderGoogleButton() {
    if (!isPlatformBrowser(this.platformId)) return;
    if (!this.googleReady) return;
    if (!this.gsiBtn?.nativeElement) return;
    if (this.googleBtnRendered) return;

    const google = window.google;
    if (!google?.accounts?.id?.renderButton) return;

    try {
      // limpia por si Angular re-renderiza
      this.gsiBtn.nativeElement.innerHTML = '';

      google.accounts.id.renderButton(this.gsiBtn.nativeElement, {
        type: 'standard',
        theme: 'outline',
        size: 'large',
        text: 'continue_with',
        shape: 'pill',
        width: 320, // si quieres 100% hazlo por CSS del contenedor
        locale: 'es',
      });

      this.googleBtnRendered = true;
    } catch {
      // silent
    }
  }

  private loadGoogleScript(): Promise<void> {
    return new Promise((resolve, reject) => {
      const id = 'google-gsi';
      if (document.getElementById(id)) {
        resolve();
        return;
      }

      const s = document.createElement('script');
      s.id = id;
      s.src = 'https://accounts.google.com/gsi/client';
      s.async = true;
      s.defer = true;
      s.onload = () => resolve();
      s.onerror = () => reject();
      document.head.appendChild(s);
    });
  }

  // âœ… Fallback (si quieres un botÃ³n custom que dispare prompt())
  signInWithGoogle() {
    if (!isPlatformBrowser(this.platformId)) return;

    if (!this.googleReady || !window.google?.accounts?.id) {
      this.errorMsg = 'Google no estÃ¡ listo todavÃ­a. Recarga la pÃ¡gina e intenta de nuevo.';
      return;
    }

    this.errorMsg = '';

    window.google.accounts.id.prompt((notification: any) => {
      if (notification?.isNotDisplayed?.() || notification?.isSkippedMoment?.()) {
        this.errorMsg =
          'No se pudo abrir Google aquÃ­ (bloqueo del navegador, cookies o FedCM). Intenta otro navegador o usa email/contraseÃ±a.';
      }
    });
  }

  private onGoogleCredential(resp: any) {
    const credential = resp?.credential;

    if (!credential) {
      this.errorMsg = 'No se pudo obtener el token de Google. Intenta nuevamente.';
      return;
    }

    this.loading = true;
    this.errorMsg = '';

    // âœ… Debe existir en tu AuthService
    // loginWithGoogle(credential: string) => POST /auth/google
    this.auth.loginWithGoogle(credential).subscribe({
      next: () => {
        this.loading = false;
        // âœ… manda al dashboard (no a "/")
        this.router.navigateByUrl('/dashboard');
      },
      error: (err: any) => {
        this.loading = false;
        this.errorMsg =
          err?.error?.detail ||
          err?.error?.message ||
          err?.message ||
          'No se pudo iniciar con Google. Intenta de nuevo.';
      },
    });
  }

  submit() {
    this.errorMsg = '';

    if (this.form.invalid) {
      this.form.markAllAsTouched();
      return;
    }

    this.loading = true;

    const payload = {
      first_name: this.f.first_name.value!.trim(),
      last_name: this.f.last_name.value!.trim(),
      email: this.f.email.value!.trim().toLowerCase(),
      password: this.f.password.value!,
    };

    // âœ… Debe existir en tu AuthService
    // register(payload) => POST /auth/register
    this.auth.register(payload).subscribe({
      next: () => {
        this.loading = false;
        // âœ… manda al dashboard (no a "/")
        this.router.navigateByUrl('/dashboard');
      },
      error: (err: any) => {
        this.loading = false;
        this.errorMsg =
          err?.error?.detail ||
          err?.error?.message ||
          err?.message ||
          'No se pudo crear la cuenta. Verifica los datos e intenta de nuevo.';
      },
    });
  }
}


============================================================
FILE: C:\Users\rdari\Downloads\siph-frontend-master\siph-frontend-master\src\app\features\dashboard\dashboard.component.html
============================================================
<main class="dash">
  <section class="wrap">
    <header class="head hero">
      <div class="head__left">
        <div class="badge">Dashboard</div>
        <h1>
          Hola, <span class="accent">{{ greetingName }}</span> ðŸ‘‹
        </h1>
        <p>Gestiona tus solicitudes, mira expertos y revisa tu actividad en SIPH.</p>
      </div>

      <div class="head__right">
        <button class="btn btn--ghost" type="button" (click)="loadDashboard()" [disabled]="loading">
          {{ loading ? 'Actualizandoâ€¦' : 'Actualizar' }}
        </button>

        <button class="btn btn--primary" type="button" (click)="go('/requests/new')">
          + Nueva solicitud
        </button>
      </div>
    </header>

    <div class="alert" *ngIf="errorMsg">{{ errorMsg }}</div>

    <section class="kpis" *ngIf="!loading; else skel">
      <article class="kpi" *ngFor="let k of kpis">
        <div class="kpi__icon" aria-hidden="true">{{ k.icon }}</div>
        <div class="kpi__meta">
          <div class="kpi__label">{{ k.label }}</div>
          <div class="kpi__value">{{ k.value }}</div>
          <div class="kpi__hint" *ngIf="k.hint">{{ k.hint }}</div>
        </div>
      </article>
    </section>

    <section class="grid grid--dashboard" *ngIf="!loading; else skel">
      <article class="card card--actions">
        <div class="card__top">
          <h2>Acciones rÃ¡pidas</h2>
          <span class="chip">Recomendado</span>
        </div>

        <div class="actions">
          <button class="action" type="button" (click)="go('/workers')">
            <div class="action__icon" aria-hidden="true">ðŸ§‘â€ðŸ”§</div>
            <div class="action__text">
              <div class="action__title">Buscar expertos</div>
              <div class="action__sub">Ver perfiles y reseÃ±as</div>
            </div>
          </button>

          <button class="action" type="button" (click)="go('/my-requests')">
            <div class="action__icon" aria-hidden="true">ðŸ“Œ</div>
            <div class="action__text">
              <div class="action__title">Mis solicitudes</div>
              <div class="action__sub">Estados y seguimiento</div>
            </div>
          </button>

          <button class="action" type="button" (click)="go('/reviews')">
            <div class="action__icon" aria-hidden="true">â­</div>
            <div class="action__text">
              <div class="action__title">ReseÃ±as</div>
              <div class="action__sub">Confianza y reputaciÃ³n</div>
            </div>
          </button>
        </div>

        <div class="tip">
          <div class="tip__title">Tip</div>
          <div class="tip__text">
            Mientras mÃ¡s clara sea tu solicitud (detalle + fotos + ubicaciÃ³n), mÃ¡s rÃ¡pido recibes ayuda.
          </div>
        </div>
      </article>

      <article class="card card--requests">
        <div class="card__top">
          <h2>Solicitudes recientes</h2>
          <a class="link" routerLink="/my-requests">Ver todo</a>
        </div>

        <div class="empty" *ngIf="recentRequests.length === 0">
          <div class="empty__icon" aria-hidden="true">ðŸ“</div>
          <div class="empty__title">AÃºn no tienes solicitudes</div>
          <div class="empty__sub">Crea tu primera solicitud para empezar.</div>
          <button class="btn btn--primary" type="button" (click)="go('/requests/new')">Crear solicitud</button>
        </div>

        <div class="list" *ngIf="recentRequests.length > 0">
          <div class="row" *ngFor="let r of recentRequests" [ngClass]="statusTone(r.status)">
            <div class="row__main">
              <div class="row__title">{{ r.title }}</div>
              <div class="row__sub">{{ r.description || 'Sin descripciÃ³n' }}</div>
            </div>

            <div class="row__side">
              <span class="pill" [ngClass]="statusTone(r.status)">
                {{ statusLabel(r.status) }}
              </span>

              <button class="mini" type="button" (click)="go('/my-requests')">Ver</button>
            </div>
          </div>
        </div>
      </article>

      <article class="card card--workers">
        <div class="card__top">
          <h2>Expertos sugeridos</h2>
          <a class="link" routerLink="/workers">Explorar</a>
        </div>

        <div class="empty" *ngIf="topWorkers.length === 0">
          <div class="empty__icon" aria-hidden="true">ðŸ§°</div>
          <div class="empty__title">Sin expertos para mostrar</div>
          <div class="empty__sub">Cuando conectes el backend, aquÃ­ verÃ¡s sugerencias.</div>
        </div>

        <div class="workers" *ngIf="topWorkers.length > 0">
          <div class="wcard" *ngFor="let w of topWorkers">
            <div class="wcard__avatar" [style.backgroundImage]="'url(' + (w.avatar_url || '') + ')'">
              <span *ngIf="!w.avatar_url">{{ (w.first_name || 'E')[0] }}</span>
            </div>

            <div class="wcard__meta">
              <div class="wcard__name">{{ w.first_name }} {{ w.last_name }}</div>
              <div class="wcard__sub">{{ w.oficio }} â€¢ {{ w.city }}</div>

              <div class="wcard__rate">
                <span class="star" aria-hidden="true">â˜…</span>
                <span class="num">{{ w.rating ? (w.rating | number:'1.0-1') : 'â€”' }}</span>
                <span class="muted">({{ w.jobs_done || 0 }} trabajos)</span>
              </div>
            </div>

            <button class="mini" type="button" (click)="goWorker(w)">Ver</button>
          </div>
        </div>
      </article>
    </section>

    <footer class="foot">
      <span>Â© {{ year }} SIPH â€¢ Dashboard</span>
      <span class="dot">â€¢</span>
      <span class="muted">Rol: {{ role }}</span>
    </footer>

    <ng-template #skel>
      <section class="kpis">
        <article class="kpi sk" *ngFor="let i of [1,2,3,4]">
          <div class="sk__a"></div>
          <div class="sk__b"></div>
          <div class="sk__c"></div>
        </article>
      </section>

      <section class="grid grid--dashboard">
        <article class="card sk" style="min-height: 330px"></article>
        <article class="card sk" style="min-height: 330px"></article>
        <article class="card sk" style="min-height: 330px"></article>
      </section>
    </ng-template>
  </section>
</main>


============================================================
FILE: C:\Users\rdari\Downloads\siph-frontend-master\siph-frontend-master\src\app\features\dashboard\dashboard.component.ts
============================================================
import { CommonModule } from '@angular/common';
import { Component, OnInit, inject } from '@angular/core';
import { Router, RouterLink } from '@angular/router';
import { forkJoin, of } from 'rxjs';
import { catchError, finalize, map } from 'rxjs/operators';

import { AuthService } from '../../core/services/auth.service';
import { RequestsService } from '../../core/services/requests.service';
import { WorkersService } from '../../core/services/workers.service';
import { ReviewsService } from '../../core/services/reviews.service';

type SlideKpi = { label: string; value: number | string; hint?: string; icon: string };

type RequestItem = {
  id?: number | string;
  title?: string;
  description?: string;
  status?: string;
  created_at?: string;
};

type WorkerItem = {
  id?: number | string;
  first_name?: string;
  last_name?: string;
  oficio?: string;
  city?: string;
  rating?: number;
  jobs_done?: number;
  avatar_url?: string;
};

@Component({
  selector: 'app-dashboard',
  standalone: true,
  imports: [CommonModule, RouterLink],
  templateUrl: './dashboard.component.html',
  styleUrls: ['./dashboard.component.scss'],
})
export class DashboardComponent implements OnInit {
  private router = inject(Router);

  private auth = inject(AuthService);
  private requests = inject(RequestsService);
  private workers = inject(WorkersService);
  private reviews = inject(ReviewsService);

  loading = true;
  errorMsg = '';
  year = new Date().getFullYear();

  greetingName = 'Usuario';
  role = 'USER';

  kpis: SlideKpi[] = [
    { label: 'Solicitudes activas', value: 0, hint: 'En curso / asignadas', icon: 'âš¡' },
    { label: 'Finalizadas', value: 0, hint: 'Servicios completados', icon: 'âœ…' },
    { label: 'CalificaciÃ³n', value: 'â€”', hint: 'Promedio de reseÃ±as', icon: 'â­' },
    { label: 'Expertos sugeridos', value: 0, hint: 'Cerca de ti', icon: 'ðŸ§°' },
  ];

  recentRequests: RequestItem[] = [];
  topWorkers: WorkerItem[] = [];

  ngOnInit(): void {
    this.loadDashboard();
  }

  loadDashboard() {
    this.loading = true;
    this.errorMsg = '';

    // Intento leer usuario si tu AuthService lo expone
    try {
      const anyAuth = this.auth as any;
      const u = anyAuth?.currentUser || anyAuth?.user || anyAuth?.getUser?.() || null;
      if (u?.first_name) this.greetingName = u.first_name;
      if (u?.role) this.role = u.role;
    } catch {}

    const anyReq = this.requests as any;
    const anyWorkers = this.workers as any;
    const anyReviews = this.reviews as any;

    // Requests: intenta varios nombres comunes
    const myReq$ =
      (anyReq.myRequests?.() ||
        anyReq.getMyRequests?.() ||
        anyReq.listMyRequests?.() ||
        anyReq.getMine?.() ||
        of([])).pipe(
        catchError(() => of([])),
        map((res: any) => (Array.isArray(res) ? res : res?.resultado ?? res?.items ?? res?.data ?? []))
      );

    // Workers
    const workers$ =
      (anyWorkers.getWorkers?.() ||
        anyWorkers.listWorkers?.() ||
        anyWorkers.getAll?.() ||
        of([])).pipe(
        catchError(() => of([])),
        map((res: any) => (Array.isArray(res) ? res : res?.resultado ?? res?.items ?? res?.data ?? []))
      );

    // Reviews
    const reviews$ =
      (anyReviews.myReviews?.() ||
        anyReviews.getMyReviews?.() ||
        anyReviews.listMyReviews?.() ||
        of([])).pipe(
        catchError(() => of([])),
        map((res: any) => (Array.isArray(res) ? res : res?.resultado ?? res?.items ?? res?.data ?? []))
      );

    forkJoin({ myReq: myReq$, workers: workers$, reviews: reviews$ })
      .pipe(
        finalize(() => (this.loading = false)),
        catchError(() => {
          this.errorMsg = 'No se pudo cargar el dashboard. Intenta recargar.';
          return of({ myReq: [], workers: [], reviews: [] });
        })
      )
      .subscribe(({ myReq, workers, reviews }: any) => {
        const reqs: RequestItem[] = (myReq ?? []).map((r: any) => ({
          id: r?.id ?? r?._id,
          title: r?.title ?? r?.titulo ?? 'Solicitud',
          description: r?.description ?? r?.descripcion ?? '',
          status: r?.status ?? r?.estado ?? 'CREATED',
          created_at: r?.created_at ?? r?.createdAt ?? '',
        }));

        const wk: WorkerItem[] = (workers ?? []).map((w: any) => ({
          id: w?.id ?? w?._id,
          first_name: w?.first_name ?? w?.firstName ?? w?.nombre ?? 'Experto',
          last_name: w?.last_name ?? w?.lastName ?? w?.apellido ?? '',
          oficio: w?.oficio ?? w?.job ?? w?.especialidad ?? 'Servicio',
          city: w?.city ?? w?.ciudad ?? 'â€”',
          rating: Number(w?.rating ?? w?.promedio ?? 0) || 0,
          jobs_done: Number(w?.jobs_done ?? w?.trabajos ?? 0) || 0,
          avatar_url: w?.avatar_url ?? w?.avatar ?? '',
        }));

        const avgRating =
          (reviews ?? []).length > 0
            ? (
                (reviews ?? []).reduce((acc: number, x: any) => acc + Number(x?.rating ?? 0), 0) /
                (reviews ?? []).length
              ).toFixed(1)
            : 'â€”';

        const activeCount = reqs.filter((r) =>
          ['CREATED', 'ASSIGNED', 'IN_PROGRESS', 'ACEPTADA', 'EN_PROCESO', 'ASIGNADA'].includes(
            (r.status ?? '').toUpperCase()
          )
        ).length;

        const doneCount = reqs.filter((r) =>
          ['DONE', 'FINISHED', 'FINALIZADA', 'COMPLETED'].includes((r.status ?? '').toUpperCase())
        ).length;

        this.recentRequests = reqs.slice(0, 6);
        this.topWorkers = wk.slice(0, 6);

        this.kpis = [
          { label: 'Solicitudes activas', value: activeCount, hint: 'En curso / asignadas', icon: 'âš¡' },
          { label: 'Finalizadas', value: doneCount, hint: 'Servicios completados', icon: 'âœ…' },
          { label: 'CalificaciÃ³n', value: avgRating, hint: 'Promedio de reseÃ±as', icon: 'â­' },
          { label: 'Expertos sugeridos', value: this.topWorkers.length, hint: 'Cerca de ti', icon: 'ðŸ§°' },
        ];
      });
  }

  go(path: string) {
    this.router.navigate([path]);
  }

  goWorker(w: WorkerItem) {
    if (!w?.id) return this.go('/workers');
    this.router.navigate(['/workers', w.id]);
  }

  statusLabel(s?: string) {
    const v = (s ?? '').toUpperCase();
    if (v === 'CREATED') return 'Creada';
    if (['ASSIGNED', 'ACEPTADA', 'ASIGNADA'].includes(v)) return 'Asignada';
    if (['IN_PROGRESS', 'EN_PROCESO'].includes(v)) return 'En proceso';
    if (['DONE', 'FINISHED', 'FINALIZADA', 'COMPLETED'].includes(v)) return 'Finalizada';
    if (['CANCELLED', 'CANCELADA'].includes(v)) return 'Cancelada';
    return s ?? 'â€”';
  }

  statusTone(s?: string) {
    const v = (s ?? '').toUpperCase();
    if (v === 'CREATED') return 'tone-warn';
    if (['ASSIGNED', 'ACEPTADA', 'ASIGNADA'].includes(v)) return 'tone-info';
    if (['IN_PROGRESS', 'EN_PROCESO'].includes(v)) return 'tone-live';
    if (['DONE', 'FINISHED', 'FINALIZADA', 'COMPLETED'].includes(v)) return 'tone-ok';
    if (['CANCELLED', 'CANCELADA'].includes(v)) return 'tone-bad';
    return 'tone-neutral';
  }
}


============================================================
FILE: C:\Users\rdari\Downloads\siph-frontend-master\siph-frontend-master\src\app\features\home\home.component.html
============================================================
<main class="page">
  <!-- HERO -->
  <section class="hero">
    <div class="hero__bg"></div>

    <div class="hero__wrap hero__wrap--single">
      <div class="hero__content">
        <p class="badge">SIPH â€¢ Servicios inmediatos para el hogar</p>

        <h1>
          Encuentra expertos confiables
          <span class="accent">en minutos</span>.
        </h1>

        <p class="sub">
          PlomerÃ­a, electricidad, pintura y mÃ¡s. Solicita, haz seguimiento por estado y califica la experiencia.
        </p>

        <div class="cta">
          <button class="btn btn--primary" type="button" (click)="goExperts()">Buscar expertos</button>
          <button class="btn btn--ghost" type="button" (click)="goRequest()">Crear solicitud</button>
        </div>

        <div class="stats">
          <div class="stat">
            <div class="stat__k">+50</div>
            <div class="stat__t">perfiles de ejemplo</div>
          </div>
          <div class="stat">
            <div class="stat__k">4 mÃ³dulos</div>
            <div class="stat__t">solicitud, expertos, estados, reseÃ±as</div>
          </div>
          <div class="stat">
            <div class="stat__k">UX simple</div>
            <div class="stat__t">pensado para todos</div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- CATEGORIES -->
  <section class="section">
    <div class="section__head">
      <h2>Servicios populares</h2>
      <p>Elige una categorÃ­a y encuentra expertos disponibles cerca de ti.</p>
    </div>

    <div class="grid">
      <article class="tile" *ngFor="let c of categories">
        <div class="tile__icon">{{ c.emoji }}</div>
        <div class="tile__body">
          <h3>{{ c.title }}</h3>
          <p>{{ c.hint }}</p>
        </div>
      </article>
    </div>
  </section>

  <!-- FEATURES -->
  <section class="section section--alt">
    <div class="section__head">
      <h2>Â¿Por quÃ© SIPH?</h2>
      <p>DiseÃ±ado para reducir incertidumbre: reputaciÃ³n, comparaciÃ³n y seguimiento.</p>
    </div>

    <div class="grid grid--2">
      <article class="feature" *ngFor="let f of features">
        <div class="feature__icon">{{ f.emoji }}</div>
        <div>
          <h3>{{ f.title }}</h3>
          <p>{{ f.desc }}</p>
        </div>
      </article>
    </div>
  </section>

  <!-- STEPS -->
  <section class="section">
    <div class="section__head">
      <h2>AsÃ­ funciona</h2>
      <p>Flujo simple: solicitar â†’ asignar â†’ seguimiento â†’ reseÃ±a.</p>
    </div>

    <div class="steps">
      <div class="step">
        <div class="step__n">1</div>
        <div class="step__t">Crea tu solicitud</div>
        <div class="step__d">Describe el problema, ubicaciÃ³n y detalles.</div>
      </div>

      <div class="step">
        <div class="step__n">2</div>
        <div class="step__t">Selecciona un experto</div>
        <div class="step__d">Compara perfiles y reputaciÃ³n.</div>
      </div>

      <div class="step">
        <div class="step__n">3</div>
        <div class="step__t">Sigue el estado</div>
        <div class="step__d">Creada â†’ En proceso â†’ Finalizada.</div>
      </div>

      <div class="step">
        <div class="step__n">4</div>
        <div class="step__t">Califica y comenta</div>
        <div class="step__d">Ayuda a construir confianza en la comunidad.</div>
      </div>
    </div>
  </section>

  <!-- FINAL CTA -->
  <section class="final">
    <div class="final__wrap">
      <h2>Â¿Listo para probar el prototipo?</h2>
      <p>Explora expertos, crea una solicitud y mira el seguimiento por estado.</p>
      <div class="cta">
        <a class="btn btn--primary" routerLink="/workers">Explorar expertos</a>
        <a class="btn btn--ghost" routerLink="/requests/new">Crear solicitud</a>
      </div>
    </div>
  </section>
</main>


============================================================
FILE: C:\Users\rdari\Downloads\siph-frontend-master\siph-frontend-master\src\app\features\home\home.component.ts
============================================================
import { Component } from '@angular/core';
import { Router, RouterLink } from '@angular/router';
import { CommonModule } from '@angular/common';

type Category = { title: string; emoji: string; hint: string };
type Feature = { title: string; desc: string; emoji: string };

@Component({
  selector: 'app-home',
  standalone: true,
  imports: [CommonModule, RouterLink],
  templateUrl: './home.component.html',
  styleUrl: './home.component.scss',
})
export class HomeComponent {
  categories: Category[] = [
    { title: 'PlomerÃ­a', emoji: 'ðŸš°', hint: 'Fugas, griferÃ­a, tuberÃ­as' },
    { title: 'Electricidad', emoji: 'âš¡', hint: 'Cortos, tomas, iluminaciÃ³n' },
    { title: 'CarpinterÃ­a', emoji: 'ðŸªš', hint: 'Puertas, muebles, ajustes' },
    { title: 'Pintura', emoji: 'ðŸŽ¨', hint: 'Paredes, retoques, acabados' },
    { title: 'CerrajerÃ­a', emoji: 'ðŸ”', hint: 'Cerraduras, llaves, aperturas' },
    { title: 'Mantenimiento', emoji: 'ðŸ› ï¸', hint: 'Arreglos generales' },
  ];

  features: Feature[] = [
    { title: 'Expertos verificados', desc: 'Perfiles con informaciÃ³n clara y reputaciÃ³n visible.', emoji: 'âœ…' },
    { title: 'Solicita en minutos', desc: 'Crea una solicitud con detalles y ubicaciÃ³n.', emoji: 'â±ï¸' },
    { title: 'Seguimiento por estado', desc: 'Mira el avance: creada, en proceso, finalizada.', emoji: 'ðŸ“' },
    { title: 'ReseÃ±as y calificaciones', desc: 'Confianza basada en experiencias reales.', emoji: 'â­' },
  ];

  constructor(private router: Router) {}

  goExperts() {
    this.router.navigate(['/workers']);
  }

  goRequest() {
    this.router.navigate(['/requests/new']);
  }
}


============================================================
FILE: C:\Users\rdari\Downloads\siph-frontend-master\siph-frontend-master\src\app\features\requests\my-requests\my-requests.component.html
============================================================
<p>my-requests works!</p>


============================================================
FILE: C:\Users\rdari\Downloads\siph-frontend-master\siph-frontend-master\src\app\features\requests\my-requests\my-requests.component.ts
============================================================
import { Component } from '@angular/core';

@Component({
  selector: 'app-my-requests',
  imports: [],
  templateUrl: './my-requests.component.html',
  styleUrl: './my-requests.component.scss'
})
export class MyRequestsComponent {

}


============================================================
FILE: C:\Users\rdari\Downloads\siph-frontend-master\siph-frontend-master\src\app\features\requests\request-create\request-create.component.html
============================================================
<p>request-create works!</p>


============================================================
FILE: C:\Users\rdari\Downloads\siph-frontend-master\siph-frontend-master\src\app\features\requests\request-create\request-create.component.ts
============================================================
import { Component } from '@angular/core';

@Component({
  selector: 'app-request-create',
  imports: [],
  templateUrl: './request-create.component.html',
  styleUrl: './request-create.component.scss'
})
export class RequestCreateComponent {

}


============================================================
FILE: C:\Users\rdari\Downloads\siph-frontend-master\siph-frontend-master\src\app\features\requests\request-status-badge\request-status-badge.component.html
============================================================
<p>request-status-badge works!</p>


============================================================
FILE: C:\Users\rdari\Downloads\siph-frontend-master\siph-frontend-master\src\app\features\requests\request-status-badge\request-status-badge.component.ts
============================================================
import { Component } from '@angular/core';

@Component({
  selector: 'app-request-status-badge',
  imports: [],
  templateUrl: './request-status-badge.component.html',
  styleUrl: './request-status-badge.component.scss'
})
export class RequestStatusBadgeComponent {

}


============================================================
FILE: C:\Users\rdari\Downloads\siph-frontend-master\siph-frontend-master\src\app\features\reviews\review-create\review-create.component.html
============================================================
<p>review-create works!</p>


============================================================
FILE: C:\Users\rdari\Downloads\siph-frontend-master\siph-frontend-master\src\app\features\reviews\review-create\review-create.component.ts
============================================================
import { Component } from '@angular/core';

@Component({
  selector: 'app-review-create',
  imports: [],
  templateUrl: './review-create.component.html',
  styleUrl: './review-create.component.scss'
})
export class ReviewCreateComponent {

}


============================================================
FILE: C:\Users\rdari\Downloads\siph-frontend-master\siph-frontend-master\src\app\features\reviews\review-list\review-list.component.html
============================================================
<p>review-list works!</p>


============================================================
FILE: C:\Users\rdari\Downloads\siph-frontend-master\siph-frontend-master\src\app\features\reviews\review-list\review-list.component.ts
============================================================
import { Component } from '@angular/core';

@Component({
  selector: 'app-review-list',
  imports: [],
  templateUrl: './review-list.component.html',
  styleUrl: './review-list.component.scss'
})
export class ReviewListComponent {

}


============================================================
FILE: C:\Users\rdari\Downloads\siph-frontend-master\siph-frontend-master\src\app\features\worker-applications\admin-list\worker-applications-admin\worker-applications-admin.component.html
============================================================
<main class="page">
  <header class="head">
    <div class="head__left">
      <div class="pill">Admin</div>
      <h1>Solicitudes de tÃ©cnico</h1>
      <p class="muted">
        Revisa las postulaciones. Al <b>aprobar</b>, el usuario pasa a rol
        <b>WORKER</b>.
      </p>
    </div>

    <div class="head__right">
      <label class="field">
        <span class="field__label">Filtrar</span>
        <select
          class="select"
          name="statusFilter"
          [(ngModel)]="statusFilter"
          (change)="onFilterChange()"
        >
          <option value="ALL">Todos</option>
          <option value="PENDING">Pendientes</option>
          <option value="APPROVED">Aprobados</option>
          <option value="REJECTED">Rechazados</option>
        </select>
      </label>

      <button class="btn btn--ghost" type="button" (click)="load()" [disabled]="loading">
        {{ loading ? 'Cargandoâ€¦' : 'Actualizar' }}
      </button>
    </div>
  </header>

  <div class="alert alert--error" *ngIf="errorMsg">{{ errorMsg }}</div>
  <div class="alert alert--ok" *ngIf="toastMsg">{{ toastMsg }}</div>

  <section class="card" *ngIf="!loading; else loadingTpl">
    <div class="empty" *ngIf="apps.length === 0">
      <div class="empty__icon">ðŸ§°</div>
      <h3>No hay solicitudes</h3>
      <p class="muted">Cuando un usuario aplique, aparecerÃ¡ aquÃ­.</p>
    </div>

    <div class="tableWrap" *ngIf="apps.length > 0">
      <table class="table">
        <thead>
          <tr>
            <th>Usuario</th>
            <th>Perfil</th>
            <th>Estado</th>
            <th>Notas</th>
            <th class="colActions">Acciones</th>
          </tr>
        </thead>

        <tbody>
          <tr *ngFor="let app of apps; trackBy: trackById">
            <td>
              <div class="user">
                <div class="avatar">{{ userName(app).slice(0, 1) }}</div>
                <div class="user__meta">
                  <div class="user__name">{{ userName(app) }}</div>
                  <div class="user__sub muted">{{ app.user?.email }}</div>
                </div>
              </div>
            </td>

            <td>
              <div class="profile">
                <div class="profile__main">
                  <div class="profile__title">
                    {{ app.specialty || 'â€”' }}
                  </div>
                  <div class="profile__sub muted">
                    {{ app.city || 'Ciudad no indicada' }}
                    <span class="dot">â€¢</span>
                    {{ (app.years_experience ?? 0) + ' aÃ±os' }}
                  </div>
                </div>
                <div class="profile__bio muted">
                  {{ app.bio || 'Sin descripciÃ³n.' }}
                </div>
              </div>
            </td>

            <td>
              <div [class]="badgeClass(app.status)">
                {{ badgeText(app.status) }}
              </div>
              <div class="muted small">
                Actualizado: {{ app.updated_at | date : 'medium' }}
              </div>
            </td>

            <td>
              <textarea
                class="textarea"
                rows="3"
                [name]="'notes_' + app.id"
                [(ngModel)]="notesById[app.id]"
                placeholder="Escribe una nota para el usuario (opcional)â€¦"
              ></textarea>
            </td>

            <td class="colActions">
              <div class="actions">
                <button
                  class="btn btn--ok"
                  type="button"
                  (click)="decide(app, 'APPROVE')"
                  [disabled]="busyById[app.id] || loading"
                >
                  {{ busyById[app.id] ? 'Procesandoâ€¦' : 'Aprobar' }}
                </button>

                <button
                  class="btn btn--bad"
                  type="button"
                  (click)="decide(app, 'REJECT')"
                  [disabled]="busyById[app.id] || loading"
                >
                  {{ busyById[app.id] ? 'Procesandoâ€¦' : 'Rechazar' }}
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </section>

  <ng-template #loadingTpl>
    <section class="card">
      <div class="skeleton">
        <div class="bar"></div>
        <div class="bar"></div>
        <div class="bar"></div>
      </div>
    </section>
  </ng-template>
</main>


============================================================
FILE: C:\Users\rdari\Downloads\siph-frontend-master\siph-frontend-master\src\app\features\worker-applications\admin-list\worker-applications-admin\worker-applications-admin.component.ts
============================================================
import { Component, OnInit } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FormsModule } from '@angular/forms';

import {
  WorkerApplicationService,
  AdminWorkerApplication,
  WorkerAppStatus,
} from '../../../../core/services/worker-application.service';

type FilterStatus = WorkerAppStatus | 'ALL';
type Decision = 'APPROVE' | 'REJECT';

@Component({
  selector: 'app-worker-applications-admin',
  standalone: true,
  imports: [CommonModule, FormsModule],
  templateUrl: './worker-applications-admin.component.html',
  styleUrl: './worker-applications-admin.component.scss',
})
export class WorkerApplicationsAdminComponent implements OnInit {
  apps: AdminWorkerApplication[] = [];

  loading = false;
  errorMsg = '';
  toastMsg = '';

  statusFilter: FilterStatus = 'ALL';

  // notas por solicitud (textarea)
  notesById: Record<number, string> = {};

  // loading por fila (approve/reject)
  busyById: Record<number, boolean> = {};

  constructor(private api: WorkerApplicationService) {}

  ngOnInit(): void {
    this.load();
  }

  load(): void {
    this.loading = true;
    this.errorMsg = '';
    this.toastMsg = '';

    const status = this.statusFilter === 'ALL' ? undefined : this.statusFilter;

    this.api.adminList(status).subscribe({
      next: (data) => {
        this.apps = data ?? [];

        // precarga notas actuales si existen
        for (const a of this.apps) {
          if (this.notesById[a.id] == null) {
            this.notesById[a.id] = a.admin_notes ?? '';
          }
        }

        this.loading = false;
      },
      error: (err) => {
        this.loading = false;
        this.errorMsg =
          err?.error?.detail ||
          'No se pudieron cargar las solicitudes. Revisa el backend y tu sesiÃ³n.';
      },
    });
  }

  onFilterChange(): void {
    this.load();
  }

  decide(app: AdminWorkerApplication, decision: Decision): void {
    if (!app?.id) return;

    this.toastMsg = '';
    this.errorMsg = '';
    this.busyById[app.id] = true;

    const notes = (this.notesById[app.id] || '').trim();

    // âœ… AQUÃ estÃ¡ la correcciÃ³n: SOLO 2 argumentos (appId + payload)
    this.api
      .adminDecide(app.id, {
        decision,
        admin_notes: notes || undefined,
      })
      .subscribe({
        next: (updated) => {
          // reemplazar en lista
          const idx = this.apps.findIndex((x) => x.id === app.id);
          if (idx >= 0) this.apps[idx] = updated;

          // sincronizar notas guardadas
          this.notesById[app.id] = updated.admin_notes ?? notes ?? '';

          this.busyById[app.id] = false;
          this.toastMsg =
            decision === 'APPROVE'
              ? 'âœ… Solicitud aprobada (el usuario pasa a WORKER).'
              : 'âœ… Solicitud rechazada.';
        },
        error: (err) => {
          this.busyById[app.id] = false;
          this.errorMsg =
            err?.error?.detail ||
            'No se pudo tomar la decisiÃ³n. Verifica permisos y el endpoint.';
        },
      });
  }

  badgeClass(status: WorkerAppStatus): string {
    switch (status) {
      case 'APPROVED':
        return 'badge badge--ok';
      case 'REJECTED':
        return 'badge badge--bad';
      default:
        return 'badge badge--wait';
    }
  }

  badgeText(status: WorkerAppStatus): string {
    switch (status) {
      case 'APPROVED':
        return 'Aprobado';
      case 'REJECTED':
        return 'Rechazado';
      default:
        return 'Pendiente';
    }
  }

  userName(app: AdminWorkerApplication): string {
    const u: any = app?.user ?? {};
    const fn = (u.first_name ?? u.firstName ?? '').toString().trim();
    const ln = (u.last_name ?? u.lastName ?? '').toString().trim();
    const full = `${fn} ${ln}`.trim();
    return full || (u.email ?? 'Usuario');
  }

  trackById(_: number, item: AdminWorkerApplication): number {
    return item.id;
  }
}


============================================================
FILE: C:\Users\rdari\Downloads\siph-frontend-master\siph-frontend-master\src\app\features\worker-applications\apply\worker-apply\worker-apply.component.html
============================================================
<!-- src/app/features/worker-applications/apply/worker-apply/worker-apply.component.html -->

<main
  class="relative min-h-[calc(100vh-70px)] overflow-hidden bg-gradient-to-b from-slate-50 via-indigo-50/40 to-slate-50"
>
  <!-- Premium background layer (blobs + grid) -->
  <div aria-hidden="true" class="pointer-events-none absolute inset-0">
    <div
      class="absolute -top-24 left-[-10%] h-[520px] w-[520px] rounded-full bg-rose-500/15 blur-3xl"
    ></div>
    <div
      class="absolute -top-20 right-[-12%] h-[520px] w-[520px] rounded-full bg-indigo-500/15 blur-3xl"
    ></div>
    <div
      class="absolute -bottom-28 left-[25%] h-[560px] w-[560px] rounded-full bg-fuchsia-500/10 blur-3xl"
    ></div>

    <div
      class="absolute inset-0 opacity-[0.18]"
      style="
        background-image:
          linear-gradient(to right, rgba(15,23,42,0.12) 1px, transparent 1px),
          linear-gradient(to bottom, rgba(15,23,42,0.10) 1px, transparent 1px);
        background-size: 56px 56px;
        mask-image: radial-gradient(circle at 20% 10%, rgba(0,0,0,1), rgba(0,0,0,0.2) 55%, transparent 75%);
      "
    ></div>
  </div>

  <section class="relative z-10 mx-auto w-full max-w-6xl px-4 py-8 sm:px-6 lg:px-8 lg:py-10">
    <!-- HERO / HEADER (glass) -->
    <header
      class="relative overflow-hidden rounded-3xl border border-slate-200/70 bg-white/70 p-5 shadow-[0_30px_90px_rgba(2,6,23,0.14)] backdrop-blur-xl sm:p-6"
    >
      <div
        aria-hidden="true"
        class="pointer-events-none absolute inset-0 opacity-90"
        style="
          background:
            radial-gradient(520px 180px at 14% 25%, rgba(255,27,45,0.16), transparent 60%),
            radial-gradient(560px 220px at 88% 30%, rgba(79,70,229,0.12), transparent 62%);
        "
      ></div>

      <div class="relative z-10 flex flex-col gap-4 sm:flex-row sm:items-end sm:justify-between">
        <div class="min-w-0">
          <div
            class="inline-flex items-center gap-2 rounded-full border border-rose-600/20 bg-rose-600/10 px-3 py-1 text-[12px] font-extrabold tracking-wide text-rose-900"
          >
            ðŸ§‘â€ðŸ”§ Solicitud de tÃ©cnico
          </div>

          <h1 class="mt-3 text-2xl font-black tracking-tight text-slate-900 sm:text-4xl">
            Trabajar como tÃ©cnico
            <span class="ml-2 align-middle text-sm font-extrabold text-slate-500 sm:text-base">
              (proceso guiado)
            </span>
          </h1>

          <p class="mt-2 max-w-3xl text-sm font-semibold leading-relaxed text-slate-600 sm:text-[15px]">
            Completa tu perfil y verifica documentos por niveles.
            <span class="font-extrabold text-slate-800">Los documentos nunca se publican.</span>
            Solo se publican: nombre (y foto opcional), zona, categorÃ­as e insignia.
          </p>

          <div class="mt-4 flex flex-wrap gap-2">
            <span class="rounded-full border border-slate-200 bg-white/70 px-3 py-1 text-xs font-extrabold text-slate-700">
              Privacidad primero
            </span>
            <span class="rounded-full border border-slate-200 bg-white/70 px-3 py-1 text-xs font-extrabold text-slate-700">
              VerificaciÃ³n escalonada
            </span>
            <span class="rounded-full border border-slate-200 bg-white/70 px-3 py-1 text-xs font-extrabold text-slate-700">
              Sin exposiciÃ³n de documentos
            </span>
          </div>
        </div>

        <div class="flex items-center gap-2 sm:justify-end">
          <button
            type="button"
            (click)="reloadAll()"
            [disabled]="loading"
            class="group inline-flex h-11 items-center gap-2 rounded-2xl border border-rose-600/25 bg-white/80 px-4 text-sm font-extrabold text-rose-900 shadow-[0_14px_40px_rgba(2,6,23,0.08)] backdrop-blur transition hover:bg-white focus:outline-none focus:ring-4 focus:ring-rose-500/20 disabled:opacity-70"
          >
            <span
              class="h-2.5 w-2.5 rounded-full bg-slate-300 shadow-[0_0_0_0_rgba(244,63,94,0)] transition"
              [ngClass]="loading ? 'bg-rose-500 shadow-[0_0_0_8px_rgba(244,63,94,0.16)] animate-pulse' : ''"
            ></span>
            {{ loading ? 'Actualizandoâ€¦' : 'Actualizar' }}
          </button>
        </div>
      </div>
    </header>

    <!-- TOP CARDS -->
    <section class="mt-4 grid gap-3 lg:grid-cols-2">
      <!-- ESTADO ROLE -->
      <div
        *ngIf="currentApp as app"
        class="relative overflow-hidden rounded-3xl border border-slate-200/70 bg-white/70 p-5 shadow-[0_18px_60px_rgba(2,6,23,0.10)] backdrop-blur-xl sm:p-6"
      >
        <div
          aria-hidden="true"
          class="pointer-events-none absolute inset-0 opacity-70"
          style="background: radial-gradient(520px 160px at 12% 20%, rgba(255,27,45,0.10), transparent 60%);"
        ></div>

        <div class="relative z-10 flex items-start justify-between gap-4">
          <div class="min-w-0">
            <h2 class="text-base font-black tracking-tight text-slate-900">
              Estado de tu solicitud (rol)
            </h2>
            <p class="mt-1 text-xs font-bold text-slate-500">
              Actualizado: {{ app.updated_at | date:'medium' }}
            </p>
          </div>

          <!-- Badge (sin TS) -->
          <div
            class="shrink-0 rounded-full border px-3 py-1 text-xs font-extrabold"
            [ngClass]="
              (app.status || '').toUpperCase() === 'APPROVED'
                ? 'border-emerald-600/25 bg-emerald-600/10 text-emerald-900'
                : (app.status || '').toUpperCase() === 'REJECTED'
                  ? 'border-red-600/25 bg-red-600/10 text-red-900'
                  : 'border-amber-600/25 bg-amber-600/10 text-amber-900'
            "
          >
            {{ badgeText(app.status) }}
          </div>
        </div>

        <div class="relative z-10 mt-4 grid gap-4 lg:grid-cols-[1.35fr_.65fr]">
          <div>
            <div *ngIf="app.admin_notes" class="rounded-2xl border border-slate-200 bg-white/70 p-4">
              <div class="text-sm font-black text-slate-900">Notas del admin</div>
              <p class="mt-1 text-sm font-semibold leading-relaxed text-slate-600">
                {{ app.admin_notes }}
              </p>
            </div>

            <div
              *ngIf="(app.status || '').toUpperCase() === 'APPROVED'"
              class="mt-3 rounded-2xl border border-emerald-600/20 bg-emerald-600/10 p-4 text-sm font-extrabold text-emerald-900"
            >
              âœ… Si ya fue aprobada, refresca y verÃ¡s el panel tÃ©cnico en el menÃº.
            </div>
          </div>

          <div class="flex flex-col items-stretch gap-2">
            <button
              type="button"
              (click)="refreshRole()"
              class="inline-flex h-11 items-center justify-center rounded-2xl border border-slate-200 bg-white/80 px-4 text-sm font-extrabold text-slate-800 shadow-sm transition hover:bg-white focus:outline-none focus:ring-4 focus:ring-rose-500/20"
            >
              Refrescar rol
            </button>

            <div class="rounded-2xl border border-slate-200 bg-white/60 p-3 text-xs font-bold leading-relaxed text-slate-500">
              Si no cambia inmediatamente, espera unos segundos y vuelve a actualizar.
            </div>
          </div>
        </div>
      </div>

      <!-- ESTADO VERIFICACIÃ“N -->
      <div
        class="relative overflow-hidden rounded-3xl border border-slate-200/70 bg-white/70 p-5 shadow-[0_18px_60px_rgba(2,6,23,0.10)] backdrop-blur-xl sm:p-6"
      >
        <div
          aria-hidden="true"
          class="pointer-events-none absolute inset-0 opacity-70"
          style="background: radial-gradient(520px 160px at 88% 18%, rgba(79,70,229,0.10), transparent 60%);"
        ></div>

        <div class="relative z-10 flex items-start justify-between gap-4">
          <div class="min-w-0">
            <h2 class="text-base font-black tracking-tight text-slate-900">VerificaciÃ³n de tÃ©cnico</h2>
            <p class="mt-1 text-xs font-bold text-slate-500">
              Escala por niveles (BÃ¡sico â†’ Confianza â†’ Profesional â†’ Pagos)
            </p>
          </div>

          <button
            type="button"
            (click)="goRenew()"
            [disabled]="loading"
            class="inline-flex h-11 items-center justify-center rounded-2xl border border-slate-200 bg-white/80 px-4 text-sm font-extrabold text-slate-800 shadow-sm transition hover:bg-white focus:outline-none focus:ring-4 focus:ring-rose-500/20 disabled:opacity-70"
          >
            Renovar
          </button>
        </div>

        <!-- Level chips -->
        <div class="relative z-10 mt-4 flex flex-wrap gap-2">
          <div
            class="rounded-full border px-3 py-1 text-xs font-extrabold"
            [ngClass]="verification?.currentLevel === 'BASIC'
              ? 'border-rose-600/25 bg-rose-600/10 text-rose-900'
              : 'border-slate-200 bg-white/70 text-slate-600'"
          >
            BÃ¡sico
          </div>
          <div
            class="rounded-full border px-3 py-1 text-xs font-extrabold"
            [ngClass]="verification?.currentLevel === 'TRUST'
              ? 'border-rose-600/25 bg-rose-600/10 text-rose-900'
              : 'border-slate-200 bg-white/70 text-slate-600'"
          >
            Confianza
          </div>
          <div
            class="rounded-full border px-3 py-1 text-xs font-extrabold"
            [ngClass]="verification?.currentLevel === 'PRO'
              ? 'border-rose-600/25 bg-rose-600/10 text-rose-900'
              : 'border-slate-200 bg-white/70 text-slate-600'"
          >
            Profesional
          </div>
          <div
            class="rounded-full border px-3 py-1 text-xs font-extrabold"
            [ngClass]="verification?.currentLevel === 'PAY'
              ? 'border-rose-600/25 bg-rose-600/10 text-rose-900'
              : 'border-slate-200 bg-white/70 text-slate-600'"
          >
            Pagos
          </div>
        </div>

        <!-- Status line -->
        <div *ngIf="verification" class="relative z-10 mt-4 flex flex-wrap items-center gap-3">
          <div
            class="rounded-full border px-3 py-1 text-xs font-extrabold"
            [ngClass]="
              verification.status === 'VERIFIED'
                ? 'border-emerald-600/25 bg-emerald-600/10 text-emerald-900'
                : verification.status === 'REJECTED'
                  ? 'border-red-600/25 bg-red-600/10 text-red-900'
                  : verification.status === 'IN_REVIEW'
                    ? 'border-amber-600/25 bg-amber-600/10 text-amber-900'
                    : 'border-slate-200 bg-white/70 text-slate-700'
            "
          >
            {{ verifBadgeText(verification.status) }}
          </div>

          <div class="grid gap-1 text-xs font-bold text-slate-500">
            <div *ngIf="verification.verifiedAt">Verificado: {{ verification.verifiedAt | date:'mediumDate' }}</div>
            <div *ngIf="verification.expiresAt">Vence: {{ verification.expiresAt | date:'mediumDate' }}</div>
            <div *ngIf="verification.reason">Motivo: {{ verification.reason }}</div>
          </div>
        </div>

        <div class="relative z-10 mt-4 rounded-2xl border border-slate-200 bg-white/70 p-4">
          <div class="text-sm font-black text-slate-900">
            Nivel recomendado:
            <span class="ml-2 inline-flex rounded-full border border-rose-600/20 bg-rose-600/10 px-3 py-1 text-xs font-extrabold text-rose-900">
              {{ recommendedLevelLabel }}
            </span>
          </div>
          <div class="mt-1 text-xs font-bold text-slate-500">
            (segÃºn categorÃ­as/actividades y si quieres pagos)
          </div>
        </div>
      </div>
    </section>

    <!-- ALERTAS -->
    <div
      *ngIf="saved"
      class="mt-4 rounded-2xl border border-emerald-600/20 bg-emerald-600/10 p-4 text-sm font-extrabold text-emerald-900 shadow-sm"
    >
      âœ… Guardado y enviado. Queda en revisiÃ³n.
    </div>

    <div
      *ngIf="error"
      class="mt-4 rounded-2xl border border-red-600/20 bg-red-600/10 p-4 text-sm font-extrabold text-red-900 shadow-sm"
    >
      {{ error }}
    </div>

    <!-- WIZARD -->
    <section
      class="mt-4 overflow-hidden rounded-3xl border border-slate-200/70 bg-white/70 p-5 shadow-[0_30px_90px_rgba(2,6,23,0.12)] backdrop-blur-xl sm:p-6"
    >
      <!-- Top (title + progress + steps) -->
      <div class="flex flex-col gap-4 border-b border-slate-200/70 pb-4">
        <div class="flex flex-col gap-1">
          <div class="text-xs font-extrabold tracking-wide text-slate-500">Progreso</div>
          <div class="text-sm font-black text-slate-900">Completa los pasos</div>
        </div>

        <div class="h-2.5 overflow-hidden rounded-full border border-slate-200 bg-slate-100">
          <div
            class="h-full rounded-full bg-gradient-to-r from-rose-600 to-indigo-600 shadow-[0_16px_34px_rgba(79,70,229,0.18)] transition-all duration-300"
            [style.width.%]="(step - 1) * 25"
          ></div>
        </div>

        <!-- Steps (scroll on mobile) -->
        <div class="flex gap-2 overflow-x-auto pb-1">
          <div
            class="flex min-w-[150px] items-center gap-3 rounded-2xl border px-3 py-2 transition"
            [ngClass]="step===1
              ? 'border-rose-600/25 bg-rose-600/10'
              : step>1
                ? 'border-emerald-600/25 bg-emerald-600/10'
                : 'border-slate-200 bg-white/70 opacity-80'"
          >
            <div
              class="grid h-8 w-8 place-items-center rounded-full border text-xs font-black"
              [ngClass]="step>1 ? 'border-emerald-600/25 bg-white/70 text-emerald-900' : 'border-slate-200 bg-white/70 text-slate-800'"
            >
              1
            </div>
            <div class="truncate text-xs font-extrabold text-slate-900">Cuenta</div>
          </div>

          <div
            class="flex min-w-[150px] items-center gap-3 rounded-2xl border px-3 py-2 transition"
            [ngClass]="step===2
              ? 'border-rose-600/25 bg-rose-600/10'
              : step>2
                ? 'border-emerald-600/25 bg-emerald-600/10'
                : 'border-slate-200 bg-white/70 opacity-80'"
          >
            <div
              class="grid h-8 w-8 place-items-center rounded-full border text-xs font-black"
              [ngClass]="step>2 ? 'border-emerald-600/25 bg-white/70 text-emerald-900' : 'border-slate-200 bg-white/70 text-slate-800'"
            >
              2
            </div>
            <div class="truncate text-xs font-extrabold text-slate-900">Perfil</div>
          </div>

          <div
            class="flex min-w-[150px] items-center gap-3 rounded-2xl border px-3 py-2 transition"
            [ngClass]="step===3
              ? 'border-rose-600/25 bg-rose-600/10'
              : step>3
                ? 'border-emerald-600/25 bg-emerald-600/10'
                : 'border-slate-200 bg-white/70 opacity-80'"
          >
            <div
              class="grid h-8 w-8 place-items-center rounded-full border text-xs font-black"
              [ngClass]="step>3 ? 'border-emerald-600/25 bg-white/70 text-emerald-900' : 'border-slate-200 bg-white/70 text-slate-800'"
            >
              3
            </div>
            <div class="truncate text-xs font-extrabold text-slate-900">Docs</div>
          </div>

          <div
            class="flex min-w-[150px] items-center gap-3 rounded-2xl border px-3 py-2 transition"
            [ngClass]="step===4
              ? 'border-rose-600/25 bg-rose-600/10'
              : step>4
                ? 'border-emerald-600/25 bg-emerald-600/10'
                : 'border-slate-200 bg-white/70 opacity-80'"
          >
            <div
              class="grid h-8 w-8 place-items-center rounded-full border text-xs font-black"
              [ngClass]="step>4 ? 'border-emerald-600/25 bg-white/70 text-emerald-900' : 'border-slate-200 bg-white/70 text-slate-800'"
            >
              4
            </div>
            <div class="truncate text-xs font-extrabold text-slate-900">VerificaciÃ³n</div>
          </div>

          <div
            class="flex min-w-[150px] items-center gap-3 rounded-2xl border px-3 py-2 transition"
            [ngClass]="step===5 ? 'border-rose-600/25 bg-rose-600/10' : 'border-slate-200 bg-white/70 opacity-80'"
          >
            <div class="grid h-8 w-8 place-items-center rounded-full border border-slate-200 bg-white/70 text-xs font-black text-slate-800">
              5
            </div>
            <div class="truncate text-xs font-extrabold text-slate-900">Estado</div>
          </div>
        </div>
      </div>

      <!-- STEP 1 -->
      <section *ngIf="step===1" class="pt-5">
        <div class="flex items-baseline justify-between gap-3">
          <h3 class="text-base font-black text-slate-900">Cuenta</h3>
          <div class="text-xs font-extrabold text-slate-500">Paso 1 de 5</div>
        </div>

        <p class="mt-2 text-sm font-semibold text-slate-600">
          Usaremos tu cuenta para contactarte. Puedes continuar.
        </p>

        <div class="mt-4 grid gap-3 sm:grid-cols-2">
          <div class="rounded-2xl border border-slate-200 bg-white/70 p-4">
            <div class="text-xs font-extrabold text-slate-500">Correo</div>
            <div class="mt-1 text-sm font-black text-slate-900">{{ userEmail || 'â€”' }}</div>
          </div>
          <div class="rounded-2xl border border-slate-200 bg-white/70 p-4">
            <div class="text-xs font-extrabold text-slate-500">Rol actual</div>
            <div class="mt-1 text-sm font-black text-slate-900">{{ role }}</div>
          </div>
        </div>

        <div class="mt-5 flex justify-end">
          <button
            type="button"
            (click)="next()"
            class="inline-flex h-11 items-center justify-center rounded-2xl bg-gradient-to-br from-rose-600 to-rose-800 px-5 text-sm font-extrabold text-white shadow-[0_18px_60px_rgba(244,63,94,0.22)] transition hover:brightness-[1.03] focus:outline-none focus:ring-4 focus:ring-rose-500/20"
          >
            Continuar
          </button>
        </div>
      </section>

      <!-- STEP 2 -->
      <section *ngIf="step===2" class="pt-5">
        <div class="flex items-baseline justify-between gap-3">
          <h3 class="text-base font-black text-slate-900">Perfil pÃºblico y privado</h3>
          <div class="text-xs font-extrabold text-slate-500">Paso 2 de 5</div>
        </div>

        <!-- Callout -->
        <div class="mt-3 rounded-2xl border border-indigo-200 bg-indigo-50/70 p-4">
          <div class="text-sm font-black text-slate-900">Visibilidad</div>
          <div class="mt-2 grid gap-2 text-sm font-semibold text-slate-700 sm:grid-cols-2">
            <div><span class="font-black">Se publica:</span> nombre, foto opcional, zona (ciudad/radio), categorÃ­as, insignia.</div>
            <div><span class="font-black">Privado (Verificador/Admin):</span> documento, telÃ©fono, correo y archivos.</div>
          </div>
        </div>

        <form class="mt-4 grid gap-4 md:grid-cols-2" [formGroup]="form">
          <!-- pÃºblico -->
          <label class="grid gap-2">
            <span class="text-sm font-extrabold text-slate-800">Nombre pÃºblico *</span>
            <input
              type="text"
              formControlName="public_name"
              placeholder="Ej: Juan PÃ©rez"
              class="h-12 w-full rounded-2xl border border-slate-200 bg-white/80 px-4 text-sm font-semibold text-slate-900 placeholder:text-slate-400 shadow-sm outline-none transition focus:border-rose-400 focus:ring-4 focus:ring-rose-500/20"
            />
            <small *ngIf="t('public_name')" class="text-xs font-extrabold text-red-700">Campo obligatorio.</small>
          </label>

          <label class="grid gap-2">
            <span class="text-sm font-extrabold text-slate-800">Foto (opcional)</span>
            <input
              class="h-12 w-full cursor-pointer rounded-2xl border border-slate-200 bg-white/80 px-4 text-sm font-semibold text-slate-900 shadow-sm outline-none file:mr-3 file:rounded-xl file:border file:border-slate-200 file:bg-white file:px-3 file:py-2 file:text-sm file:font-extrabold file:text-slate-700 hover:file:bg-slate-50 focus:border-rose-400 focus:ring-4 focus:ring-rose-500/20"
              type="file"
              accept="image/*"
              (change)="onPhoto($event)"
            />
            <small class="text-xs font-bold text-slate-500">Se verÃ¡ en tu perfil. No es documento.</small>
            <small class="text-xs font-bold text-slate-600" *ngIf="photoFile">ðŸ“Ž {{ photoFile.name }}</small>
            <small class="text-xs font-extrabold text-red-700" *ngIf="photoError">{{ photoError }}</small>
          </label>

          <label class="grid gap-2">
            <span class="text-sm font-extrabold text-slate-800">Ciudad / Municipio *</span>
            <input
              type="text"
              formControlName="city"
              placeholder="Ej: Barranquilla"
              class="h-12 w-full rounded-2xl border border-slate-200 bg-white/80 px-4 text-sm font-semibold text-slate-900 placeholder:text-slate-400 shadow-sm outline-none transition focus:border-rose-400 focus:ring-4 focus:ring-rose-500/20"
            />
            <small *ngIf="t('city')" class="text-xs font-extrabold text-red-700">Campo obligatorio.</small>
          </label>

          <label class="grid gap-2">
            <span class="text-sm font-extrabold text-slate-800">Radio de atenciÃ³n (km)</span>
            <input
              type="number"
              formControlName="radius_km"
              min="0"
              max="100"
              class="h-12 w-full rounded-2xl border border-slate-200 bg-white/80 px-4 text-sm font-semibold text-slate-900 placeholder:text-slate-400 shadow-sm outline-none transition focus:border-rose-400 focus:ring-4 focus:ring-rose-500/20"
            />
            <small class="text-xs font-bold text-slate-500">Si no sabes, deja 5 km.</small>
          </label>

          <div class="md:col-span-2 grid gap-2">
            <span class="text-sm font-extrabold text-slate-800">CategorÃ­as *</span>
            <div class="flex flex-wrap gap-2">
              <button
                type="button"
                *ngFor="let c of CATEGORIES"
                (click)="toggleCategory(c)"
                class="rounded-full border px-4 py-2 text-sm font-extrabold transition focus:outline-none focus:ring-4 focus:ring-rose-500/20"
                [ngClass]="hasCategory(c)
                  ? 'border-rose-600/25 bg-rose-600 text-white shadow-[0_18px_50px_rgba(244,63,94,0.18)]'
                  : 'border-slate-200 bg-white/80 text-slate-800 hover:bg-white'"
              >
                {{ c }}
              </button>
            </div>
            <small *ngIf="categoriesError" class="text-xs font-extrabold text-red-700">Selecciona al menos una categorÃ­a.</small>
          </div>

          <div class="md:col-span-2 grid gap-2">
            <span class="text-sm font-extrabold text-slate-800">Actividades que requieren certificaciÃ³n (marca si aplica)</span>

            <div class="grid gap-3 lg:grid-cols-3">
              <label class="flex cursor-pointer gap-3 rounded-2xl border border-slate-200 bg-white/80 p-4 shadow-sm transition hover:bg-white">
                <input
                  type="checkbox"
                  class="mt-1 h-4 w-4 accent-rose-600"
                  [checked]="hasActivity('ALTURAS')"
                  (change)="toggleActivity('ALTURAS', $event)"
                />
                <span class="block">
                  <b class="block text-sm font-black text-slate-900">Trabajo en alturas</b>
                  <small class="block text-xs font-bold text-slate-500">Requiere certificado si lo realizas.</small>
                </span>
              </label>

              <label class="flex cursor-pointer gap-3 rounded-2xl border border-slate-200 bg-white/80 p-4 shadow-sm transition hover:bg-white">
                <input
                  type="checkbox"
                  class="mt-1 h-4 w-4 accent-rose-600"
                  [checked]="hasActivity('ELECTRICA_CERT')"
                  (change)="toggleActivity('ELECTRICA_CERT', $event)"
                />
                <span class="block">
                  <b class="block text-sm font-black text-slate-900">InstalaciÃ³n elÃ©ctrica certificada</b>
                  <small class="block text-xs font-bold text-slate-500">MatrÃ­cula/soporte equivalente.</small>
                </span>
              </label>

              <label class="flex cursor-pointer gap-3 rounded-2xl border border-slate-200 bg-white/80 p-4 shadow-sm transition hover:bg-white">
                <input
                  type="checkbox"
                  class="mt-1 h-4 w-4 accent-rose-600"
                  [checked]="hasActivity('GAS')"
                  (change)="toggleActivity('GAS', $event)"
                />
                <span class="block">
                  <b class="block text-sm font-black text-slate-900">Gas (instalaciÃ³n / mantenimiento)</b>
                  <small class="block text-xs font-bold text-slate-500">CertificaciÃ³n requerida si aplica.</small>
                </span>
              </label>
            </div>
          </div>

          <!-- Toggle pagos -->
          <div class="md:col-span-2 grid gap-2">
            <span class="text-sm font-extrabold text-slate-800">Â¿Quieres recibir pagos desde la app?</span>
            <div class="inline-flex w-fit rounded-2xl border border-slate-200 bg-slate-100 p-1">
              <button
                type="button"
                class="h-10 rounded-xl px-4 text-sm font-extrabold transition focus:outline-none focus:ring-4 focus:ring-rose-500/20"
                [ngClass]="!wantsPayments ? 'bg-white text-slate-900 shadow-sm' : 'text-slate-600 hover:text-slate-900'"
                (click)="wantsPayments=false"
              >
                No
              </button>
              <button
                type="button"
                class="h-10 rounded-xl px-4 text-sm font-extrabold transition focus:outline-none focus:ring-4 focus:ring-rose-500/20"
                [ngClass]="wantsPayments ? 'bg-gradient-to-br from-rose-600 to-rose-800 text-white shadow-[0_18px_50px_rgba(244,63,94,0.20)]' : 'text-slate-600 hover:text-slate-900'"
                (click)="wantsPayments=true"
              >
                SÃ­
              </button>
            </div>
            <small class="text-xs font-bold text-slate-500">
              Si activas pagos, se solicitarÃ¡n documentos extra (RUT y certificado bancario).
            </small>
          </div>

          <!-- privado -->
          <label class="grid gap-2">
            <span class="text-sm font-extrabold text-slate-800">Tipo de documento *</span>
            <select
              formControlName="doc_type"
              class="h-12 w-full rounded-2xl border border-slate-200 bg-white/80 px-4 text-sm font-semibold text-slate-900 shadow-sm outline-none transition focus:border-rose-400 focus:ring-4 focus:ring-rose-500/20"
            >
              <option value="CC">CC</option>
              <option value="CE">CE</option>
              <option value="TI">TI</option>
              <option value="PP">Pasaporte</option>
            </select>
            <small *ngIf="t('doc_type')" class="text-xs font-extrabold text-red-700">Campo obligatorio.</small>
          </label>

          <label class="grid gap-2">
            <span class="text-sm font-extrabold text-slate-800">NÃºmero de documento *</span>
            <input
              type="text"
              formControlName="doc_number"
              placeholder="Solo nÃºmeros"
              class="h-12 w-full rounded-2xl border border-slate-200 bg-white/80 px-4 text-sm font-semibold text-slate-900 placeholder:text-slate-400 shadow-sm outline-none transition focus:border-rose-400 focus:ring-4 focus:ring-rose-500/20"
            />
            <small *ngIf="t('doc_number')" class="text-xs font-extrabold text-red-700">Revisa el nÃºmero.</small>
          </label>

          <label class="grid gap-2">
            <span class="text-sm font-extrabold text-slate-800">TelÃ©fono *</span>
            <input
              type="text"
              formControlName="phone"
              placeholder="Ej: +57 300 123 4567"
              class="h-12 w-full rounded-2xl border border-slate-200 bg-white/80 px-4 text-sm font-semibold text-slate-900 placeholder:text-slate-400 shadow-sm outline-none transition focus:border-rose-400 focus:ring-4 focus:ring-rose-500/20"
            />
            <small *ngIf="t('phone')" class="text-xs font-extrabold text-red-700">Revisa el telÃ©fono.</small>
          </label>

          <label class="grid gap-2">
            <span class="text-sm font-extrabold text-slate-800">Correo</span>
            <input
              type="text"
              [value]="userEmail"
              disabled
              class="h-12 w-full rounded-2xl border border-slate-200 bg-white/60 px-4 text-sm font-semibold text-slate-700 shadow-sm outline-none"
            />
            <small class="text-xs font-bold text-slate-500">Lo toma de tu cuenta.</small>
          </label>

          <!-- perfil tÃ©cnico -->
          <label class="grid gap-2">
            <span class="text-sm font-extrabold text-slate-800">Especialidad principal *</span>
            <input
              type="text"
              formControlName="specialty"
              placeholder="Ej: Electricidad, PlomerÃ­aâ€¦"
              class="h-12 w-full rounded-2xl border border-slate-200 bg-white/80 px-4 text-sm font-semibold text-slate-900 placeholder:text-slate-400 shadow-sm outline-none transition focus:border-rose-400 focus:ring-4 focus:ring-rose-500/20"
            />
            <small *ngIf="t('specialty')" class="text-xs font-extrabold text-red-700">Campo obligatorio.</small>
          </label>

          <label class="grid gap-2">
            <span class="text-sm font-extrabold text-slate-800">AÃ±os de experiencia</span>
            <input
              type="number"
              formControlName="years_experience"
              min="0"
              max="60"
              class="h-12 w-full rounded-2xl border border-slate-200 bg-white/80 px-4 text-sm font-semibold text-slate-900 placeholder:text-slate-400 shadow-sm outline-none transition focus:border-rose-400 focus:ring-4 focus:ring-rose-500/20"
            />
          </label>

          <label class="md:col-span-2 grid gap-2">
            <span class="text-sm font-extrabold text-slate-800">DescripciÃ³n / Perfil *</span>
            <textarea
              rows="5"
              formControlName="bio"
              placeholder="CuÃ©ntanos tu experiencia, servicios, disponibilidadâ€¦"
              class="w-full rounded-2xl border border-slate-200 bg-white/80 px-4 py-3 text-sm font-semibold text-slate-900 placeholder:text-slate-400 shadow-sm outline-none transition focus:border-rose-400 focus:ring-4 focus:ring-rose-500/20"
            ></textarea>
            <small *ngIf="t('bio')" class="text-xs font-extrabold text-red-700">MÃ­nimo 20 caracteres.</small>
          </label>

          <!-- consentimientos -->
          <div class="md:col-span-2 grid gap-2">
            <div class="rounded-2xl border border-slate-200 bg-white/70 p-4">
              <label class="flex gap-3">
                <input type="checkbox" formControlName="accept_terms" class="mt-1 h-4 w-4 accent-rose-600" />
                <span class="text-sm font-bold text-slate-700">Acepto TÃ©rminos de uso</span>
              </label>

              <label class="mt-3 flex gap-3">
                <input type="checkbox" formControlName="accept_privacy" class="mt-1 h-4 w-4 accent-rose-600" />
                <span class="text-sm font-bold text-slate-700">Acepto Aviso de Privacidad</span>
              </label>

              <label class="mt-3 flex gap-3">
                <input type="checkbox" formControlName="accept_sensitive" class="mt-1 h-4 w-4 accent-rose-600" />
                <span class="text-sm font-bold text-slate-700">
                  Autorizo el tratamiento de datos sensibles para verificaciÃ³n (documentos).
                  <span class="block text-xs font-bold text-slate-500">
                    Sin reconocimiento facial salvo autorizaciÃ³n expresa.
                  </span>
                </span>
              </label>
            </div>

            <small *ngIf="consentsError" class="text-xs font-extrabold text-red-700">
              Debes aceptar TÃ©rminos y Aviso de Privacidad, y autorizar verificaciÃ³n de documentos.
            </small>
          </div>
        </form>

        <div class="mt-5 flex flex-col-reverse gap-2 sm:flex-row sm:justify-end">
          <button
            type="button"
            (click)="prev()"
            class="inline-flex h-11 items-center justify-center rounded-2xl border border-slate-200 bg-white/80 px-5 text-sm font-extrabold text-slate-800 shadow-sm transition hover:bg-white focus:outline-none focus:ring-4 focus:ring-rose-500/20"
          >
            AtrÃ¡s
          </button>

          <button
            type="button"
            (click)="saveProfileAndNext()"
            [disabled]="loading"
            class="inline-flex h-11 items-center justify-center rounded-2xl bg-gradient-to-br from-rose-600 to-rose-800 px-5 text-sm font-extrabold text-white shadow-[0_18px_60px_rgba(244,63,94,0.22)] transition hover:brightness-[1.03] focus:outline-none focus:ring-4 focus:ring-rose-500/20 disabled:opacity-70"
          >
            {{ loading ? 'Guardandoâ€¦' : 'Continuar' }}
          </button>
        </div>
      </section>

      <!-- STEP 3 -->
      <section *ngIf="step===3" class="pt-5">
        <div class="flex items-baseline justify-between gap-3">
          <h3 class="text-base font-black text-slate-900">Documentos</h3>
          <div class="text-xs font-extrabold text-slate-500">Paso 3 de 5</div>
        </div>

        <div class="mt-3 rounded-2xl border border-slate-200 bg-white/70 p-4">
          <div class="flex flex-col gap-2 sm:flex-row sm:items-start sm:justify-between">
            <div class="text-sm font-extrabold text-slate-800">
              <span class="font-black">Reglas rÃ¡pidas</span>: PDF/JPG/PNG â€¢ mÃ¡ximo 5 MB â€¢ documentos nunca pÃºblicos.
            </div>
            <div class="text-xs font-bold text-slate-500 sm:max-w-xl">
              * La foto de identificaciÃ³n se elimina mÃ¡ximo en 30 dÃ­as. Los demÃ¡s se eliminan al finalizar verificaciÃ³n (guardamos solo metadatos).
            </div>
          </div>
        </div>

        <div class="mt-4 grid gap-3">
          <div
            *ngFor="let d of requiredDocs; trackBy: trackDoc"
            class="rounded-3xl border border-slate-200 bg-white/70 p-5 shadow-sm"
          >
            <div class="flex flex-col gap-2 sm:flex-row sm:items-start sm:justify-between">
              <div class="min-w-0">
                <div class="flex flex-wrap items-center gap-2">
                  <b class="text-sm font-black text-slate-900">{{ d.label }}</b>
                  <span
                    *ngIf="d.required"
                    class="rounded-full border border-amber-600/25 bg-amber-600/10 px-3 py-1 text-xs font-extrabold text-amber-900"
                  >
                    Obligatorio
                  </span>
                  <span
                    *ngIf="!d.required"
                    class="rounded-full border border-slate-200 bg-white/70 px-3 py-1 text-xs font-extrabold text-slate-700"
                  >
                    Opcional
                  </span>
                </div>
              </div>

              <div class="text-right text-xs font-bold text-slate-500">
                <div>Acepta: {{ d.accept }}</div>
                <div>MÃ¡x: 5 MB</div>
              </div>
            </div>

            <div class="mt-3 grid gap-3">
              <input
                class="h-12 w-full cursor-pointer rounded-2xl border border-slate-200 bg-white/80 px-4 text-sm font-semibold text-slate-900 shadow-sm outline-none file:mr-3 file:rounded-xl file:border file:border-slate-200 file:bg-white file:px-3 file:py-2 file:text-sm file:font-extrabold file:text-slate-700 hover:file:bg-slate-50 focus:border-rose-400 focus:ring-4 focus:ring-rose-500/20"
                type="file"
                [attr.accept]="d.acceptAttr"
                (change)="onDocFile(d.type, $event)"
              />

              <div
                *ngIf="selectedDocs[d.type] as f"
                class="flex flex-col gap-2 rounded-2xl border border-slate-200 bg-white/70 p-4 sm:flex-row sm:items-center sm:justify-between"
              >
                <span class="inline-flex w-fit rounded-full border border-slate-200 bg-white/70 px-3 py-1 text-xs font-extrabold text-slate-800">
                  ðŸ“Ž {{ f.name }}
                </span>

                <button
                  type="button"
                  (click)="clearDoc(d.type)"
                  class="inline-flex h-10 items-center justify-center rounded-2xl border border-rose-600/25 bg-white/80 px-4 text-sm font-extrabold text-rose-900 transition hover:bg-white focus:outline-none focus:ring-4 focus:ring-rose-500/20"
                >
                  Quitar
                </button>
              </div>

              <div *ngIf="docErrors[d.type]" class="text-xs font-extrabold text-red-700">
                {{ docErrors[d.type] }}
              </div>

              <div *ngIf="d.help" class="text-xs font-bold text-slate-500">
                {{ d.help }}
              </div>

              <ng-container *ngIf="d.extraFields as ef">
                <div *ngIf="ef.length > 0" class="grid gap-3 sm:grid-cols-2">
                  <label class="grid gap-2">
                    <span class="text-xs font-extrabold text-slate-700">{{ ef[0].label }}</span>
                    <input
                      type="text"
                      [value]="extra[ef[0].key] || ''"
                      (input)="setExtra(ef[0].key, $any($event.target).value)"
                      class="h-12 w-full rounded-2xl border border-slate-200 bg-white/80 px-4 text-sm font-semibold text-slate-900 shadow-sm outline-none transition focus:border-rose-400 focus:ring-4 focus:ring-rose-500/20"
                    />
                  </label>

                  <label *ngIf="ef.length > 1" class="grid gap-2">
                    <span class="text-xs font-extrabold text-slate-700">{{ ef[1].label }}</span>
                    <input
                      type="text"
                      [value]="extra[ef[1].key] || ''"
                      (input)="setExtra(ef[1].key, $any($event.target).value)"
                      class="h-12 w-full rounded-2xl border border-slate-200 bg-white/80 px-4 text-sm font-semibold text-slate-900 shadow-sm outline-none transition focus:border-rose-400 focus:ring-4 focus:ring-rose-500/20"
                    />
                  </label>
                </div>
              </ng-container>
            </div>
          </div>
        </div>

        <div class="mt-4 rounded-3xl border border-slate-200 bg-white/70 p-5">
          <h4 class="text-sm font-black text-slate-900">Ayuda: certificados</h4>
          <ul class="mt-2 list-disc pl-5 text-sm font-semibold text-slate-700">
            <li>PolicÃ­a: <span class="text-slate-500">[Enlace: ejemplo_policia]</span></li>
            <li>ProcuradurÃ­a: <span class="text-slate-500">[Enlace: ejemplo_procuraduria]</span></li>
            <li>ContralorÃ­a: <span class="text-slate-500">[Enlace: ejemplo_contraloria]</span></li>
            <li>RNMC: <span class="text-slate-500">[Enlace: ejemplo_rnmc]</span></li>
          </ul>
        </div>

        <div class="mt-5 flex flex-col-reverse gap-2 sm:flex-row sm:justify-end">
          <button
            type="button"
            (click)="prev()"
            class="inline-flex h-11 items-center justify-center rounded-2xl border border-slate-200 bg-white/80 px-5 text-sm font-extrabold text-slate-800 shadow-sm transition hover:bg-white focus:outline-none focus:ring-4 focus:ring-rose-500/20"
          >
            AtrÃ¡s
          </button>

          <button
            type="button"
            (click)="uploadAndSubmit()"
            [disabled]="loading"
            class="inline-flex h-11 items-center justify-center rounded-2xl bg-gradient-to-br from-rose-600 to-rose-800 px-5 text-sm font-extrabold text-white shadow-[0_18px_60px_rgba(244,63,94,0.22)] transition hover:brightness-[1.03] focus:outline-none focus:ring-4 focus:ring-rose-500/20 disabled:opacity-70"
          >
            {{ loading ? 'Subiendoâ€¦' : 'Subir y verificar' }}
          </button>
        </div>
      </section>

      <!-- STEP 4 -->
      <section *ngIf="step===4" class="pt-5">
        <div class="flex items-baseline justify-between gap-3">
          <h3 class="text-base font-black text-slate-900">VerificaciÃ³n</h3>
          <div class="text-xs font-extrabold text-slate-500">Paso 4 de 5</div>
        </div>

        <div *ngIf="verification; else noVerif" class="mt-3 rounded-3xl border border-slate-200 bg-white/70 p-5">
          <div
            class="inline-flex rounded-full border px-3 py-1 text-xs font-extrabold"
            [ngClass]="
              verification.status === 'VERIFIED'
                ? 'border-emerald-600/25 bg-emerald-600/10 text-emerald-900'
                : verification.status === 'REJECTED'
                  ? 'border-red-600/25 bg-red-600/10 text-red-900'
                  : verification.status === 'IN_REVIEW'
                    ? 'border-amber-600/25 bg-amber-600/10 text-amber-900'
                    : 'border-slate-200 bg-white/70 text-slate-700'
            "
          >
            {{ verifBadgeText(verification.status) }}
          </div>

          <p class="mt-3 text-sm font-semibold text-slate-600">
            Si estÃ¡ en revisiÃ³n, no necesitas hacer nada. Te avisaremos si fue aprobado o si falta algo.
          </p>

          <div
            *ngIf="verification.status==='REJECTED' && verification.reason"
            class="mt-3 rounded-2xl border border-red-600/20 bg-red-600/10 p-4 text-sm font-extrabold text-red-900"
          >
            <b>Rechazado:</b> {{ verification.reason }}
          </div>
        </div>

        <ng-template #noVerif>
          <div class="mt-3 rounded-3xl border border-slate-200 bg-white/70 p-5 text-sm font-extrabold text-slate-700">
            AÃºn no has enviado verificaciÃ³n.
          </div>
        </ng-template>

        <div class="mt-5 flex flex-col-reverse gap-2 sm:flex-row sm:justify-end">
          <button
            type="button"
            (click)="prev()"
            class="inline-flex h-11 items-center justify-center rounded-2xl border border-slate-200 bg-white/80 px-5 text-sm font-extrabold text-slate-800 shadow-sm transition hover:bg-white focus:outline-none focus:ring-4 focus:ring-rose-500/20"
          >
            AtrÃ¡s
          </button>

          <button
            type="button"
            (click)="next()"
            class="inline-flex h-11 items-center justify-center rounded-2xl bg-gradient-to-br from-rose-600 to-rose-800 px-5 text-sm font-extrabold text-white shadow-[0_18px_60px_rgba(244,63,94,0.22)] transition hover:brightness-[1.03] focus:outline-none focus:ring-4 focus:ring-rose-500/20"
          >
            Continuar
          </button>
        </div>
      </section>

      <!-- STEP 5 -->
      <section *ngIf="step===5" class="pt-5">
        <div class="flex items-baseline justify-between gap-3">
          <h3 class="text-base font-black text-slate-900">Estado</h3>
          <div class="text-xs font-extrabold text-slate-500">Paso 5 de 5</div>
        </div>

        <div *ngIf="verification" class="mt-3 rounded-3xl border border-slate-200 bg-white/70 p-5">
          <div class="text-sm font-extrabold text-slate-800">
            <b class="font-black">Nivel actual:</b> {{ levelLabel(verification.currentLevel) }}
          </div>
          <div class="mt-1 text-sm font-extrabold text-slate-800">
            <b class="font-black">Estado:</b> {{ verifBadgeText(verification.status) }}
          </div>
          <div class="mt-2 text-xs font-bold text-slate-500" *ngIf="verification.expiresAt">
            Vence: {{ verification.expiresAt | date:'mediumDate' }}
          </div>
        </div>

        <div *ngIf="!verification" class="mt-3 rounded-3xl border border-slate-200 bg-white/70 p-5 text-sm font-extrabold text-slate-700">
          AÃºn no hay verificaciÃ³n. Puedes volver al paso de documentos.
        </div>

        <div class="mt-5 flex flex-col-reverse gap-2 sm:flex-row sm:justify-end">
          <button
            type="button"
            (click)="step=3"
            class="inline-flex h-11 items-center justify-center rounded-2xl border border-slate-200 bg-white/80 px-5 text-sm font-extrabold text-slate-800 shadow-sm transition hover:bg-white focus:outline-none focus:ring-4 focus:ring-rose-500/20"
          >
            Volver a Docs
          </button>

          <button
            type="button"
            (click)="reloadAll()"
            class="inline-flex h-11 items-center justify-center rounded-2xl bg-gradient-to-br from-rose-600 to-rose-800 px-5 text-sm font-extrabold text-white shadow-[0_18px_60px_rgba(244,63,94,0.22)] transition hover:brightness-[1.03] focus:outline-none focus:ring-4 focus:ring-rose-500/20"
          >
            Actualizar
          </button>
        </div>
      </section>
    </section>
  </section>
</main>


============================================================
FILE: C:\Users\rdari\Downloads\siph-frontend-master\siph-frontend-master\src\app\features\worker-applications\apply\worker-apply\worker-apply.component.ts
============================================================
// src/app/features/worker-applications/apply/worker-apply/worker-apply.component.ts

import { Component, inject, OnInit } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FormBuilder, ReactiveFormsModule, Validators } from '@angular/forms';

import { WorkerApplicationService, WorkerApplication } from '../../../../core/services/worker-application.service';
import { AuthService } from '../../../../core/services/auth.service';
import { StorageService } from '../../../../core/services/storage.service';

import {
  TechVerificationService,
  TechVerificationMe,
  TechLevel,
  TechStatus,
  DocType,
} from '../../../../core/services/tech-verification.service';

type Activity = 'ALTURAS' | 'ELECTRICA_CERT' | 'GAS';

type DocUI = {
  type: DocType;
  label: string;
  required: boolean;
  accept: string;
  acceptAttr: string;
  help?: string;
  extraFields?: { key: string; label: string }[];
};

@Component({
  selector: 'app-worker-apply',
  standalone: true,
  imports: [CommonModule, ReactiveFormsModule],
  templateUrl: './worker-apply.component.html',
  styleUrl: './worker-apply.component.scss',
})
export class WorkerApplyComponent implements OnInit {
  private fb = inject(FormBuilder);
  private workerApp = inject(WorkerApplicationService);
  private auth = inject(AuthService);
  private storage = inject(StorageService);
  private verifApi = inject(TechVerificationService);

  // wizard
  step = 1;

  loading = false;
  error = '';
  saved = false;

  currentApp: WorkerApplication | null = null;
  verification: TechVerificationMe | null = null;

  photoFile: File | null = null;
  photoError = '';

  // docs (âœ… File inputs)
  selectedDocs: Partial<Record<DocType, File | null>> = {};
  docErrors: Partial<Record<DocType, string>> = {};
  extra: Record<string, string> = {};

  // categorÃ­as y actividades
  readonly CATEGORIES = [
    'Electricidad',
    'PlomerÃ­a',
    'CarpinterÃ­a',
    'Aires acondicionados',
    'Pintura',
    'Gas',
    'ElectrodomÃ©sticos',
    'HerrerÃ­a',
    'JardinerÃ­a',
    'Techos',
  ] as const;

  categories: string[] = [];
  activities: Activity[] = [];
  wantsPayments = false;

  // formulario (perfil + solicitud)
  form = this.fb.group({
    // pÃºblico
    public_name: ['', [Validators.required, Validators.minLength(3)]],
    city: ['', [Validators.required, Validators.minLength(2)]],
    radius_km: [5, [Validators.min(0), Validators.max(100)]],

    // privado
    doc_type: ['CC', Validators.required],
    doc_number: ['', [Validators.required, Validators.pattern(/^[0-9A-Za-z\-\.]{5,20}$/)]],
    phone: ['', [Validators.required, Validators.minLength(7)]],

    // perfil tÃ©cnico
    specialty: ['', Validators.required],
    years_experience: [0, [Validators.min(0), Validators.max(60)]],
    bio: ['', [Validators.required, Validators.minLength(20)]],

    // consentimientos
    accept_terms: [false, Validators.requiredTrue],
    accept_privacy: [false, Validators.requiredTrue],
    accept_sensitive: [false, Validators.requiredTrue],
  });

  ngOnInit(): void {
    this.reloadAll();
  }

  // âœ… FIX: trackBy para inputs file (evita que se reseteen)
  trackDoc = (_: number, d: DocUI) => d.type;

  // ================== getters UX ==================
  get userEmail(): string {
    return this.storage.getUser()?.email || '';
  }

  get role(): string {
    return (this.storage.getUser()?.role || 'USER').toUpperCase();
  }

  get categoriesError(): boolean {
    return this.step === 2 && this.categories.length === 0;
  }

  get consentsError(): boolean {
    if (this.step !== 2) return false;
    const v = this.form.value;
    return !v.accept_terms || !v.accept_privacy || !v.accept_sensitive;
  }

  get recommendedLevel(): TechLevel {
    if (this.wantsPayments) return 'PAY';
    if (
      this.hasActivity('ALTURAS') ||
      this.hasActivity('GAS') ||
      this.hasActivity('ELECTRICA_CERT') ||
      this.hasCategory('Electricidad') ||
      this.hasCategory('Gas')
    ) {
      return 'PRO';
    }
    return 'TRUST';
  }

  get recommendedLevelLabel(): string {
    return this.levelLabel(this.recommendedLevel);
  }

  get requiredDocs(): DocUI[] {
    const docs: DocUI[] = [];

    // BASIC â€” foto ID
    docs.push({
      type: 'ID_PHOTO',
      label: 'Foto del documento de identidad (frontal)',
      required: true,
      accept: 'JPG / PNG',
      acceptAttr: 'image/png,image/jpeg',
      help: 'Se elimina mÃ¡ximo en 30 dÃ­as. Guardamos solo resultado+fecha.',
    });

    // TRUST â€” antecedentes + referencias opc
    if (this.recommendedLevel !== 'BASIC') {
      docs.push(
        {
          type: 'POLICE_CERT',
          label: 'Certificado de antecedentes (PolicÃ­a)',
          required: true,
          accept: 'PDF / JPG / PNG',
          acceptAttr: 'application/pdf,image/png,image/jpeg',
          help: 'Guardamos solo resultado+fecha (no el archivo). Vigencia sugerida: 6 meses.',
        },
        {
          type: 'PROCURADURIA_CERT',
          label: 'Certificado ProcuradurÃ­a',
          required: true,
          accept: 'PDF / JPG / PNG',
          acceptAttr: 'application/pdf,image/png,image/jpeg',
          help: 'Guardamos solo resultado+fecha. Vigencia sugerida: 6 meses.',
        },
        {
          type: 'RNMC_CERT',
          label: 'RNMC (Medidas Correctivas)',
          required: true,
          accept: 'PDF / JPG / PNG',
          acceptAttr: 'application/pdf,image/png,image/jpeg',
          help: 'Guardamos solo resultado+fecha. Vigencia sugerida: 6 meses.',
        },
        {
          type: 'REFERENCES',
          label: 'Referencias (opcional)',
          required: false,
          accept: 'PDF / JPG / PNG',
          acceptAttr: 'application/pdf,image/png,image/jpeg',
          help: 'Opcional. Puedes subir una carta o foto de referencias.',
        }
      );
    }

    // PRO / PAY â€” licencias/certificados + alturas/gas si aplica
    if (this.recommendedLevel === 'PRO' || this.recommendedLevel === 'PAY') {
      if (this.hasCategory('Electricidad') || this.hasActivity('ELECTRICA_CERT')) {
        docs.push({
          type: 'PRO_LICENSE',
          label: 'MatrÃ­cula profesional (CONTE / COPNIA) o soporte equivalente',
          required: true,
          accept: 'PDF / JPG / PNG',
          acceptAttr: 'application/pdf,image/png,image/jpeg',
          help: 'MinimizaciÃ³n: almacenamos NÂº y fecha; el archivo se elimina al finalizar verificaciÃ³n.',
          extraFields: [
            { key: 'license_number', label: 'NÃºmero de matrÃ­cula (si aplica)' },
            { key: 'license_date', label: 'Fecha de expediciÃ³n (si aplica)' },
          ],
        });
      } else {
        docs.push({
          type: 'STUDY_CERT',
          label: 'Certificado de estudios / competencias (SENA/curso/otro)',
          required: true,
          accept: 'PDF / JPG / PNG',
          acceptAttr: 'application/pdf,image/png,image/jpeg',
          help: 'MinimizaciÃ³n: guardamos solo tipo+fecha; el archivo se elimina al finalizar verificaciÃ³n.',
          extraFields: [{ key: 'study_name', label: 'Nombre del certificado (ej: SENA Electricidad)' }],
        });
      }

      if (this.hasActivity('ALTURAS')) {
        docs.push({
          type: 'HEIGHTS_CERT',
          label: 'Certificado de trabajo en alturas (si aplica)',
          required: true,
          accept: 'PDF / JPG / PNG',
          acceptAttr: 'application/pdf,image/png,image/jpeg',
          help: 'Requerido si marcaste â€œTrabajo en alturasâ€.',
          extraFields: [{ key: 'heights_level', label: 'Nivel (bÃ¡sico/avanzado) (opcional)' }],
        });
      }

      if (this.hasActivity('GAS') || this.hasCategory('Gas')) {
        docs.push({
          type: 'GAS_CERT',
          label: 'CertificaciÃ³n para gas (si aplica)',
          required: true,
          accept: 'PDF / JPG / PNG',
          acceptAttr: 'application/pdf,image/png,image/jpeg',
          help: 'Requerido si realizas instalaciones/mantenimiento de gas.',
        });
      }
    }

    // PAY â€” RUT + banco
    if (this.recommendedLevel === 'PAY') {
      docs.push(
        {
          type: 'RUT',
          label: 'RUT (para pagos)',
          required: true,
          accept: 'PDF / JPG / PNG',
          acceptAttr: 'application/pdf,image/png,image/jpeg',
          help: 'MinimizaciÃ³n: guardamos solo hash/token+fecha; archivo se elimina al finalizar verificaciÃ³n.',
        },
        {
          type: 'BANK_CERT',
          label: 'Certificado bancario (para pagos)',
          required: true,
          accept: 'PDF / JPG / PNG',
          acceptAttr: 'application/pdf,image/png,image/jpeg',
          help: 'MinimizaciÃ³n: guardamos solo hash/token+fecha; archivo se elimina al finalizar verificaciÃ³n.',
        }
      );
    }

    return docs;
  }

  // ================== wizard nav ==================
  next() {
    this.step = Math.min(5, this.step + 1);
  }
  prev() {
    this.step = Math.max(1, this.step - 1);
  }

  goRenew() {
    this.step = 3;
  }

  // ================== UI helpers ==================
  t(name: string): boolean {
    const c = this.form.get(name);
    return !!(c && c.touched && c.invalid);
  }

  hasCategory(c: string) {
    return this.categories.includes(c);
  }
  toggleCategory(c: string) {
    if (this.hasCategory(c)) this.categories = this.categories.filter(x => x !== c);
    else this.categories = [...this.categories, c];
  }

  hasActivity(a: Activity) {
    return this.activities.includes(a);
  }
  toggleActivity(a: Activity, ev: Event) {
    const checked = (ev.target as HTMLInputElement).checked;
    if (checked && !this.hasActivity(a)) this.activities = [...this.activities, a];
    if (!checked && this.hasActivity(a)) this.activities = this.activities.filter(x => x !== a);
  }

  onPhoto(ev: Event) {
    this.photoError = '';
    const input = ev.target as HTMLInputElement;
    const f = input.files?.[0];
    if (!f) return;

    if (f.size > 5 * 1024 * 1024) {
      this.photoFile = null;
      this.photoError = 'Archivo >5 MB';
      return;
    }
    if (!f.type.startsWith('image/')) {
      this.photoFile = null;
      this.photoError = 'Formato no vÃ¡lido';
      return;
    }

    this.photoFile = f;

    // opcional: permitir escoger la misma foto de nuevo
    input.value = '';
  }

  // âœ… FIX: guarda el archivo de forma estable + no se resetea el input
  onDocFile(type: DocType, ev: Event) {
    const input = ev.target as HTMLInputElement;
    const f = input.files?.[0];
    if (!f) return;

    this.docErrors[type] = '';

    const okType =
      f.type === 'application/pdf' ||
      f.type === 'image/png' ||
      f.type === 'image/jpeg';

    if (!okType) {
      this.selectedDocs = { ...this.selectedDocs, [type]: null };
      this.docErrors[type] = 'Formato no vÃ¡lido';
      return;
    }

    if (f.size > 5 * 1024 * 1024) {
      this.selectedDocs = { ...this.selectedDocs, [type]: null };
      this.docErrors[type] = 'Archivo >5 MB';
      return;
    }

    // âœ… CLAVE: nueva referencia -> Angular actualiza la UI siempre
    this.selectedDocs = { ...this.selectedDocs, [type]: f };

    // âœ… permite volver a seleccionar el mismo archivo
    input.value = '';
  }

  clearDoc(type: DocType) {
    const copy = { ...this.selectedDocs };
    delete copy[type];
    this.selectedDocs = copy;

    const errCopy = { ...this.docErrors };
    delete errCopy[type];
    this.docErrors = errCopy;
  }

  setExtra(key: string, value: string) {
    this.extra[key] = value;
  }

  // ================== load / submit ==================
  reloadAll() {
    this.loading = true;
    this.error = '';
    this.saved = false;

    this.loadMine();

    this.verifApi.me().subscribe({
      next: (v) => {
        this.verification = v;
        this.loading = false;
      },
      error: (e) => {
        // 404 es normal si aÃºn no has creado perfil
        this.verification = null;
        this.loading = false;
        if (e?.status !== 404) {
          // opcional: manejar otros errores
        }
      },
    });
  }

  loadMine() {
    this.workerApp.myApplication().subscribe({
      next: (app) => (this.currentApp = app),
      error: (e) => {
        // 404 es normal si aÃºn no has enviado solicitud
        this.currentApp = null;
        if (e?.status !== 404) {
          // opcional: manejar otros errores
        }
      },
    });
  }

  saveProfileAndNext() {
    this.error = '';
    this.saved = false;

    if (this.form.invalid || this.categories.length === 0 || this.consentsError) {
      this.form.markAllAsTouched();
      return;
    }

    this.loading = true;

    const payload = {
      public: {
        name: this.form.value.public_name!,
        city: this.form.value.city!,
        radius_km: Number(this.form.value.radius_km || 0),
        categories: this.categories,
      },
      private: {
        doc_type: this.form.value.doc_type!,
        doc_number: this.form.value.doc_number!,
        phone: this.form.value.phone!,
        email: this.userEmail,
      },
      technician: {
        specialty: this.form.value.specialty!,
        years_experience: Number(this.form.value.years_experience || 0),
        bio: this.form.value.bio!,
        activities: this.activities,
        wants_payments: this.wantsPayments,
        requested_level: this.recommendedLevel,
      },
      consents: {
        terms: !!this.form.value.accept_terms,
        privacy: !!this.form.value.accept_privacy,
        sensitive: !!this.form.value.accept_sensitive,
      },
    };

    this.verifApi.upsertProfile(payload).subscribe({
      next: () => {
        this.loading = false;
        this.next();
      },
      error: (e) => {
        this.loading = false;
        this.error = e?.error?.detail || 'No se pudo guardar el perfil.';
      },
    });
  }

  uploadAndSubmit() {
    this.error = '';
    this.saved = false;

    const required = this.requiredDocs.filter(d => d.required).map(d => d.type);

    // limpiar errores previos obligatorios
    for (const rt of required) this.docErrors[rt] = '';

    for (const rt of required) {
      if (!this.selectedDocs[rt]) {
        this.docErrors[rt] = 'Este documento es obligatorio';
      }
    }
    if (required.some(rt => !!this.docErrors[rt])) return;

    if (!this.form.value.accept_sensitive) {
      this.error = 'Debes autorizar la verificaciÃ³n de documentos.';
      return;
    }

    this.loading = true;

    const queue = [...this.requiredDocs].filter(d => !!this.selectedDocs[d.type]);
    const uploadNext = (i: number) => {
      if (i >= queue.length) {
        this.verifApi.submit({
          targetLevel: this.recommendedLevel,
          extra: this.extra,
        }).subscribe({
          next: (v) => {
            this.verification = v;
            this.saved = true;
            this.loading = false;
            this.step = 4;
          },
          error: (e) => {
            this.loading = false;
            this.error = e?.error?.detail || 'No se pudo enviar a verificaciÃ³n.';
          },
        });
        return;
      }

      const item = queue[i];
      const f = this.selectedDocs[item.type] as File;

      this.verifApi.uploadDoc({
        docType: item.type,
        file: f,
        consent: true,
        extra: this.extra,
      }).subscribe({
        next: () => uploadNext(i + 1),
        error: (e) => {
          this.loading = false;
          this.error = e?.error?.detail || `No se pudo subir ${item.label}.`;
        },
      });
    };

    uploadNext(0);
  }

  refreshRole() {
    this.auth.me().subscribe({
      next: () => this.loadMine(),
      error: () => this.loadMine(),
    });
  }

  // ================== badges ==================
  badgeClass(status: string) {
    const s = (status || '').toUpperCase();
    if (s === 'APPROVED') return 'badge badge--ok';
    if (s === 'REJECTED') return 'badge badge--bad';
    return 'badge badge--wait';
  }
  badgeText(status: string) {
    const s = (status || '').toUpperCase();
    if (s === 'APPROVED') return 'Aprobada';
    if (s === 'REJECTED') return 'Rechazada';
    return 'En revisiÃ³n';
  }

  verifBadgeClass(status: TechStatus) {
    if (status === 'VERIFIED') return 'statusline__badge badge--ok';
    if (status === 'REJECTED') return 'statusline__badge badge--bad';
    if (status === 'IN_REVIEW') return 'statusline__badge badge--wait';
    return 'statusline__badge';
  }
  verifBadgeText(status: TechStatus) {
    if (status === 'VERIFIED') return 'Verificado';
    if (status === 'REJECTED') return 'Rechazado';
    if (status === 'IN_REVIEW') return 'En revisiÃ³n';
    return 'Pendiente';
  }

  levelLabel(level: TechLevel) {
    if (level === 'BASIC') return 'BÃ¡sico';
    if (level === 'TRUST') return 'Confianza';
    if (level === 'PRO') return 'Profesional';
    if (level === 'PAY') return 'Pagos';
    return level as any;
  }
}


============================================================
FILE: C:\Users\rdari\Downloads\siph-frontend-master\siph-frontend-master\src\app\features\workers\worker-card\worker-card.component.html
============================================================
<p>worker-card works!</p>


============================================================
FILE: C:\Users\rdari\Downloads\siph-frontend-master\siph-frontend-master\src\app\features\workers\worker-card\worker-card.component.ts
============================================================
import { Component } from '@angular/core';

@Component({
  selector: 'app-worker-card',
  imports: [],
  templateUrl: './worker-card.component.html',
  styleUrl: './worker-card.component.scss'
})
export class WorkerCardComponent {

}


============================================================
FILE: C:\Users\rdari\Downloads\siph-frontend-master\siph-frontend-master\src\app\features\workers\worker-list\worker-list.component.html
============================================================
<p>worker-list works!</p>


============================================================
FILE: C:\Users\rdari\Downloads\siph-frontend-master\siph-frontend-master\src\app\features\workers\worker-list\worker-list.component.ts
============================================================
import { Component } from '@angular/core';

@Component({
  selector: 'app-worker-list',
  imports: [],
  templateUrl: './worker-list.component.html',
  styleUrl: './worker-list.component.scss'
})
export class WorkerListComponent {

}


============================================================
FILE: C:\Users\rdari\Downloads\siph-frontend-master\siph-frontend-master\src\app\features\workers\worker-profile\worker-profile.component.html
============================================================
<p>worker-profile works!</p>


============================================================
FILE: C:\Users\rdari\Downloads\siph-frontend-master\siph-frontend-master\src\app\features\workers\worker-profile\worker-profile.component.ts
============================================================
import { Component } from '@angular/core';

@Component({
  selector: 'app-worker-profile',
  imports: [],
  templateUrl: './worker-profile.component.html',
  styleUrl: './worker-profile.component.scss'
})
export class WorkerProfileComponent {

}


============================================================
FILE: C:\Users\rdari\Downloads\siph-frontend-master\siph-frontend-master\src\app\features\workers\worker-requests\worker-requests.component.html
============================================================
<p>worker-requests works!</p>


============================================================
FILE: C:\Users\rdari\Downloads\siph-frontend-master\siph-frontend-master\src\app\features\workers\worker-requests\worker-requests.component.ts
============================================================
import { Component } from '@angular/core';

@Component({
  selector: 'app-worker-requests',
  imports: [],
  templateUrl: './worker-requests.component.html',
  styleUrl: './worker-requests.component.scss'
})
export class WorkerRequestsComponent {

}


============================================================
FILE: C:\Users\rdari\Downloads\siph-frontend-master\siph-frontend-master\src\app\shared\components\confirm-dialog\confirm-dialog.component.html
============================================================
<p>confirm-dialog works!</p>


============================================================
FILE: C:\Users\rdari\Downloads\siph-frontend-master\siph-frontend-master\src\app\shared\components\confirm-dialog\confirm-dialog.component.ts
============================================================
import { Component } from '@angular/core';

@Component({
  selector: 'app-confirm-dialog',
  imports: [],
  templateUrl: './confirm-dialog.component.html',
  styleUrl: './confirm-dialog.component.scss'
})
export class ConfirmDialogComponent {

}


============================================================
FILE: C:\Users\rdari\Downloads\siph-frontend-master\siph-frontend-master\src\app\shared\components\footer\footer.component.html
============================================================
<footer class="footer">
  <div class="footer__wrap">
    <!-- Brand -->
    <div class="brand">
      <div class="brand__mark">S</div>
      <div class="brand__text">
        <div class="brand__name">SIPH</div>
        <div class="brand__tag">Servicios inmediatos para el hogar</div>
      </div>
    </div>

    <!-- Links -->
    <nav class="links" aria-label="Enlaces del sitio">
      <a routerLink="/workers">Expertos</a>
      <a routerLink="/requests/new">Solicitar</a>
      <a routerLink="/my-requests">Mis solicitudes</a>
      <a routerLink="/reviews">ReseÃ±as</a>
    </nav>

    <!-- Mini CTA -->
    <div class="actions">
      <a class="pill pill--primary" routerLink="/workers">Explorar</a>
      <a class="pill" routerLink="/requests/new">Crear solicitud</a>
    </div>
  </div>

  <!-- Bottom row -->
  <div class="footer__bottom">
    <div class="footer__bottomWrap">
      <span>Â© {{ year }} SIPH</span>
      <span class="sep"></span>
      <span>Prototipo acadÃ©mico</span>
      <span class="sep"></span>
      <span class="muted">Hecho con Angular + FastAPI</span>
    </div>
  </div>
</footer>


============================================================
FILE: C:\Users\rdari\Downloads\siph-frontend-master\siph-frontend-master\src\app\shared\components\footer\footer.component.ts
============================================================
import { Component } from '@angular/core';
import { RouterLink } from '@angular/router';

@Component({
  selector: 'app-footer',
  standalone: true,
  imports: [RouterLink],
  templateUrl: './footer.component.html',
  styleUrl: './footer.component.scss',
})
export class FooterComponent {
  year = new Date().getFullYear();
}


============================================================
FILE: C:\Users\rdari\Downloads\siph-frontend-master\siph-frontend-master\src\app\shared\components\loading\loading.component.html
============================================================
<p>loading works!</p>


============================================================
FILE: C:\Users\rdari\Downloads\siph-frontend-master\siph-frontend-master\src\app\shared\components\loading\loading.component.ts
============================================================
import { Component } from '@angular/core';

@Component({
  selector: 'app-loading',
  imports: [],
  templateUrl: './loading.component.html',
  styleUrl: './loading.component.scss'
})
export class LoadingComponent {

}


============================================================
FILE: C:\Users\rdari\Downloads\siph-frontend-master\siph-frontend-master\src\app\shared\components\navbar\navbar.component.html
============================================================
<header class="nav" [class.nav--open]="menuOpen">
  <div class="nav__wrap">
    <!-- Brand -->
    <a class="brand" routerLink="/" (click)="closeMenu()">
      <span class="brand__mark">S</span>
      <span class="brand__text">
        SIPH
        <small class="brand__hint">Servicios inmediatos</small>
      </span>
    </a>

    <!-- Desktop links -->
    <nav class="links" aria-label="NavegaciÃ³n principal">
      <div class="links__pill">
        <a class="link" routerLink="/workers" routerLinkActive="isActive" (click)="closeMenu()">
          Expertos
        </a>

        <a
          class="link"
          *ngIf="isAuth"
          routerLink="/dashboard"
          routerLinkActive="isActive"
          (click)="closeMenu()"
        >
          Dashboard
        </a>

        <a
          class="link"
          *ngIf="isAuth && (isUser || isAdmin)"
          routerLink="/requests/new"
          routerLinkActive="isActive"
          (click)="closeMenu()"
        >
          Solicitar
        </a>

        <a
          class="link"
          *ngIf="isAuth && (isUser || isAdmin)"
          routerLink="/my-requests"
          routerLinkActive="isActive"
          (click)="closeMenu()"
        >
          Mis solicitudes
        </a>

        <a
          class="link"
          *ngIf="isAuth && (isUser || isAdmin)"
          routerLink="/reviews"
          routerLinkActive="isActive"
          (click)="closeMenu()"
        >
          ReseÃ±as
        </a>

        <a
          class="link link--accent"
          *ngIf="isAuth && isUser"
          routerLink="/work/apply"
          routerLinkActive="isActive"
          (click)="closeMenu()"
        >
          Trabajar
        </a>

        <a
          class="link link--admin"
          *ngIf="isAuth && isAdmin"
          routerLink="/admin/worker-applications"
          routerLinkActive="isActive"
          (click)="closeMenu()"
        >
          Admin
        </a>
      </div>
    </nav>

    <!-- Actions -->
    <div class="actions">
      <!-- No logueado -->
      <ng-container *ngIf="!isAuth; else loggedBlock">
        <a class="btn btn--ghost" routerLink="/auth/login">Login</a>
        <a class="btn btn--primary" routerLink="/auth/register">Registro</a>
      </ng-container>

      <!-- Logueado -->
      <ng-template #loggedBlock>
        <div class="userBox">
          <button
            class="userPill"
            type="button"
            (click)="toggleUserMenu()"
            [attr.aria-expanded]="userMenuOpen"
            aria-haspopup="menu"
            aria-label="MenÃº de usuario"
          >
            <span class="avatar" aria-hidden="true">{{ initials }}</span>

            <span class="userMeta">
              <span class="userName">
                {{ user?.first_name || 'Usuario' }} {{ user?.last_name || '' }}
              </span>
              <span class="userRole">{{ role }}</span>
            </span>

            <span class="chev" [class.chev--open]="userMenuOpen" aria-hidden="true">â–¾</span>
          </button>

          <div class="userMenu" [class.userMenu--open]="userMenuOpen" role="menu">
            <div class="userMenu__top">
              <div class="userMenu__title">Cuenta</div>
              <div class="userMenu__sub">{{ user?.email || '' }}</div>
            </div>

            <a class="menuItem" routerLink="/dashboard" (click)="closeMenu()" role="menuitem">
              Ir al dashboard
            </a>

            <a
              class="menuItem"
              *ngIf="isAuth && (isUser || isAdmin)"
              routerLink="/my-requests"
              (click)="closeMenu()"
              role="menuitem"
            >
              Mis solicitudes
            </a>

            <a
              class="menuItem"
              *ngIf="isAuth && isUser"
              routerLink="/work/apply"
              (click)="closeMenu()"
              role="menuitem"
            >
              Solicitar trabajar
            </a>

            <a
              class="menuItem"
              *ngIf="isAuth && isAdmin"
              routerLink="/admin/worker-applications"
              (click)="closeMenu()"
              role="menuitem"
            >
              Revisar solicitudes
            </a>

            <div class="menuSep" aria-hidden="true"></div>

            <button type="button" class="menuItem menuItem--danger" (click)="logout()" role="menuitem">
              Cerrar sesiÃ³n
            </button>
          </div>
        </div>
      </ng-template>

      <!-- Mobile toggle -->
      <button
        class="burger"
        [class.burger--open]="menuOpen"
        type="button"
        (click)="toggleMenu()"
        [attr.aria-expanded]="menuOpen"
        aria-controls="mobileMenu"
        aria-label="Abrir menÃº"
      >
        <span></span><span></span><span></span>
      </button>
    </div>
  </div>

  <!-- Backdrop mobile -->
  <div class="backdrop" *ngIf="menuOpen" (click)="closeMenu()" aria-hidden="true"></div>

  <!-- Mobile menu -->
  <div id="mobileMenu" class="mobile" [class.mobile--open]="menuOpen">
    <a class="mLink" routerLink="/workers" (click)="closeMenu()">Expertos</a>
    <a class="mLink" *ngIf="isAuth" routerLink="/dashboard" (click)="closeMenu()">Dashboard</a>

    <a class="mLink" *ngIf="isAuth && (isUser || isAdmin)" routerLink="/requests/new" (click)="closeMenu()">
      Solicitar
    </a>
    <a class="mLink" *ngIf="isAuth && (isUser || isAdmin)" routerLink="/my-requests" (click)="closeMenu()">
      Mis solicitudes
    </a>
    <a class="mLink" *ngIf="isAuth && (isUser || isAdmin)" routerLink="/reviews" (click)="closeMenu()">
      ReseÃ±as
    </a>

    <a class="mLink mLink--accent" *ngIf="isAuth && isUser" routerLink="/work/apply" (click)="closeMenu()">
      Trabajar (Ser tÃ©cnico)
    </a>

    <a class="mLink mLink--admin" *ngIf="isAuth && isAdmin" routerLink="/admin/worker-applications" (click)="closeMenu()">
      Admin â€¢ Solicitudes
    </a>

    <div class="mobile__actions" *ngIf="!isAuth">
      <a class="btn btn--ghost" routerLink="/auth/login" (click)="closeMenu()">Login</a>
      <a class="btn btn--primary" routerLink="/auth/register" (click)="closeMenu()">Registro</a>
    </div>

    <div class="mobile__actions" *ngIf="isAuth">
      <button class="btn btn--ghost" type="button" (click)="logout()">Cerrar sesiÃ³n</button>
    </div>
  </div>
</header>


============================================================
FILE: C:\Users\rdari\Downloads\siph-frontend-master\siph-frontend-master\src\app\shared\components\navbar\navbar.component.ts
============================================================
import { Component, ElementRef, HostListener, inject } from '@angular/core';
import { Router, RouterLink, RouterLinkActive } from '@angular/router';
import { NgIf } from '@angular/common';
import { StorageService } from '../../../core/services/storage.service';

@Component({
  selector: 'app-navbar',
  standalone: true,
  imports: [RouterLink, RouterLinkActive, NgIf],
  templateUrl: './navbar.component.html',
  styleUrls: ['./navbar.component.scss'], // âœ… OJO: styleUrls (no styleUrl)
})
export class NavbarComponent {
  private storage = inject(StorageService);
  private router = inject(Router);
  private el = inject(ElementRef);

  menuOpen = false;
  userMenuOpen = false;

  get isAuth(): boolean {
    return this.storage.isLoggedIn();
  }

  get user() {
    return this.storage.getUser();
  }

  get role(): string {
    return (this.user?.role || 'USER').toUpperCase();
  }

  get isUser(): boolean {
    return this.role === 'USER';
  }

  get isWorker(): boolean {
    return this.role === 'WORKER';
  }

  get isAdmin(): boolean {
    return this.role === 'ADMIN';
  }

  get initials(): string {
    const u = this.user;
    const a = (u?.first_name || 'U').trim().charAt(0).toUpperCase();
    const b = (u?.last_name || '').trim().charAt(0).toUpperCase();
    return (a + b) || 'U';
  }

  toggleMenu() {
    this.menuOpen = !this.menuOpen;
    if (!this.menuOpen) this.userMenuOpen = false;
  }

  closeMenu() {
    this.menuOpen = false;
    this.userMenuOpen = false;
  }

  toggleUserMenu() {
    this.userMenuOpen = !this.userMenuOpen;
  }

  logout() {
    this.storage.clearToken();
    this.closeMenu();
    this.router.navigate(['/auth/login']);
  }

  // âœ… Cierra al hacer click fuera
  @HostListener('document:click', ['$event'])
  onDocClick(ev: MouseEvent) {
    const target = ev.target as Node | null;
    if (!target) return;
    if (!this.el.nativeElement.contains(target)) this.closeMenu();
  }

  // âœ… ESC para cerrar
  @HostListener('document:keydown.escape')
  onEsc() {
    this.closeMenu();
  }
}


============================================================
FILE: C:\Users\rdari\Downloads\siph-frontend-master\siph-frontend-master\src\app\shared\components\not-found\not-found.component.html
============================================================
<p>not-found works!</p>


============================================================
FILE: C:\Users\rdari\Downloads\siph-frontend-master\siph-frontend-master\src\app\shared\components\not-found\not-found.component.ts
============================================================
import { Component } from '@angular/core';

@Component({
  selector: 'app-not-found',
  imports: [],
  templateUrl: './not-found.component.html',
  styleUrl: './not-found.component.scss'
})
export class NotFoundComponent {

}


============================================================
FILE: C:\Users\rdari\Downloads\siph-frontend-master\siph-frontend-master\src\app\app.component.html
============================================================
<div class="app-shell">
  <app-navbar></app-navbar>

  <main class="app-main">
    <router-outlet></router-outlet>
  </main>

  <app-footer></app-footer>
</div>


============================================================
FILE: C:\Users\rdari\Downloads\siph-frontend-master\siph-frontend-master\src\app\app.component.ts
============================================================
  import { Component } from '@angular/core';
  import { RouterOutlet } from '@angular/router';

  import { NavbarComponent } from './shared/components/navbar/navbar.component';
  import { FooterComponent } from './shared/components/footer/footer.component';

  @Component({
    selector: 'app-root',
    standalone: true,
    imports: [RouterOutlet, NavbarComponent, FooterComponent],
    templateUrl: './app.component.html',
    styleUrl: './app.component.scss',
  })
  export class AppComponent {}


============================================================
FILE: C:\Users\rdari\Downloads\siph-frontend-master\siph-frontend-master\src\app\app.config.server.ts
============================================================
import { mergeApplicationConfig, ApplicationConfig } from '@angular/core';
import { provideServerRendering } from '@angular/platform-server';
import { provideServerRouting } from '@angular/ssr';
import { appConfig } from './app.config';
import { serverRoutes } from './app.routes.server';

const serverConfig: ApplicationConfig = {
  providers: [
    provideServerRendering(),
    provideServerRouting(serverRoutes)
  ]
};

export const config = mergeApplicationConfig(appConfig, serverConfig);


============================================================
FILE: C:\Users\rdari\Downloads\siph-frontend-master\siph-frontend-master\src\app\app.config.ts
============================================================
// src/app/app.config.ts
import { ApplicationConfig } from '@angular/core';
import { provideRouter } from '@angular/router';
import { provideHttpClient, withInterceptorsFromDi, HTTP_INTERCEPTORS } from '@angular/common/http';

import { routes } from './app.routes';
import { AuthInterceptor } from './core/interceptors/auth.interceptor'; // ajusta ruta si cambia

export const appConfig: ApplicationConfig = {
  providers: [
    provideRouter(routes),
    provideHttpClient(withInterceptorsFromDi()),

    // âœ… ESTO ES LO QUE TE FALTA
    { provide: HTTP_INTERCEPTORS, useClass: AuthInterceptor, multi: true },
  ],
};


============================================================
FILE: C:\Users\rdari\Downloads\siph-frontend-master\siph-frontend-master\src\app\app.routes.server.ts
============================================================
import { RenderMode, ServerRoute } from '@angular/ssr';

export const serverRoutes: ServerRoute[] = [
  {
    path: '**',
    renderMode: RenderMode.Prerender
  }
];


============================================================
FILE: C:\Users\rdari\Downloads\siph-frontend-master\siph-frontend-master\src\app\app.routes.ts
============================================================
import { Routes } from '@angular/router';
import { authGuard } from './core/guards/auth.guard';
import { roleGuard } from './core/guards/role.guard';

export const routes: Routes = [
  {
    path: '',
    loadComponent: () =>
      import('./features/home/home.component').then((m) => m.HomeComponent),
  },

  // âœ… DASHBOARD
  {
    path: 'dashboard',
    canActivate: [authGuard],
    loadComponent: () =>
      import('./features/dashboard/dashboard.component').then(
        (m) => m.DashboardComponent
      ),
  },

  // âœ… AUTH
  {
    path: 'auth/login',
    loadComponent: () =>
      import('./features/auth/login/login.component').then(
        (m) => m.LoginComponent
      ),
  },
  {
    path: 'auth/register',
    loadComponent: () =>
      import('./features/auth/register/register.component').then(
        (m) => m.RegisterComponent
      ),
  },

  // âœ… Alias
  { path: 'login', redirectTo: 'auth/login', pathMatch: 'full' },
  { path: 'register', redirectTo: 'auth/register', pathMatch: 'full' },

  // âœ… Workers (listado / perfil pÃºblico)
  {
    path: 'workers',
    loadComponent: () =>
      import('./features/workers/worker-list/worker-list.component').then(
        (m) => m.WorkerListComponent
      ),
  },
  {
    path: 'workers/:id',
    loadComponent: () =>
      import('./features/workers/worker-profile/worker-profile.component').then(
        (m) => m.WorkerProfileComponent
      ),
  },

  // âœ… Requests
  {
    path: 'requests/new',
    canActivate: [authGuard],
    loadComponent: () =>
      import('./features/requests/request-create/request-create.component').then(
        (m) => m.RequestCreateComponent
      ),
  },
  {
    path: 'my-requests',
    canActivate: [authGuard],
    loadComponent: () =>
      import('./features/requests/my-requests/my-requests.component').then(
        (m) => m.MyRequestsComponent
      ),
  },

  // âœ… Reviews
  {
    path: 'reviews',
    canActivate: [authGuard],
    loadComponent: () =>
      import('./features/reviews/review-list/review-list.component').then(
        (m) => m.ReviewListComponent
      ),
  },

  // âœ… ðŸ‘·â€â™‚ï¸ Solicitud para trabajar como TÃ©cnico (SOLO USER)
  {
    path: 'work/apply',
    canActivate: [authGuard, roleGuard],
    data: { roles: ['USER'] },
    loadComponent: () =>
      import(
        './features/worker-applications/apply/worker-apply/worker-apply.component'
      ).then((m) => m.WorkerApplyComponent),
  },

  // âœ… ðŸ›¡ï¸ Admin: revisar solicitudes (SOLO ADMIN)
  {
    path: 'admin/worker-applications',
    canActivate: [authGuard, roleGuard],
    data: { roles: ['ADMIN'] },
    loadComponent: () =>
      import(
        './features/worker-applications/admin-list/worker-applications-admin/worker-applications-admin.component'
      ).then((m) => m.WorkerApplicationsAdminComponent),
  },

  // âœ… Not Found
  {
    path: '**',
    loadComponent: () =>
      import('./shared/components/not-found/not-found.component').then(
        (m) => m.NotFoundComponent
      ),
  },
];


============================================================
FILE: C:\Users\rdari\Downloads\siph-frontend-master\siph-frontend-master\src\environments\environment.ts
============================================================
export const environment = {
  production: false,
  apiUrl: 'http://localhost:8000',
  googleClientId: '1026227617402-hts4hu699cuo0gmh5fg8sh8ncjfdvo76.apps.googleusercontent.com',
};


============================================================
FILE: C:\Users\rdari\Downloads\siph-frontend-master\siph-frontend-master\src\index.html
============================================================
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>SiphFrontend</title>
  <base href="/">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/x-icon" href="favicon.ico">
</head>
<body>
  <app-root></app-root>
</body>
</html>


============================================================
FILE: C:\Users\rdari\Downloads\siph-frontend-master\siph-frontend-master\src\main.server.ts
============================================================
import { bootstrapApplication, type BootstrapContext } from '@angular/platform-browser';
import { AppComponent } from './app/app.component';
import { config } from './app/app.config.server';

export default function bootstrap(context: BootstrapContext) {
  return bootstrapApplication(AppComponent, config, context);
}


============================================================
FILE: C:\Users\rdari\Downloads\siph-frontend-master\siph-frontend-master\src\main.ts
============================================================
import { bootstrapApplication } from '@angular/platform-browser';
import { appConfig } from './app/app.config';
import { AppComponent } from './app/app.component';

bootstrapApplication(AppComponent, appConfig)
  .catch((err) => console.error(err));


============================================================
FILE: C:\Users\rdari\Downloads\siph-frontend-master\siph-frontend-master\src\server.ts
============================================================
import {
  AngularNodeAppEngine,
  createNodeRequestHandler,
  isMainModule,
  writeResponseToNodeResponse,
} from '@angular/ssr/node';
import express from 'express';
import { dirname, resolve } from 'node:path';
import { fileURLToPath } from 'node:url';

const serverDistFolder = dirname(fileURLToPath(import.meta.url));
const browserDistFolder = resolve(serverDistFolder, '../browser');

const app = express();
const angularApp = new AngularNodeAppEngine();

/**
 * Example Express Rest API endpoints can be defined here.
 * Uncomment and define endpoints as necessary.
 *
 * Example:
 * ```ts
 * app.get('/api/**', (req, res) => {
 *   // Handle API request
 * });
 * ```
 */

/**
 * Serve static files from /browser
 */
app.use(
  express.static(browserDistFolder, {
    maxAge: '1y',
    index: false,
    redirect: false,
  }),
);

/**
 * Handle all other requests by rendering the Angular application.
 */
app.use('/**', (req, res, next) => {
  angularApp
    .handle(req)
    .then((response) =>
      response ? writeResponseToNodeResponse(response, res) : next(),
    )
    .catch(next);
});

/**
 * Start the server if this module is the main entry point.
 * The server listens on the port defined by the `PORT` environment variable, or defaults to 4000.
 */
if (isMainModule(import.meta.url)) {
  const port = process.env['PORT'] || 4000;
  app.listen(port, () => {
    console.log(`Node Express server listening on http://localhost:${port}`);
  });
}

/**
 * Request handler used by the Angular CLI (for dev-server and during build) or Firebase Cloud Functions.
 */
export const reqHandler = createNodeRequestHandler(app);


============================================================
FILE: C:\Users\rdari\Downloads\siph-frontend-master\siph-frontend-master\backend\app\core\config.py
============================================================
# backend/app/core/config.py
from pathlib import Path
from typing import Optional

from pydantic import Field
from pydantic_settings import BaseSettings, SettingsConfigDict

# âœ… Asegura que el .env se lea SIEMPRE desde backend/.env
# backend/
#   .env
#   app/
#     core/
#       config.py
BASE_DIR = Path(__file__).resolve().parents[2]  # -> backend/
ENV_FILE = BASE_DIR / ".env"


class Settings(BaseSettings):
    model_config = SettingsConfigDict(
        env_file=str(ENV_FILE),
        env_file_encoding="utf-8",
        extra="ignore",
        case_sensitive=False,
    )

    database_url: str = Field(
        default="postgresql+psycopg2://siph:siph@localhost:5432/siph",
        validation_alias="DATABASE_URL",
    )

    jwt_secret_key: str = Field(default="change-me", validation_alias="JWT_SECRET_KEY")
    jwt_algorithm: str = Field(default="HS256", validation_alias="JWT_ALGORITHM")
    jwt_expiration_minutes: int = Field(
        default=60, validation_alias="JWT_EXPIRATION_MINUTES"
    )

    # âœ… No hardcode: viene del .env / docker env
    google_client_id: Optional[str] = Field(
        default=None, validation_alias="GOOGLE_CLIENT_ID"
    )


settings = Settings()


============================================================
FILE: C:\Users\rdari\Downloads\siph-frontend-master\siph-frontend-master\backend\app\core\database.py
============================================================
# backend/app/core/database.py
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker, declarative_base

from .config import settings

engine = create_engine(settings.database_url, pool_pre_ping=True)
SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)
Base = declarative_base()


def get_db():
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()


============================================================
FILE: C:\Users\rdari\Downloads\siph-frontend-master\siph-frontend-master\backend\app\core\deps.py
============================================================
from fastapi import Depends, HTTPException, status
from fastapi.security import HTTPAuthorizationCredentials, HTTPBearer
from jose import JWTError, jwt
from sqlalchemy.orm import Session

from .config import settings
from .database import get_db
from ..models.user import User


security = HTTPBearer()


def get_current_user(
    credentials: HTTPAuthorizationCredentials = Depends(security),
    db: Session = Depends(get_db),
) -> User:
    token = credentials.credentials
    try:
        payload = jwt.decode(
            token,
            settings.jwt_secret_key,
            algorithms=[settings.jwt_algorithm],
        )
        email: str | None = payload.get("sub")
        if not email:
            raise HTTPException(
                status_code=status.HTTP_401_UNAUTHORIZED,
                detail="Token invÃ¡lido.",
            )
    except JWTError as exc:
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="Token invÃ¡lido.",
        ) from exc

    user = db.query(User).filter(User.email == email).first()
    if not user:
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="Usuario no encontrado.",
        )
    if not user.is_active:
        raise HTTPException(
            status_code=status.HTTP_403_FORBIDDEN,
            detail="Usuario inactivo.",
        )
    return user


# âœ… Helper para proteger endpoints por rol
def require_roles(*roles: str):
    allowed = {r.upper() for r in roles}

    def checker(current_user: User = Depends(get_current_user)) -> User:
        role = (current_user.role or "USER").upper()
        if role not in allowed:
            raise HTTPException(
                status_code=status.HTTP_403_FORBIDDEN,
                detail="No tienes permisos para esta acciÃ³n.",
            )
        return current_user

    return checker


============================================================
FILE: C:\Users\rdari\Downloads\siph-frontend-master\siph-frontend-master\backend\app\core\roles.py
============================================================
from fastapi import Depends, HTTPException, status
from ..models import User
from .deps import get_current_user


def require_role(*roles: str):
    allowed = {r.upper() for r in roles}

    def _check(user: User = Depends(get_current_user)) -> User:
        user_role = (user.role or "USER").upper()
        if user_role not in allowed:
            raise HTTPException(
                status_code=status.HTTP_403_FORBIDDEN,
                detail="No autorizado.",
            )
        return user

    return _check


============================================================
FILE: C:\Users\rdari\Downloads\siph-frontend-master\siph-frontend-master\backend\app\core\security.py
============================================================
# backend/app/core/security.py
from datetime import datetime, timedelta

from jose import jwt
from passlib.context import CryptContext

from .config import settings

pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")


def hash_password(password: str) -> str:
    return pwd_context.hash(password)


def verify_password(password: str, password_hash: str) -> bool:
    return pwd_context.verify(password, password_hash)


def create_access_token(subject: str) -> str:
    expire = datetime.utcnow() + timedelta(minutes=settings.jwt_expiration_minutes)
    to_encode = {"sub": subject, "exp": expire}
    return jwt.encode(to_encode, settings.jwt_secret_key, algorithm=settings.jwt_algorithm)


============================================================
FILE: C:\Users\rdari\Downloads\siph-frontend-master\siph-frontend-master\backend\app\models\service_request.py
============================================================
# backend/app/models/service_request.py
from sqlalchemy import Column, Integer, String, Text, DateTime, ForeignKey, func
from sqlalchemy.orm import relationship

from ..core.database import Base


class ServiceRequest(Base):
    __tablename__ = "service_requests"

    id = Column(Integer, primary_key=True, index=True)
    title = Column(String(120), nullable=False)
    description = Column(Text, nullable=False)
    status = Column(String(30), nullable=False, default="CREATED")
    user_id = Column(Integer, ForeignKey("users.id"), nullable=False)
    created_at = Column(DateTime(timezone=True), server_default=func.now(), nullable=False)

    user = relationship("User")


============================================================
FILE: C:\Users\rdari\Downloads\siph-frontend-master\siph-frontend-master\backend\app\models\technician_verification.py
============================================================
# backend/app/models/technician_verification.py
import enum
from datetime import datetime
from typing import Any, Dict, Optional

from sqlalchemy import (
    Boolean,
    Column,
    DateTime,
    Enum,
    ForeignKey,
    Integer,
    String,
    Text,
    JSON,
    Index,
)
from sqlalchemy.orm import relationship

from ..core.database import Base


# =========================
# ENUMS
# =========================
class Role(str, enum.Enum):
    USER = "USER"
    WORKER = "WORKER"
    VERIFIER = "VERIFIER"
    ADMIN = "ADMIN"


class TechLevel(str, enum.Enum):
    BASIC = "BASIC"
    TRUST = "TRUST"
    PRO = "PRO"
    PAY = "PAY"


class TechStatus(str, enum.Enum):
    PENDING = "PENDING"
    IN_REVIEW = "IN_REVIEW"
    VERIFIED = "VERIFIED"
    REJECTED = "REJECTED"


class DocType(str, enum.Enum):
    ID_PHOTO = "ID_PHOTO"
    POLICE_CERT = "POLICE_CERT"
    PROCURADURIA_CERT = "PROCURADURIA_CERT"
    RNMC_CERT = "RNMC_CERT"
    REFERENCES = "REFERENCES"
    PRO_LICENSE = "PRO_LICENSE"
    STUDY_CERT = "STUDY_CERT"
    HEIGHTS_CERT = "HEIGHTS_CERT"
    GAS_CERT = "GAS_CERT"
    RUT = "RUT"
    BANK_CERT = "BANK_CERT"


# =========================
# MODELS
# =========================
class TechnicianProfile(Base):
    __tablename__ = "technician_profiles"

    id = Column(Integer, primary_key=True, index=True)

    # RelaciÃ³n con users
    user_id = Column(Integer, ForeignKey("users.id"), unique=True, nullable=False)
    user = relationship("User", foreign_keys=[user_id], lazy="joined")

    # PÃºblico
    public_name = Column(String(120), nullable=True)
    public_photo_url = Column(String(500), nullable=True)
    city = Column(String(80), nullable=True)
    radius_km = Column(Integer, default=5, nullable=False)
    categories = Column(JSON, default=list, nullable=False)

    badge_level = Column(Enum(TechLevel), default=TechLevel.BASIC, nullable=False)

    # Privado
    doc_type = Column(String(40), nullable=True)
    doc_number = Column(String(40), nullable=True)
    phone = Column(String(40), nullable=True)
    email = Column(String(120), nullable=True)

    # TÃ©cnico
    specialty = Column(String(120), nullable=True)
    years_experience = Column(Integer, nullable=True)
    bio = Column(Text, nullable=True)
    activities = Column(JSON, default=list, nullable=False)
    wants_payments = Column(Boolean, default=False, nullable=False)

    # Consentimientos
    consent_terms = Column(Boolean, default=False, nullable=False)
    consent_privacy = Column(Boolean, default=False, nullable=False)
    consent_sensitive = Column(Boolean, default=False, nullable=False)
    consent_text_version = Column(String(20), default="v1", nullable=False)

    created_at = Column(DateTime, default=datetime.utcnow, nullable=False)
    updated_at = Column(DateTime, default=datetime.utcnow, nullable=False)

    # Cases
    cases = relationship(
        "VerificationCase",
        back_populates="tech",
        cascade="all, delete-orphan",
        lazy="selectin",
    )

    def touch(self):
        self.updated_at = datetime.utcnow()


class VerificationCase(Base):
    __tablename__ = "verification_cases"

    id = Column(Integer, primary_key=True, index=True)

    tech_id = Column(Integer, ForeignKey("technician_profiles.id"), nullable=False, index=True)
    tech = relationship("TechnicianProfile", back_populates="cases", foreign_keys=[tech_id])

    target_level = Column(Enum(TechLevel), default=TechLevel.BASIC, nullable=False)
    status = Column(Enum(TechStatus), default=TechStatus.PENDING, nullable=False, index=True)

    reason = Column(Text, nullable=True)

    verified_at = Column(DateTime, nullable=True)
    expires_at = Column(DateTime, nullable=True)

    decided_by = Column(Integer, ForeignKey("users.id"), nullable=True)
    decided_by_user = relationship("User", foreign_keys=[decided_by], lazy="joined")

    decision_notes = Column(Text, nullable=True)

    created_at = Column(DateTime, default=datetime.utcnow, nullable=False)
    updated_at = Column(DateTime, default=datetime.utcnow, nullable=False)

    documents = relationship(
        "VerificationDocument",
        back_populates="case",
        cascade="all, delete-orphan",
        lazy="selectin",
    )
    logs = relationship(
        "VerificationAuditLog",
        back_populates="case",
        cascade="all, delete-orphan",
        lazy="selectin",
    )

    def touch(self):
        self.updated_at = datetime.utcnow()


class VerificationDocument(Base):
    __tablename__ = "verification_documents"

    id = Column(Integer, primary_key=True, index=True)

    case_id = Column(Integer, ForeignKey("verification_cases.id"), nullable=False, index=True)
    case = relationship("VerificationCase", back_populates="documents", foreign_keys=[case_id])

    doc_type = Column(Enum(DocType), nullable=False, index=True)
    content_type = Column(String(80), nullable=True)
    original_filename = Column(String(255), nullable=True)

    size_bytes = Column(Integer, nullable=True)
    sha256 = Column(String(64), nullable=True, index=True)

    meta = Column(JSON, default=dict, nullable=False)

    received_at = Column(DateTime, default=datetime.utcnow, nullable=False)

    # MinimizaciÃ³n / RetenciÃ³n
    storage_ref = Column(String(500), nullable=True)      # solo ID_PHOTO (placeholder)
    retained_until = Column(DateTime, nullable=True)      # solo ID_PHOTO (<=30d)
    deleted_at = Column(DateTime, nullable=True)

    verified_result = Column(String(40), nullable=True)
    verified_at = Column(DateTime, nullable=True)

    def mark_deleted(self):
        self.deleted_at = datetime.utcnow()


class VerificationAuditLog(Base):
    __tablename__ = "verification_audit_logs"

    id = Column(Integer, primary_key=True, index=True)

    case_id = Column(Integer, ForeignKey("verification_cases.id"), nullable=False, index=True)
    case = relationship("VerificationCase", back_populates="logs", foreign_keys=[case_id])

    actor_id = Column(Integer, ForeignKey("users.id"), nullable=True)
    actor = relationship("User", foreign_keys=[actor_id], lazy="joined")

    action = Column(String(60), nullable=False, index=True)
    detail = Column(JSON, default=dict, nullable=False)

    ip = Column(String(80), nullable=True)
    user_agent = Column(String(255), nullable=True)

    created_at = Column(DateTime, default=datetime.utcnow, nullable=False)


# Ãndices Ãºtiles
Index("ix_cases_tech_status", VerificationCase.tech_id, VerificationCase.status)
Index("ix_docs_case_doctype", VerificationDocument.case_id, VerificationDocument.doc_type)


============================================================
FILE: C:\Users\rdari\Downloads\siph-frontend-master\siph-frontend-master\backend\app\models\user.py
============================================================
# backend/app/models/user.py
from sqlalchemy import Column, Integer, String, DateTime, func, Boolean

from ..core.database import Base


class User(Base):
    __tablename__ = "users"

    id = Column(Integer, primary_key=True, index=True)
    first_name = Column(String(80), nullable=False)
    last_name = Column(String(80), nullable=False)
    email = Column(String(120), unique=True, index=True, nullable=False)
    password_hash = Column(String(255), nullable=False)
    role = Column(String(30), nullable=False, default="USER")
    is_active = Column(Boolean, nullable=False, default=True)
    created_at = Column(DateTime(timezone=True), server_default=func.now(), nullable=False)


============================================================
FILE: C:\Users\rdari\Downloads\siph-frontend-master\siph-frontend-master\backend\app\models\worker_application.py
============================================================
from __future__ import annotations

from datetime import datetime
from enum import Enum

from sqlalchemy import Column, DateTime, ForeignKey, Integer, String, Text
from sqlalchemy.orm import relationship

from ..core.database import Base


class WorkerApplicationStatus(str, Enum):
    PENDING = "PENDING"
    APPROVED = "APPROVED"
    REJECTED = "REJECTED"


class WorkerApplication(Base):
    __tablename__ = "worker_applications"

    id = Column(Integer, primary_key=True, index=True)

    # âœ… CAMBIO: QUITAR unique=True para permitir mÃºltiples solicitudes por usuario
    user_id = Column(Integer, ForeignKey("users.id"), nullable=False, index=True)

    reviewed_by = Column(Integer, ForeignKey("users.id"), nullable=True)

    phone = Column(String(50), nullable=True)
    city = Column(String(120), nullable=True)
    specialty = Column(String(120), nullable=True)
    bio = Column(Text, nullable=True)
    years_experience = Column(Integer, nullable=True)

    status = Column(String(20), nullable=False, default=WorkerApplicationStatus.PENDING.value)
    admin_notes = Column(Text, nullable=True)

    reviewed_at = Column(DateTime, nullable=True)

    created_at = Column(DateTime, default=datetime.utcnow, nullable=False)
    updated_at = Column(DateTime, default=datetime.utcnow, nullable=False)

    # âœ… CAMBIO: backref en plural
    user = relationship("User", foreign_keys=[user_id], backref="worker_applications")
    reviewer = relationship("User", foreign_keys=[reviewed_by])

    def touch(self):
        self.updated_at = datetime.utcnow()


============================================================
FILE: C:\Users\rdari\Downloads\siph-frontend-master\siph-frontend-master\backend\app\models\__init__.py
============================================================
# backend/app/models/__init__.py
from .user import User
from .service_request import ServiceRequest
from .worker_application import WorkerApplication, WorkerApplicationStatus

from .technician_verification import (
    Role,
    TechLevel,
    TechStatus,
    DocType,
    TechnicianProfile,
    VerificationCase,
    VerificationDocument,
    VerificationAuditLog,
)

__all__ = [
    "User",
    "ServiceRequest",
    "WorkerApplication",
    "WorkerApplicationStatus",

    "Role",
    "TechLevel",
    "TechStatus",
    "DocType",
    "TechnicianProfile",
    "VerificationCase",
    "VerificationDocument",
    "VerificationAuditLog",
]


============================================================
FILE: C:\Users\rdari\Downloads\siph-frontend-master\siph-frontend-master\backend\app\routers\admin_technician_verification.py
============================================================
# backend/app/routers/admin_technician_verification.py
from datetime import datetime, timedelta
from typing import Optional

from fastapi import APIRouter, Depends, HTTPException
from pydantic import BaseModel
from sqlalchemy.orm import Session

from ..core.database import get_db
from ..core.deps import get_current_user, require_roles
from ..models.user import User
from ..models.technician_verification import (
    VerificationCase,
    TechnicianProfile,
    VerificationAuditLog,
    VerificationDocument,
    TechStatus,
    TechLevel,
)

router = APIRouter(prefix="/admin/tech/verification", tags=["Admin Tech Verification"])


def _now():
    return datetime.utcnow()


def _log(db: Session, case_id: int, actor_id: int, action: str, detail: dict):
    db.add(
        VerificationAuditLog(
            case_id=case_id,
            actor_id=actor_id,
            action=action,
            detail=detail,
            created_at=_now(),
        )
    )


class ReviewDocPayload(BaseModel):
    result: str  # "ok" | "fail" | "unknown"
    notes: Optional[str] = None


@router.get("/cases")
def list_cases(
    status: str = "IN_REVIEW",
    limit: int = 50,
    db: Session = Depends(get_db),
    user: User = Depends(get_current_user),
):
    require_roles("ADMIN", "VERIFIER")(user)

    q = db.query(VerificationCase)
    if status:
        try:
            q = q.filter(VerificationCase.status == TechStatus(status))
        except Exception:
            raise HTTPException(status_code=400, detail="status invÃ¡lido (PENDING|IN_REVIEW|VERIFIED|REJECTED).")

    cases = q.order_by(VerificationCase.created_at.desc()).limit(min(limit, 200)).all()

    out = []
    for c in cases:
        tech = db.query(TechnicianProfile).filter(TechnicianProfile.id == c.tech_id).first()
        out.append(
            {
                "caseId": c.id,
                "techId": c.tech_id,
                "publicName": tech.public_name if tech else "â€”",
                "targetLevel": c.target_level.value,
                "status": c.status.value,
                "createdAt": c.created_at.isoformat(),
            }
        )
    return out


@router.get("/cases/{case_id}")
def case_detail(
    case_id: int,
    db: Session = Depends(get_db),
    user: User = Depends(get_current_user),
):
    require_roles("ADMIN", "VERIFIER")(user)

    c = db.query(VerificationCase).filter(VerificationCase.id == case_id).first()
    if not c:
        raise HTTPException(status_code=404, detail="Caso no encontrado.")

    tech = db.query(TechnicianProfile).filter(TechnicianProfile.id == c.tech_id).first()
    docs = (
        db.query(VerificationDocument)
        .filter(VerificationDocument.case_id == c.id)
        .order_by(VerificationDocument.received_at.asc())
        .all()
    )

    return {
        "caseId": c.id,
        "techId": c.tech_id,
        "status": c.status.value,
        "targetLevel": c.target_level.value,
        "createdAt": c.created_at.isoformat(),
        "tech": {
            "publicName": tech.public_name if tech else "â€”",
            "city": tech.city if tech else "â€”",
            "specialty": tech.specialty if tech else "â€”",
        },
        "documents": [
            {
                "id": d.id,
                "docType": d.doc_type.value,
                "receivedAt": d.received_at.isoformat() if d.received_at else None,
                "verifiedResult": d.verified_result,
                "verifiedAt": d.verified_at.isoformat() if d.verified_at else None,
                "meta": d.meta or {},
            }
            for d in docs
        ],
    }


@router.patch("/cases/{case_id}/documents/{doc_id}")
def review_document(
    case_id: int,
    doc_id: int,
    payload: ReviewDocPayload,
    db: Session = Depends(get_db),
    user: User = Depends(get_current_user),
):
    require_roles("ADMIN", "VERIFIER")(user)

    d = (
        db.query(VerificationDocument)
        .filter(VerificationDocument.id == doc_id, VerificationDocument.case_id == case_id)
        .first()
    )
    if not d:
        raise HTTPException(status_code=404, detail="Documento no encontrado para ese caso.")

    res = (payload.result or "").lower().strip()
    if res not in ("ok", "fail", "unknown"):
        raise HTTPException(status_code=400, detail="result invÃ¡lido: ok|fail|unknown")

    d.verified_result = res
    d.verified_at = _now()

    meta = d.meta or {}
    if payload.notes:
        meta["admin_notes"] = payload.notes
    d.meta = meta

    _log(
        db,
        case_id,
        user.id,
        "REVIEW_DOC",
        {"docId": doc_id, "docType": d.doc_type.value, "result": res, "notes": payload.notes},
    )

    db.commit()
    db.refresh(d)

    return {"ok": True, "docId": d.id, "result": d.verified_result, "verifiedAt": d.verified_at.isoformat()}


@router.patch("/cases/{case_id}/decide")
def decide_case(
    case_id: int,
    decision: str,  # "VERIFY"|"REJECT"
    reason: Optional[str] = None,
    decision_notes: Optional[str] = None,
    db: Session = Depends(get_db),
    user: User = Depends(get_current_user),
):
    require_roles("ADMIN", "VERIFIER")(user)

    c = db.query(VerificationCase).filter(VerificationCase.id == case_id).first()
    if not c:
        raise HTTPException(status_code=404, detail="Caso no encontrado.")

    dec = decision.upper().strip()

    if dec == "VERIFY":
        c.status = TechStatus.VERIFIED
        c.reason = None
        c.verified_at = _now()

        tech = db.query(TechnicianProfile).filter(TechnicianProfile.id == c.tech_id).first()
        if tech:
            tech.badge_level = c.target_level

        months = 12
        if c.target_level == TechLevel.TRUST:
            months = 6
        c.expires_at = _now() + timedelta(days=30 * months)

    elif dec == "REJECT":
        c.status = TechStatus.REJECTED
        c.reason = reason or "Falta informaciÃ³n o el documento no coincide."
        c.verified_at = None
        c.expires_at = None
    else:
        raise HTTPException(status_code=400, detail="decision invÃ¡lida (VERIFY/REJECT).")

    c.decided_by = user.id
    c.decision_notes = decision_notes
    c.updated_at = _now()

    _log(db, c.id, user.id, "DECIDE", {"decision": dec, "reason": c.reason, "notes": decision_notes})
    db.commit()

    return {
        "ok": True,
        "caseId": c.id,
        "status": c.status.value,
        "reason": c.reason,
        "expiresAt": c.expires_at.isoformat() if c.expires_at else None,
    }


@router.get("/cases/{case_id}/logs")
def case_logs(
    case_id: int,
    db: Session = Depends(get_db),
    user: User = Depends(get_current_user),
):
    require_roles("ADMIN", "VERIFIER")(user)

    logs = (
        db.query(VerificationAuditLog)
        .filter(VerificationAuditLog.case_id == case_id)
        .order_by(VerificationAuditLog.created_at.asc())
        .all()
    )
    return [
        {"at": l.created_at.isoformat(), "action": l.action, "detail": l.detail, "actorId": l.actor_id}
        for l in logs
    ]


============================================================
FILE: C:\Users\rdari\Downloads\siph-frontend-master\siph-frontend-master\backend\app\routers\admin_worker_applications.py
============================================================
from datetime import datetime
from typing import Optional, List

from fastapi import APIRouter, Depends, HTTPException, status, Query
from sqlalchemy.orm import Session, joinedload

from ..core.database import get_db
from ..core.deps import require_roles
from ..models import User, WorkerApplication, WorkerApplicationStatus
from ..schemas.worker_application import (
    AdminWorkerApplicationOut,
    WorkerApplicationDecision
)

router = APIRouter(prefix="/admin/worker-applications", tags=["admin-worker-applications"])


@router.get("", response_model=List[AdminWorkerApplicationOut])
def list_apps(
    status_filter: Optional[str] = Query(default=None, description="PENDING|APPROVED|REJECTED"),
    db: Session = Depends(get_db),
    admin: User = Depends(require_roles("ADMIN")),
):
    q = db.query(WorkerApplication).options(joinedload(WorkerApplication.user))
    if status_filter:
        st = status_filter.upper().strip()
        if st not in ("PENDING", "APPROVED", "REJECTED"):
            raise HTTPException(status_code=400, detail="status invÃ¡lido")
        q = q.filter(WorkerApplication.status == WorkerApplicationStatus(st))
    return q.order_by(WorkerApplication.created_at.desc()).all()


@router.patch("/{app_id}", response_model=AdminWorkerApplicationOut)
def decide_app(
    app_id: int,
    payload: WorkerApplicationDecision,
    db: Session = Depends(get_db),
    admin: User = Depends(require_roles("ADMIN")),
):
    app = (
        db.query(WorkerApplication)
        .options(joinedload(WorkerApplication.user))
        .filter(WorkerApplication.id == app_id)
        .first()
    )
    if not app:
        raise HTTPException(status_code=404, detail="Solicitud no encontrada.")

    if payload.decision == "APPROVE":
        app.status = WorkerApplicationStatus.APPROVED
        app.admin_notes = payload.admin_notes
        app.reviewed_by = admin.id
        app.reviewed_at = datetime.utcnow()
        app.touch()

        # âœ… PROMOVER A WORKER
        app.user.role = "WORKER"

    else:
        app.status = WorkerApplicationStatus.REJECTED
        app.admin_notes = payload.admin_notes
        app.reviewed_by = admin.id
        app.reviewed_at = datetime.utcnow()
        app.touch()

    db.commit()
    db.refresh(app)
    return app


============================================================
FILE: C:\Users\rdari\Downloads\siph-frontend-master\siph-frontend-master\backend\app\routers\auth.py
============================================================
from datetime import datetime
from typing import Optional

from fastapi import APIRouter, Depends, HTTPException, status
from pydantic import BaseModel
from sqlalchemy.orm import Session

from google.oauth2 import id_token
from google.auth.transport import requests as google_requests

from ..core.config import settings
from ..core.database import get_db
from ..core.deps import get_current_user
from ..core.security import create_access_token, hash_password, verify_password
from ..models import User
from ..schemas.auth import AuthResponse, LoginRequest, RegisterRequest

router = APIRouter(prefix="/auth", tags=["auth"])


class GoogleLoginRequest(BaseModel):
    credential: str


class MeResponse(BaseModel):
    id: int
    first_name: str
    last_name: str
    email: str
    role: str
    is_active: bool
    created_at: Optional[datetime] = None

    class Config:
        from_attributes = True


@router.post("/register", response_model=AuthResponse)
def register(payload: RegisterRequest, db: Session = Depends(get_db)) -> AuthResponse:
    email = payload.email.strip().lower()

    existing = db.query(User).filter(User.email == email).first()
    if existing:
        raise HTTPException(
            status_code=status.HTTP_409_CONFLICT,
            detail="El correo ya estÃ¡ registrado.",
        )

    user = User(
        first_name=payload.first_name.strip(),
        last_name=payload.last_name.strip(),
        email=email,
        password_hash=hash_password(payload.password),
        role="USER",
    )
    db.add(user)
    db.commit()
    db.refresh(user)

    token = create_access_token(user.email)
    return AuthResponse(access_token=token)


@router.post("/login", response_model=AuthResponse)
def login(payload: LoginRequest, db: Session = Depends(get_db)) -> AuthResponse:
    email = payload.email.strip().lower()
    user = db.query(User).filter(User.email == email).first()

    if not user or not verify_password(payload.password, user.password_hash):
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="Credenciales invÃ¡lidas.",
        )

    if not user.is_active:
        raise HTTPException(
            status_code=status.HTTP_403_FORBIDDEN,
            detail="Usuario inactivo.",
        )

    token = create_access_token(user.email)
    return AuthResponse(access_token=token)


@router.post("/google", response_model=AuthResponse)
def login_with_google(payload: GoogleLoginRequest, db: Session = Depends(get_db)) -> AuthResponse:
    google_client_id = (settings.google_client_id or "").strip()
    if not google_client_id:
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail="GOOGLE_CLIENT_ID no estÃ¡ configurado en el backend.",
        )

    try:
        info = id_token.verify_oauth2_token(
            payload.credential,
            google_requests.Request(),
            google_client_id,
        )
    except Exception as exc:
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="Token de Google invÃ¡lido.",
        ) from exc

    email = (info.get("email") or "").lower().strip()
    if not email:
        raise HTTPException(
            status_code=status.HTTP_400_BAD_REQUEST,
            detail="Google no devolviÃ³ email.",
        )

    first_name = (info.get("given_name") or "").strip()
    last_name = (info.get("family_name") or "").strip()
    google_sub = info.get("sub")

    user = db.query(User).filter(User.email == email).first()

    if not user:
        user = User(
            first_name=first_name or "Usuario",
            last_name=last_name or "Google",
            email=email,
            password_hash=hash_password(f"GOOGLE::{google_sub}"),
            role="USER",
        )
        db.add(user)
        db.commit()
        db.refresh(user)

    if not user.is_active:
        raise HTTPException(
            status_code=status.HTTP_403_FORBIDDEN,
            detail="Usuario inactivo.",
        )

    token = create_access_token(user.email)
    return AuthResponse(access_token=token)


@router.get("/me", response_model=MeResponse)
def me(current_user: User = Depends(get_current_user)) -> MeResponse:
    return current_user


============================================================
FILE: C:\Users\rdari\Downloads\siph-frontend-master\siph-frontend-master\backend\app\routers\requests.py
============================================================
# backend/app/routers/requests.py
from fastapi import APIRouter, Depends, status
from sqlalchemy.orm import Session

from ..core.database import get_db
from ..core.deps import get_current_user
from ..models import ServiceRequest
from ..schemas.request import ServiceRequestCreate, ServiceRequestOut


router = APIRouter(prefix="/requests", tags=["requests"])


@router.post("", response_model=ServiceRequestOut, status_code=status.HTTP_201_CREATED)
def create_request(
    payload: ServiceRequestCreate,
    db: Session = Depends(get_db),
    user=Depends(get_current_user),
) -> ServiceRequestOut:
    request = ServiceRequest(
        title=payload.title.strip(),
        description=payload.description.strip(),
        user_id=user.id,
    )
    db.add(request)
    db.commit()
    db.refresh(request)
    return request


============================================================
FILE: C:\Users\rdari\Downloads\siph-frontend-master\siph-frontend-master\backend\app\routers\technician_verification.py
============================================================
# backend/app/routers/technician_verification.py
import json
import hashlib
from datetime import datetime, timedelta
from typing import Optional, Dict, Any

from fastapi import APIRouter, Depends, HTTPException, UploadFile, File, Form
from sqlalchemy.orm import Session

from ..core.database import get_db
from ..core.deps import get_current_user
from ..models.user import User
from ..models.technician_verification import (
    TechnicianProfile,
    VerificationCase,
    VerificationDocument,
    VerificationAuditLog,
    TechLevel,
    TechStatus,
    DocType,
)
from ..schemas.technician_verification import (
    UpsertProfilePayload,
    SubmitPayload,
    VerificationMeResponse,
    OkResponse,
    UploadDocResponse,
)

router = APIRouter(prefix="/tech/verification", tags=["Tech Verification"])

MAX_MB = 5
ALLOWED_CT = {"application/pdf", "image/png", "image/jpeg"}


def _now():
    return datetime.utcnow()


def _sha256_bytes(b: bytes) -> str:
    return hashlib.sha256(b).hexdigest()


def _log(db: Session, case_id: int, actor_id: Optional[int], action: str, detail: Dict[str, Any]):
    db.add(
        VerificationAuditLog(
            case_id=case_id,
            actor_id=actor_id,
            action=action,
            detail=detail,
            created_at=_now(),
        )
    )


def _latest_case_db(db: Session, tech_id: int) -> Optional[VerificationCase]:
    return (
        db.query(VerificationCase)
        .filter(VerificationCase.tech_id == tech_id)
        .order_by(VerificationCase.created_at.desc())
        .first()
    )


def _me_response(profile: TechnicianProfile, case: Optional[VerificationCase]) -> VerificationMeResponse:
    if not case:
        return VerificationMeResponse(
            techId=profile.id,
            currentLevel=profile.badge_level.value,
            status=TechStatus.PENDING.value,
            verifiedAt=None,
            expiresAt=None,
            reason=None,
        )

    return VerificationMeResponse(
        techId=profile.id,
        currentLevel=profile.badge_level.value,
        status=case.status.value,
        verifiedAt=case.verified_at.isoformat() if case.verified_at else None,
        expiresAt=case.expires_at.isoformat() if case.expires_at else None,
        reason=case.reason,
    )


@router.get("/me", response_model=VerificationMeResponse)
def me(
    db: Session = Depends(get_db),
    user: User = Depends(get_current_user),
):
    profile = db.query(TechnicianProfile).filter(TechnicianProfile.user_id == user.id).first()
    if not profile:
        raise HTTPException(status_code=404, detail="AÃºn no has creado tu perfil de tÃ©cnico.")

    case = _latest_case_db(db, profile.id)
    return _me_response(profile, case)


@router.put("/profile", response_model=OkResponse)
def upsert_profile(
    payload: UpsertProfilePayload,
    db: Session = Depends(get_db),
    user: User = Depends(get_current_user),
):
    pub = payload.public or {}
    priv = payload.private or {}
    tech = payload.technician or {}
    cons = payload.consents or {}

    required = [
        ("public.name", pub.get("name")),
        ("public.city", pub.get("city")),
        ("private.doc_type", priv.get("doc_type")),
        ("private.doc_number", priv.get("doc_number")),
        ("private.phone", priv.get("phone")),
        ("private.email", priv.get("email")),
        ("technician.specialty", tech.get("specialty")),
        ("technician.bio", tech.get("bio")),
    ]
    missing = [k for k, v in required if not v]
    if missing:
        raise HTTPException(status_code=400, detail=f"Faltan campos: {', '.join(missing)}")

    if not cons.get("terms") or not cons.get("privacy") or not cons.get("sensitive"):
        raise HTTPException(
            status_code=400,
            detail="Debes aceptar TÃ©rminos, Privacidad y autorizar verificaciÃ³n de documentos.",
        )

    profile = db.query(TechnicianProfile).filter(TechnicianProfile.user_id == user.id).first()
    if not profile:
        profile = TechnicianProfile(user_id=user.id)

    profile.public_name = pub["name"]
    profile.public_photo_url = pub.get("photo_url")
    profile.city = pub["city"]
    profile.radius_km = int(pub.get("radius_km") or 5)
    profile.categories = pub.get("categories") or []

    profile.doc_type = priv["doc_type"]
    profile.doc_number = priv["doc_number"]
    profile.phone = priv["phone"]
    profile.email = priv["email"]

    profile.specialty = tech["specialty"]
    profile.years_experience = int(tech.get("years_experience") or 0)
    profile.bio = tech["bio"]
    profile.activities = tech.get("activities") or []
    profile.wants_payments = bool(tech.get("wants_payments") or False)

    profile.consent_terms = True
    profile.consent_privacy = True
    profile.consent_sensitive = True
    profile.consent_text_version = str(cons.get("version") or "v1")
    profile.updated_at = _now()

    db.add(profile)
    db.commit()
    db.refresh(profile)

    case = _latest_case_db(db, profile.id)
    if case:
        _log(db, case.id, user.id, "UPSERT_PROFILE", {"categories": profile.categories, "activities": profile.activities})
        db.commit()

    return OkResponse(ok=True)


@router.post("/documents", response_model=UploadDocResponse)
def upload_document(
    docType: str = Form(...),
    consent: str = Form(...),
    file: UploadFile = File(...),
    extra: Optional[str] = Form(None),
    db: Session = Depends(get_db),
    user: User = Depends(get_current_user),
):
    if str(consent).lower() != "true":
        raise HTTPException(status_code=400, detail="Debes autorizar el uso del documento solo para verificaciÃ³n.")

    if file.content_type not in ALLOWED_CT:
        raise HTTPException(status_code=400, detail="Formato no vÃ¡lido (solo PDF/PNG/JPG).")

    data = file.file.read()
    if len(data) > MAX_MB * 1024 * 1024:
        raise HTTPException(status_code=400, detail="Archivo >5 MB")

    profile = db.query(TechnicianProfile).filter(TechnicianProfile.user_id == user.id).first()
    if not profile:
        raise HTTPException(status_code=400, detail="Primero completa tu perfil.")

    # âœ… Draft PENDING para guardar docs
    case = _latest_case_db(db, profile.id)
    if not case or case.status != TechStatus.PENDING:
        case = VerificationCase(
            tech_id=profile.id,
            target_level=TechLevel.BASIC,
            status=TechStatus.PENDING,
            created_at=_now(),
            updated_at=_now(),
        )
        db.add(case)
        db.commit()
        db.refresh(case)

    extra_obj = {}
    if extra:
        try:
            extra_obj = json.loads(extra)
        except Exception:
            raise HTTPException(status_code=400, detail="Extra invÃ¡lido (JSON).")

    try:
        dt = DocType(docType)
    except Exception:
        raise HTTPException(status_code=400, detail="docType no vÃ¡lido")

    doc = VerificationDocument(
        case_id=case.id,
        doc_type=dt,
        content_type=file.content_type,
        original_filename=file.filename,
        size_bytes=len(data),
        sha256=_sha256_bytes(data),
        meta=extra_obj or {},
        received_at=_now(),
    )

    # MinimizaciÃ³n
    if dt == DocType.ID_PHOTO:
        doc.storage_ref = f"encrypted://private/case-{case.id}/id-photo-{doc.sha256}.bin"
        doc.retained_until = _now() + timedelta(days=30)
    else:
        doc.storage_ref = None
        doc.retained_until = None

    db.add(doc)
    _log(db, case.id, user.id, "UPLOAD_DOC", {"docType": dt.value, "size": len(data), "minimized": dt != DocType.ID_PHOTO})
    db.commit()
    db.refresh(doc)

    return UploadDocResponse(ok=True, docType=dt.value, receivedAt=doc.received_at.isoformat())


@router.post("/submit", response_model=VerificationMeResponse)
def submit_for_verification(
    payload: SubmitPayload,
    db: Session = Depends(get_db),
    user: User = Depends(get_current_user),
):
    profile = db.query(TechnicianProfile).filter(TechnicianProfile.user_id == user.id).first()
    if not profile:
        raise HTTPException(status_code=400, detail="Primero completa tu perfil.")

    last = _latest_case_db(db, profile.id)

    # âœ… Reutiliza draft PENDING (donde estÃ¡n los docs) -> IN_REVIEW
    if last and last.status == TechStatus.PENDING:
        case = last
        case.target_level = TechLevel(payload.targetLevel)
        case.status = TechStatus.IN_REVIEW
        case.updated_at = _now()
    else:
        case = VerificationCase(
            tech_id=profile.id,
            target_level=TechLevel(payload.targetLevel),
            status=TechStatus.IN_REVIEW,
            created_at=_now(),
            updated_at=_now(),
        )
        db.add(case)
        db.flush()

    _log(db, case.id, user.id, "SUBMIT", {"targetLevel": payload.targetLevel, "extra": payload.extra or {}})

    months = 12
    if payload.targetLevel == "TRUST":
        months = 6

    case.expires_at = _now() + timedelta(days=30 * months)
    case.updated_at = _now()

    db.commit()
    db.refresh(case)

    return _me_response(profile, case)


============================================================
FILE: C:\Users\rdari\Downloads\siph-frontend-master\siph-frontend-master\backend\app\routers\worker_applications.py
============================================================
from __future__ import annotations

from datetime import datetime
from typing import Optional, List

from fastapi import APIRouter, Depends, HTTPException, status
from sqlalchemy.orm import Session

from ..core.database import get_db
from ..core.deps import get_current_user, require_roles
from ..models import WorkerApplication, WorkerApplicationStatus, User
from ..schemas.worker_application import (
    WorkerApplicationCreate,
    WorkerApplicationOut,
    WorkerApplicationAdminOut,
    WorkerApplicationDecision,
)

router = APIRouter(prefix="/worker-applications", tags=["worker-applications"])
admin_router = APIRouter(prefix="/admin/worker-applications", tags=["admin-worker-applications"])


# =========================
# USER: Crear postulaciÃ³n (HISTÃ“RICO)
# =========================
@router.post("", response_model=WorkerApplicationOut, status_code=status.HTTP_201_CREATED)
def apply_as_worker(
    payload: WorkerApplicationCreate,
    db: Session = Depends(get_db),
    current_user: User = Depends(get_current_user),
):
    # Solo usuarios normales pueden postularse (si ya es WORKER, ya fue aprobado)
    if current_user.role != "USER":
        raise HTTPException(
            status_code=status.HTTP_400_BAD_REQUEST,
            detail="Solo usuarios con rol USER pueden postularse.",
        )

    # âœ… CAMBIO CLAVE: SIEMPRE crea una nueva solicitud (histÃ³rico)
    app = WorkerApplication(user_id=current_user.id)

    app.phone = payload.phone
    app.city = payload.city
    app.specialty = payload.specialty
    app.bio = payload.bio
    app.years_experience = payload.years_experience

    app.status = WorkerApplicationStatus.PENDING.value
    app.admin_notes = None
    app.reviewed_by = None
    app.reviewed_at = None
    app.touch()

    db.add(app)
    db.commit()
    db.refresh(app)
    return app


# =========================
# USER: Ver MI Ãºltima postulaciÃ³n
# =========================
@router.get("/me", response_model=WorkerApplicationOut)
def my_application(
    db: Session = Depends(get_db),
    current_user: User = Depends(get_current_user),
):
    app = (
        db.query(WorkerApplication)
        .filter(WorkerApplication.user_id == current_user.id)
        .order_by(WorkerApplication.created_at.desc())  # âœ… ÃšLTIMA
        .first()
    )
    if not app:
        raise HTTPException(status_code=status.HTTP_404_NOT_FOUND, detail="No tienes solicitudes.")
    return app


# =========================
# ADMIN: Listar postulaciones (todas)
# =========================
@admin_router.get("", response_model=List[WorkerApplicationAdminOut])
def admin_list_applications(
    status_filter: Optional[str] = None,
    db: Session = Depends(get_db),
    _: User = Depends(require_roles("ADMIN")),
):
    q = db.query(WorkerApplication).order_by(WorkerApplication.created_at.desc())

    if status_filter:
        try:
            sf = WorkerApplicationStatus(status_filter)
        except Exception:
            raise HTTPException(
                status_code=status.HTTP_400_BAD_REQUEST,
                detail="status_filter invÃ¡lido. Usa PENDING, APPROVED o REJECTED.",
            )
        q = q.filter(WorkerApplication.status == sf.value)

    return q.all()


# =========================
# ADMIN: Decidir (APPROVE/REJECT)
# =========================
@admin_router.patch("/{app_id}", response_model=WorkerApplicationAdminOut)
def admin_decide_application(
    app_id: int,
    decision: WorkerApplicationDecision,
    db: Session = Depends(get_db),
    current_admin: User = Depends(require_roles("ADMIN")),
):
    app = db.query(WorkerApplication).filter(WorkerApplication.id == app_id).first()
    if not app:
        raise HTTPException(status_code=status.HTTP_404_NOT_FOUND, detail="Solicitud no encontrada.")

    # Validar status
    try:
        new_status = WorkerApplicationStatus(decision.status)
    except Exception:
        raise HTTPException(
            status_code=status.HTTP_400_BAD_REQUEST,
            detail="Estado invÃ¡lido. Usa APPROVED o REJECTED.",
        )

    app.status = new_status.value
    app.admin_notes = decision.admin_notes
    app.reviewed_by = current_admin.id
    app.reviewed_at = datetime.utcnow()
    app.touch()

    # Si aprueba: subir rol del usuario a WORKER
    if new_status == WorkerApplicationStatus.APPROVED:
        user = db.query(User).filter(User.id == app.user_id).first()
        if user and user.role != "ADMIN":
            user.role = "WORKER"

    db.commit()
    db.refresh(app)
    return app


============================================================
FILE: C:\Users\rdari\Downloads\siph-frontend-master\siph-frontend-master\backend\app\routers\__init__.py
============================================================
# backend/app/routers/__init__.py
from . import auth, requests, worker_applications, technician_verification, admin_technician_verification

__all__ = [
    "auth",
    "requests",
    "worker_applications",
    "technician_verification",
    "admin_technician_verification",
]


============================================================
FILE: C:\Users\rdari\Downloads\siph-frontend-master\siph-frontend-master\backend\app\schemas\auth.py
============================================================
# backend/app/schemas/auth.py
from pydantic import BaseModel, EmailStr, Field


class RegisterRequest(BaseModel):
    first_name: str = Field(..., min_length=2)
    last_name: str = Field(..., min_length=2)
    email: EmailStr
    password: str = Field(..., min_length=6)


class LoginRequest(BaseModel):
    email: EmailStr
    password: str


class AuthResponse(BaseModel):
    access_token: str
    token_type: str = "bearer"


============================================================
FILE: C:\Users\rdari\Downloads\siph-frontend-master\siph-frontend-master\backend\app\schemas\request.py
============================================================
# backend/app/schemas/request.py
from pydantic import BaseModel, Field


class ServiceRequestCreate(BaseModel):
    title: str = Field(..., min_length=3)
    description: str = Field(..., min_length=10)


class ServiceRequestOut(BaseModel):
    id: int
    title: str
    status: str

    class Config:
        from_attributes = True


============================================================
FILE: C:\Users\rdari\Downloads\siph-frontend-master\siph-frontend-master\backend\app\schemas\technician_verification.py
============================================================
# backend/app/schemas/technician_verification.py
from pydantic import BaseModel, Field
from typing import Any, Dict, List, Literal, Optional

TechLevel = Literal["BASIC", "TRUST", "PRO", "PAY"]
TechStatus = Literal["PENDING", "IN_REVIEW", "VERIFIED", "REJECTED"]
DocType = Literal[
    "ID_PHOTO","POLICE_CERT","PROCURADURIA_CERT","RNMC_CERT","REFERENCES",
    "PRO_LICENSE","STUDY_CERT","HEIGHTS_CERT","GAS_CERT","RUT","BANK_CERT"
]

class UpsertProfilePayload(BaseModel):
    public: Dict[str, Any] = Field(default_factory=dict)
    private: Dict[str, Any] = Field(default_factory=dict)
    technician: Dict[str, Any] = Field(default_factory=dict)
    consents: Dict[str, Any] = Field(default_factory=dict)

class SubmitPayload(BaseModel):
    targetLevel: TechLevel
    extra: Optional[Dict[str, Any]] = None

class VerificationMeResponse(BaseModel):
    techId: int
    currentLevel: TechLevel
    status: TechStatus
    verifiedAt: Optional[str] = None
    expiresAt: Optional[str] = None
    reason: Optional[str] = None

class UploadDocResponse(BaseModel):
    ok: bool = True
    docType: DocType
    receivedAt: str

class OkResponse(BaseModel):
    ok: bool = True


============================================================
FILE: C:\Users\rdari\Downloads\siph-frontend-master\siph-frontend-master\backend\app\schemas\user.py
============================================================
from pydantic import BaseModel, EmailStr


class UserOut(BaseModel):
    id: int
    first_name: str
    last_name: str
    email: EmailStr
    role: str
    is_active: bool

    class Config:
        from_attributes = True


============================================================
FILE: C:\Users\rdari\Downloads\siph-frontend-master\siph-frontend-master\backend\app\schemas\worker_application.py
============================================================
from __future__ import annotations

from datetime import datetime
from typing import Optional
from pydantic import BaseModel, ConfigDict, Field


# =========================
# INPUT (USER)
# =========================
class WorkerApplicationCreate(BaseModel):
    phone: Optional[str] = None
    city: Optional[str] = None
    specialty: Optional[str] = None
    bio: Optional[str] = None
    years_experience: Optional[int] = None


# =========================
# OUTPUT (USER)
# =========================
class WorkerApplicationOut(BaseModel):
    model_config = ConfigDict(from_attributes=True)

    id: int
    user_id: int

    phone: Optional[str] = None
    city: Optional[str] = None
    specialty: Optional[str] = None
    bio: Optional[str] = None
    years_experience: Optional[int] = None

    status: str
    admin_notes: Optional[str] = None

    reviewed_by: Optional[int] = None
    reviewed_at: Optional[datetime] = None

    created_at: datetime
    updated_at: datetime


# =========================
# OUTPUT (ADMIN) - puede ser igual al Out,
# pero lo dejamos separado para crecer despuÃ©s
# =========================
class WorkerApplicationAdminOut(WorkerApplicationOut):
    pass


# =========================
# INPUT (ADMIN DECIDE)
# =========================
class WorkerApplicationDecision(BaseModel):
    status: str = Field(..., description="APPROVED o REJECTED")
    admin_notes: Optional[str] = None


============================================================
FILE: C:\Users\rdari\Downloads\siph-frontend-master\siph-frontend-master\backend\app\scripts\create_admin.py
============================================================
# backend/app/scripts/create_admin.py
import os

from sqlalchemy.orm import Session

from app.core.database import SessionLocal
from app.core.security import hash_password
from app.models.user import User


def main():
    email = (os.getenv("ADMIN_EMAIL") or "").strip().lower()
    password = os.getenv("ADMIN_PASSWORD") or ""
    first_name = (os.getenv("ADMIN_FIRST_NAME") or "Admin").strip()
    last_name = (os.getenv("ADMIN_LAST_NAME") or "SIPH").strip()

    if not email:
        raise SystemExit("âŒ Falta ADMIN_EMAIL en el .env")
    if not password or len(password) < 6:
        raise SystemExit("âŒ Falta ADMIN_PASSWORD (mÃ­nimo 6) en el .env")

    db: Session = SessionLocal()
    try:
        user = db.query(User).filter(User.email == email).first()

        if user:
            # Promueve/actualiza
            user.first_name = first_name
            user.last_name = last_name
            user.role = "ADMIN"
            user.is_active = True
            user.password_hash = hash_password(password)
            action = "actualizado/promovido"
        else:
            # Crea
            user = User(
                first_name=first_name,
                last_name=last_name,
                email=email,
                password_hash=hash_password(password),
                role="ADMIN",
                is_active=True,
            )
            db.add(user)
            action = "creado"

        db.commit()
        print(f"âœ… Admin {action}: {email} (role=ADMIN)")
    except Exception as e:
        db.rollback()
        raise
    finally:
        db.close()


if __name__ == "__main__":
    main()


============================================================
FILE: C:\Users\rdari\Downloads\siph-frontend-master\siph-frontend-master\backend\app\scripts\__init__.py
============================================================

============================================================
FILE: C:\Users\rdari\Downloads\siph-frontend-master\siph-frontend-master\backend\app\main.py
============================================================
# backend/app/main.py
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware

from .core.database import Base, engine

# âœ… Importa mÃ³dulos de modelos SOLO para registrar tablas (side effects)
from .models import user  # noqa: F401
from .models import service_request  # noqa: F401
from .models import worker_application  # noqa: F401
from .models import technician_verification  # noqa: F401

from .routers import auth, requests, worker_applications, technician_verification as tech_ver_router
from .routers import admin_technician_verification


app = FastAPI(title="SIPH API")

app.add_middleware(
    CORSMiddleware,
    allow_origins=[
        "http://localhost:4200",
        "http://127.0.0.1:4200",
    ],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# âœ… Crea tablas
Base.metadata.create_all(bind=engine)

# Routers
app.include_router(auth.router)
app.include_router(requests.router)

# worker_applications suele tener router y admin_router
app.include_router(worker_applications.router)
app.include_router(worker_applications.admin_router)

# verification
app.include_router(tech_ver_router.router)
app.include_router(admin_technician_verification.router)


@app.get("/health")
def health():
    return {"status": "ok"}


============================================================
FILE: C:\Users\rdari\Downloads\siph-frontend-master\siph-frontend-master\backend\docker-compose.yml
============================================================
version: "3.9"

services:
  db:
    image: postgres:15
    container_name: siph_db
    restart: always
    environment:
      POSTGRES_DB: siph
      POSTGRES_USER: siph
      POSTGRES_PASSWORD: siph
    ports:
      - "5432:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data

  api:
    build: .
    container_name: siph_api
    restart: always

    # âœ… CARGA variables del archivo backend/.env dentro del contenedor
    env_file:
      - .env

    environment:
      DATABASE_URL: postgresql+psycopg2://siph:siph@db:5432/siph
      JWT_SECRET_KEY: change-me
      JWT_ALGORITHM: HS256
      JWT_EXPIRATION_MINUTES: 60
      GOOGLE_CLIENT_ID: 1026227617402-hts4hu699cuo0gmh5fg8sh8ncjfdvo76.apps.googleusercontent.com

    ports:
      - "8000:8000"

    depends_on:
      - db

    # âœ… Mantengo tu bind mount para desarrollo
    volumes:
      - .:/app
    working_dir: /app

volumes:
  pgdata:


============================================================
FILE: C:\Users\rdari\Downloads\siph-frontend-master\siph-frontend-master\backend\project_dump_code_only.txt
============================================================
===============================
PROJECT DUMP (TREE + CONTENT)
Date: 02/11/2026 10:38:45
===============================

===== TREE: src =====
Listado de rutas de carpetas para el volumen Windows
El n·mero de serie del volumen es CAC4-6E28
C:\USERS\RDARI\DOWNLOADS\SIPH-FRONTEND-MASTER\SIPH-FRONTEND-MASTER\BACKEND\SRC
Ruta de acceso no vßlida: \USERS\RDARI\DOWNLOADS\SIPH-FRONTEND-MASTER\SIPH-FRONTEND-MASTER\BACKEND\SRC
No existe ninguna subcarpeta 


===== TREE: backend =====
Listado de rutas de carpetas para el volumen Windows
El n·mero de serie del volumen es CAC4-6E28
C:\USERS\RDARI\DOWNLOADS\SIPH-FRONTEND-MASTER\SIPH-FRONTEND-MASTER\BACKEND\BACKEND
Ruta de acceso no vßlida: \USERS\RDARI\DOWNLOADS\SIPH-FRONTEND-MASTER\SIPH-FRONTEND-MASTER\BACKEND\BACKEND
No existe ninguna subcarpeta 


===============================
FILE CONTENTS (code only)
===============================



============================================================
FILE: C:\Users\rdari\Downloads\siph-frontend-master\siph-frontend-master\backend\requirements.txt
============================================================
fastapi==0.115.0
uvicorn==0.30.6
SQLAlchemy==2.0.35
email-validator>=2.0.0
psycopg2-binary==2.9.9
python-jose==3.3.0
passlib[bcrypt]==1.7.4
bcrypt==3.2.2
pydantic==2.9.2
pydantic-settings==2.5.2
google-auth[requests]==2.35.0
python-multipart==0.0.9


